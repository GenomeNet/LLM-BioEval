{% extends "base.html" %}

{% block title %}Prediction Details - MicrobeBench{% endblock %}

{% block content %}
<div class="details-header">
    <div>
        <h1>Prediction Details</h1>
        <h5 class="text-muted">
            <span class="badge model-badge">{{ model_name }}</span>
            <i class="fas fa-angle-right"></i>
            <span class="badge phenotype-badge">{{ phenotype }}</span>
            <i class="fas fa-angle-right"></i>
            <span class="badge dataset-badge">{{ dataset_name }}</span>
        </h5>
    </div>
    <a href="{{ url_for('model_accuracy') }}" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Back to Accuracy</a>
</div>

<!-- Summary Row -->
<div class="analysis-stats">
    <div class="stat-card positive">
        <div class="stat-number">{{ summary.correct }}</div>
        <div class="stat-label"><i class="fas fa-check-circle"></i> Correct</div>
    </div>
    <div class="stat-card negative">
        <div class="stat-number">{{ summary.incorrect }}</div>
        <div class="stat-label"><i class="fas fa-times-circle"></i> Incorrect</div>
    </div>
    <div class="stat-card warning">
        <div class="stat-number">{{ summary.missing_prediction }}</div>
        <div class="stat-label"><i class="fas fa-question-circle"></i> Missing Prediction</div>
    </div>
    <div class="stat-card neutral">
        <div class="stat-number">{{ summary.missing_ground_truth }}</div>
        <div class="stat-label"><i class="fas fa-ban"></i> Missing Ground Truth</div>
    </div>
</div>

<!-- Details Section -->
<div class="details-container">
    <!-- Incorrect Predictions -->
    <div class="card details-section">
        <div class="card-header incorrect-header">
            <h5><i class="fas fa-times-circle"></i> Incorrect Predictions ({{ summary.incorrect }})</h5>
        </div>
        <div class="card-body">
            {{ render_table(data.incorrect, ['Species', 'Predicted Value', 'Ground Truth'], 'incorrect') }}
        </div>
    </div>

    <!-- Correct Predictions -->
    <div class="card details-section">
        <div class="card-header correct-header">
            <h5><i class="fas fa-check-circle"></i> Correct Predictions ({{ summary.correct }})</h5>
        </div>
        <div class="card-body">
            {{ render_table(data.correct, ['Species', 'Agreed Value'], 'correct') }}
        </div>
    </div>
    
    <!-- Missing Data -->
    <div class="card details-section">
        <div class="card-header missing-header">
            <h5><i class="fas fa-question-circle"></i> Missing Data</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6>Missing Predictions ({{ summary.missing_prediction }})</h6>
                    <p class="text-muted small">Species present in ground truth but not in model's predictions.</p>
                    {{ render_table(data.missing_prediction, ['Species', 'Ground Truth Value'], 'missing') }}
                </div>
                <div class="col-md-6">
                    <h6>Missing in Ground Truth ({{ summary.missing_ground_truth }})</h6>
                    <p class="text-muted small">Species predicted by model but not found in ground truth dataset.</p>
                    {{ render_table(data.missing_ground_truth, ['Species', 'Predicted Value'], 'missing') }}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .details-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
    .details-header h1 { margin-bottom: 0.5rem; }
    .details-header .badge { font-size: 1rem; padding: 0.5em 0.8em; }
    .model-badge { background-color: #007bff; color: white; }
    .phenotype-badge { background-color: #6c757d; color: white; }
    .dataset-badge { background-color: #17a2b8; color: white; }

    /* Re-using styles from model_accuracy.html for consistency */
    .analysis-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .stat-card.positive { border-color: #28a745; background-color: #f8fff9; }
    .stat-card.negative { border-color: #dc3545; background-color: #fff8f8; }
    .stat-card.warning { border-color: #ffc107; background-color: #fffcf2; }
    .stat-card.neutral { border-color: #6c757d; background-color: #f8f9fa; }

    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 5px;
    }

    .stat-label {
        font-size: 1rem;
        color: #6c757d;
        font-weight: 500;
    }
    .stat-label i {
        margin-right: 5px;
    }

    .details-section { margin-bottom: 2rem; }
    .details-section .card-header { font-weight: 600; }
    .correct-header { background-color: rgba(40, 167, 69, 0.1); border-bottom: 2px solid #28a745; }
    .incorrect-header { background-color: rgba(220, 53, 69, 0.1); border-bottom: 2px solid #dc3545; }
    .missing-header { background-color: rgba(255, 193, 7, 0.1); border-bottom: 2px solid #ffc107; }

    .table { font-size: 0.9em; }
    .value-predicted { background-color: #f8d7da; color: #721c24; padding: 0.2em 0.5em; border-radius: 4px; font-weight: 600; }
    .value-actual { background-color: #d4edda; color: #155724; padding: 0.2em 0.5em; border-radius: 4px; font-weight: 600; }
    .value-agreed { background-color: #e2e3e5; color: #343a40; padding: 0.2em 0.5em; border-radius: 4px; }
    .table-responsive { max-height: 400px; overflow-y: auto; }
</style>
{% endblock %}

{% macro render_table(data, headers, type) %}
<div class="table-responsive">
    <table class="table table-striped table-bordered table-sm">
        <thead class="thead-light" style="position: sticky; top: 0;">
            <tr>
                {% for header in headers %}
                <th>{{ header }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% if data %}
                {% for row in data %}
                <tr>
                    <td><i>{{ row[0] }}</i></td>
                    {% if type == 'incorrect' %}
                        <td><span class="value-predicted">{{ row[1] }}</span></td>
                        <td><span class="value-actual">{{ row[2] }}</span></td>
                    {% elif type == 'correct' %}
                        <td><span class="value-agreed">{{ row[1] }}</span></td>
                    {% else %}
                        <td>{{ row[1] }}</td>
                    {% endif %}
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="{{ headers|length }}" class="text-center text-muted py-4">No data available.</td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>
{% endmacro %} 