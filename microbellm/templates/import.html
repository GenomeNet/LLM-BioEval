{% extends "admin_base.html" %}

{% block title %}Import Results - MicrobeLLM Admin{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Import Results</h1>
    <p class="page-subtitle">Import results from a CSV file</p>
</div>

<!-- Step 1: Template Selection -->
<div class="card" id="templateSelection">
    <h3>Step 1: Select Template Type</h3>
    <p class="text-muted mb-3">Choose the template that was used to generate your results</p>
    
    <div class="template-selection">
        <div class="template-grid">
            <!-- Templates will be populated here -->
        </div>
    </div>
</div>

<!-- Step 2: Format Guide -->
<div class="card" id="formatGuide" style="display: none;">
    <h3>Step 2: Review Expected Format</h3>
    
    <div class="format-info">
        <h4 class="text-small">Required Columns</h4>
        <div id="requiredColumns" class="column-list"></div>
        
        <h4 class="text-small mt-3">Optional Columns</h4>
        <div id="optionalColumns" class="column-list"></div>
        
        <div class="example-section mt-3">
            <h4 class="text-small">Example CSV Format</h4>
            <pre id="exampleCsv" class="example-csv"></pre>
        </div>
    </div>
    
    <div class="mt-3">
        <button onclick="continueToUpload()" class="btn btn-primary">
            <i class="fas fa-arrow-right"></i> Continue to Upload
        </button>
        <button onclick="backToTemplateSelection()" class="btn btn-ghost">
            <i class="fas fa-arrow-left"></i> Back
        </button>
    </div>
</div>

<!-- Step 3: File Upload -->
<div class="card" id="fileUpload" style="display: none;">
    <h3>Step 3: Upload CSV File</h3>
    
    <div class="import-controls">
        <div class="selected-template-info">
            <strong>Selected Template:</strong> <span id="selectedTemplateName"></span>
        </div>
        
        <div class="file-upload-area mt-3">
            <input type="file" id="csvFile" accept=".csv" style="display: none;">
            <div class="upload-zone" onclick="document.getElementById('csvFile').click()">
                <i class="fas fa-cloud-upload-alt"></i>
                <p>Click to select CSV file</p>
                <small class="text-muted">or drag and drop</small>
            </div>
            
            <div id="fileInfo" class="file-info mt-2" style="display: none;">
                <span id="fileName"></span>
                <button onclick="clearFile()" class="btn btn-ghost btn-sm">Clear</button>
            </div>
        </div>
        
        <div class="import-actions mt-3">
            <button onclick="validateAndImport()" id="importBtn" class="btn btn-primary" disabled>
                <i class="fas fa-check"></i> Validate & Import
            </button>
            <button onclick="backToFormatGuide()" class="btn btn-ghost">
                <i class="fas fa-arrow-left"></i> Back
            </button>
            
            <div id="importStatus" class="mt-3"></div>
        </div>
    </div>
</div>

<style>
    .import-controls {
        max-width: 600px;
    }
    
    .template-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 16px;
    }
    
    .template-card {
        border: 2px solid var(--border-color);
        border-radius: 8px;
        padding: 16px;
        cursor: pointer;
        transition: all 0.2s;
        background: var(--bg-secondary);
    }
    
    .template-card:hover {
        border-color: var(--admin-primary);
        transform: translateY(-1px);
    }
    
    .template-card.selected {
        border-color: var(--admin-primary);
        background: var(--admin-primary);
        color: white;
    }
    
    .template-card h4 {
        margin: 0 0 4px 0;
        font-size: 16px;
    }
    
    .template-card .template-type {
        font-size: 12px;
        text-transform: uppercase;
        opacity: 0.7;
    }
    
    .selected-template-info {
        padding: 12px;
        background: var(--bg-secondary);
        border-radius: 6px;
        font-size: 14px;
    }
    
    .column-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 8px;
    }
    
    .column-item {
        padding: 4px 12px;
        background: var(--bg-tertiary);
        border-radius: 4px;
        font-size: 13px;
        font-family: var(--font-mono);
        border: 1px solid var(--border-color);
    }
    
    .column-item.required {
        border-color: var(--admin-primary);
        background: rgba(99, 102, 241, 0.1);
    }
    
    .example-csv {
        background: var(--bg-secondary);
        padding: 16px;
        border-radius: 6px;
        font-size: 12px;
        overflow-x: auto;
        font-family: var(--font-mono);
        line-height: 1.5;
    }
    
    .format-info h4 {
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .upload-zone {
        border: 2px dashed var(--border-color);
        border-radius: 8px;
        padding: 40px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        background: var(--bg-secondary);
    }
    
    .upload-zone:hover {
        border-color: var(--admin-primary);
        background: var(--bg-primary);
    }
    
    .upload-zone.dragover {
        border-color: var(--status-success);
        background: rgba(16, 185, 129, 0.05);
    }
    
    .upload-zone i {
        font-size: 48px;
        color: var(--gray-400);
        margin-bottom: 16px;
    }
    
    .upload-zone p {
        margin: 0;
        font-weight: 500;
        color: var(--gray-700);
    }
    
    .upload-zone small {
        font-size: 12px;
    }
    
    .file-info {
        padding: 8px 12px;
        background: var(--bg-secondary);
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 14px;
    }
    
    .validation-results {
        margin-top: 16px;
        padding: 16px;
        background: var(--bg-secondary);
        border-radius: 8px;
        border: 1px solid var(--border-color);
    }
    
    .validation-results h5 {
        margin: 0 0 12px 0;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .validation-stat {
        display: flex;
        justify-content: space-between;
        padding: 4px 0;
        font-size: 13px;
    }
    
    .validation-stat.error {
        color: var(--status-error);
    }
    
    .validation-stat.warning {
        color: var(--status-warning);
    }
    
    .validation-stat.success {
        color: var(--status-success);
    }
    
    .mt-2 {
        margin-top: 8px;
    }
    
    .mt-3 {
        margin-top: 16px;
    }
    
    .mb-3 {
        margin-bottom: 16px;
    }
    
    #importStatus {
        font-size: 14px;
        line-height: 1.5;
    }
    
    #importStatus.success {
        color: var(--status-success);
    }
    
    #importStatus.error {
        color: var(--status-error);
    }
    
    .import-summary {
        margin-top: 16px;
        padding: 12px;
        background: var(--bg-secondary);
        border-radius: 6px;
        font-size: 13px;
    }
    
    .import-summary h5 {
        margin: 0 0 8px 0;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
</style>

<script>
    // Global state
    let selectedTemplate = null;
    let templateConfigs = {};
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadAvailableTemplates();
    });
    
    // Load available templates
    function loadAvailableTemplates() {
        // Hardcode templates for now since API might not be available
        const templates = [
            { name: 'template1_knowlege.txt', type: 'knowledge' },
            { name: 'template2_knowlege.txt', type: 'knowledge' },
            { name: 'template3_knowlege.txt', type: 'knowledge' },
            { name: 'template1_phenotype.txt', type: 'phenotype' },
            { name: 'template2_phenotype.txt', type: 'phenotype' }
        ];
        
        displayTemplates(templates);
        
        // Try to load from API if available
        fetch('/api/templates')
            .then(res => res.json())
            .then(data => {
                if (data.success && data.templates.length > 0) {
                    // Store validation configs
                    templateConfigs = data.validation_configs || {};
                    displayTemplates(data.templates);
                }
            })
            .catch(err => {
                // Silently fail, use hardcoded templates
                console.log('Using hardcoded template list');
            });
    }
    
    // Display template selection cards
    function displayTemplates(templates) {
        const grid = document.querySelector('.template-grid');
        grid.innerHTML = '';
        
        // Group templates by base name
        const templateGroups = {};
        templates.forEach(template => {
            const baseName = template.name.replace(/\.(txt|md)$/, '');
            if (!templateGroups[baseName]) {
                templateGroups[baseName] = template;
            }
        });
        
        // Create template cards
        Object.values(templateGroups).forEach(template => {
            const templateType = detectTemplateType(template.name);
            const card = document.createElement('div');
            card.className = 'template-card';
            card.innerHTML = `
                <h4>${formatTemplateName(template.name)}</h4>
                <div class="template-type">${templateType.toUpperCase()}</div>
            `;
            card.onclick = () => selectTemplate(template.name, templateType);
            grid.appendChild(card);
        });
    }
    
    // Detect template type from name
    function detectTemplateType(templateName) {
        if (templateName.includes('knowledge') || templateName.includes('knowlege')) {
            return 'knowledge';
        } else if (templateName.includes('phenotype')) {
            return 'phenotype';
        }
        return 'unknown';
    }
    
    // Format template name for display
    function formatTemplateName(name) {
        return name.replace(/\.(txt|md)$/, '')
                   .replace(/_/g, ' ')
                   .replace(/knowlege/g, 'knowledge')
                   .split(' ')
                   .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                   .join(' ');
    }
    
    // Select a template
    function selectTemplate(templateName, templateType) {
        selectedTemplate = {
            name: templateName,
            type: templateType
        };
        
        // Update UI
        document.querySelectorAll('.template-card').forEach(card => {
            card.classList.remove('selected');
        });
        event.currentTarget.classList.add('selected');
        
        // Show format guide
        showFormatGuide();
    }
    
    // Show format guide for selected template
    function showFormatGuide() {
        document.getElementById('templateSelection').style.display = 'none';
        document.getElementById('formatGuide').style.display = 'block';
        
        const requiredCols = document.getElementById('requiredColumns');
        const optionalCols = document.getElementById('optionalColumns');
        const exampleCsv = document.getElementById('exampleCsv');
        
        // Always required columns
        const required = ['binomial_name', 'model', 'status'];
        requiredCols.innerHTML = required.map(col => 
            `<span class="column-item required">${col}</span>`
        ).join('');
        
        // Template-specific columns
        let optional = ['species_file', 'system_template', 'user_template', 'result'];
        let exampleData = {};
        
        if (selectedTemplate.type === 'knowledge') {
            optional.push('knowledge_group');
            exampleData = {
                binomial_name: 'Escherichia coli',
                model: 'openai/gpt-4',
                status: 'completed',
                knowledge_group: 'extensive',
                result: '{"knowledge_group": "extensive"}'
            };
        } else if (selectedTemplate.type === 'phenotype') {
            optional.push(
                'knowledge_group', 'gram_staining', 'motility', 'aerophilicity',
                'extreme_environment_tolerance', 'biofilm_formation', 'animal_pathogenicity',
                'biosafety_level', 'health_association', 'host_association',
                'plant_pathogenicity', 'spore_formation', 'hemolysis', 'cell_shape'
            );
            exampleData = {
                binomial_name: 'Bacillus subtilis',
                model: 'openai/gpt-4',
                status: 'completed',
                gram_staining: 'gram stain positive',
                motility: 'motile',
                spore_formation: 'spore-forming'
            };
        }
        
        optionalCols.innerHTML = optional.map(col => 
            `<span class="column-item">${col}</span>`
        ).join('');
        
        // Create example CSV
        const headers = [...required, ...optional.slice(0, 5)].join(',');
        const values = [...required, ...optional.slice(0, 5)].map(col => 
            exampleData[col] || 'value'
        ).join(',');
        
        exampleCsv.textContent = `${headers}\n${values}\n...`;
    }
    
    // Navigation functions
    function backToTemplateSelection() {
        document.getElementById('formatGuide').style.display = 'none';
        document.getElementById('templateSelection').style.display = 'block';
    }
    
    function continueToUpload() {
        document.getElementById('formatGuide').style.display = 'none';
        document.getElementById('fileUpload').style.display = 'block';
        document.getElementById('selectedTemplateName').textContent = formatTemplateName(selectedTemplate.name);
        
        // Set up file upload handlers
        setupFileUpload();
    }
    
    function backToFormatGuide() {
        document.getElementById('fileUpload').style.display = 'none';
        document.getElementById('formatGuide').style.display = 'block';
    }
    
    // File upload handling
    function setupFileUpload() {
        const fileInput = document.getElementById('csvFile');
        const uploadZone = document.querySelector('.upload-zone');
        
        if (!fileInput._hasListeners) {
            fileInput.addEventListener('change', handleFileSelect);
            fileInput._hasListeners = true;
            
            // Drag and drop
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });
            
            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragover');
            });
            
            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    handleFileSelect();
                }
            });
        }
    }
    
    function handleFileSelect() {
        const file = document.getElementById('csvFile').files[0];
        if (file) {
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileInfo').style.display = 'flex';
            document.getElementById('importBtn').disabled = false;
            document.getElementById('importStatus').innerHTML = '';
        }
    }
    
    function clearFile() {
        document.getElementById('csvFile').value = '';
        document.getElementById('fileInfo').style.display = 'none';
        document.getElementById('importBtn').disabled = true;
        document.getElementById('importStatus').innerHTML = '';
    }
    
    // Validate and import CSV
    function validateAndImport() {
        const file = document.getElementById('csvFile').files[0];
        if (!file) return;
        
        const formData = new FormData();
        formData.append('file', file);
        formData.append('template', selectedTemplate.name);
        formData.append('template_type', selectedTemplate.type);
        
        const statusDiv = document.getElementById('importStatus');
        const importBtn = document.getElementById('importBtn');
        
        statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Validating and importing...';
        statusDiv.className = '';
        importBtn.disabled = true;
        
        fetch('/api/import_csv_validated', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                statusDiv.className = 'success';
                statusDiv.innerHTML = `
                    <div class="validation-results">
                        <h5>Import Results</h5>
                        <div class="validation-stat">
                            <span>Total rows:</span>
                            <span>${data.total_rows}</span>
                        </div>
                        <div class="validation-stat success">
                            <span>Successfully imported:</span>
                            <span>${data.imported}</span>
                        </div>
                        <div class="validation-stat warning">
                            <span>Skipped (duplicates):</span>
                            <span>${data.skipped}</span>
                        </div>
                        <div class="validation-stat error">
                            <span>Failed validation:</span>
                            <span>${data.errors}</span>
                        </div>
                        ${data.validation_errors && data.validation_errors.length > 0 ? `
                            <div class="mt-3">
                                <strong>Validation errors:</strong>
                                <ul class="text-small mt-2">
                                    ${data.validation_errors.slice(0, 5).map(err => 
                                        `<li>${err}</li>`
                                    ).join('')}
                                    ${data.validation_errors.length > 5 ? 
                                        `<li>... and ${data.validation_errors.length - 5} more</li>` : ''}
                                </ul>
                            </div>
                        ` : ''}
                        ${data.new_models_added && data.new_models_added.length > 0 ? `
                            <div class="mt-3">
                                <strong>New models added to dashboard:</strong>
                                <ul class="text-small mt-2">
                                    ${data.new_models_added.map(model => 
                                        `<li>${model}</li>`
                                    ).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                if (data.imported > 0) {
                    setTimeout(() => {
                        if (confirm('Import completed! Return to dashboard?')) {
                            window.location.href = '/';
                        }
                    }, 2000);
                }
            } else {
                statusDiv.className = 'error';
                statusDiv.innerHTML = `
                    <i class="fas fa-exclamation-circle"></i> 
                    Error: ${data.error || 'Import failed'}
                `;
            }
        })
        .catch(error => {
            console.error('Import error:', error);
            statusDiv.className = 'error';
            statusDiv.innerHTML = `
                <i class="fas fa-exclamation-circle"></i> 
                Error: Import failed. Please check your file format.
            `;
        })
        .finally(() => {
            importBtn.disabled = false;
        });
    }
</script>
{% endblock %}