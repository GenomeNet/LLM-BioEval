{% extends "base.html" %}

{% block title %}MicrobeLLM Dashboard{% endblock %}

{% block content %}
<h1>MicrobeLLM Processing Dashboard</h1>

<!-- API Key Status Indicator - Top Right Corner -->
<div id="apiKeyCornerStatus" class="api-key-corner-status">
    <div class="api-corner-status-dot" id="apiStatusDot"></div>
    <span class="api-corner-status-text" id="apiStatusText">Checking...</span>
</div>

<!-- Settings Panel -->
<div class="settings-panel">
    <div class="settings-header">
        <h4>Settings</h4>
        <button onclick="toggleSettings()" class="settings-toggle">‚öôÔ∏è</button>
    </div>
    <div id="settingsContent" class="settings-content" style="display: none;">
        <div class="setting-item api-key-setting">
            <label for="apiKeyInput">OpenRouter API Key:</label>
            <div class="api-key-input-row">
                <input type="password" id="apiKeyInput" class="api-key-input" placeholder="Enter your OpenRouter API key">
                <button onclick="updateApiKey()" class="btn btn-primary btn-small">Update</button>
                <button onclick="toggleApiKeyVisibility()" class="btn btn-secondary btn-small" id="toggleApiKeyBtn">üëÅÔ∏è</button>
            </div>
            <div class="api-key-help">
                Get your API key from <a href="https://openrouter.ai/keys" target="_blank">OpenRouter</a>. 
                This is stored as an environment variable and requires a server restart to take effect.
            </div>
        </div>
        <div class="setting-item">
            <label for="rateLimitInput">Requests per second:</label>
            <input type="number" id="rateLimitInput" min="0.1" max="100" step="0.1" value="1">
            <button onclick="updateRateLimit()" class="btn btn-sm btn-primary">Update</button>
        </div>
        <div class="setting-item">
            <label for="concurrentInput">Concurrent requests:</label>
            <input type="number" id="concurrentInput" min="1" max="20" step="1" value="4">
            <button onclick="updateConcurrency()" class="btn btn-sm btn-primary">Update</button>
            <small class="form-help">Number of species to process in parallel</small>
        </div>
        <p class="settings-note">‚ö†Ô∏è Higher values may result in rate limiting from the API provider.</p>
        <div class="queue-status">
            <strong>Queue Length:</strong> <span id="queueLength">0</span> jobs waiting
        </div>
    </div>
</div>

<div class="dashboard-controls">
    <a href="/export" class="btn btn-success">
        <i class="fas fa-download"></i> Export Results
    </a>
    <a href="/import" class="btn btn-primary">
        <i class="fas fa-upload"></i> Import Results
    </a>
    <button onclick="refreshDashboard()" class="btn btn-secondary">
        <i class="fas fa-sync-alt"></i> Refresh
    </button>
</div>

{% if dashboard_data.matrix %}
    <!-- Template Navigation -->
    <div class="template-tabs">
        {% set templates = dashboard_data.template_display_info %}
        {% for template_info in templates %}
            {% set i = loop.index0 %}
                    <button class="template-tab template-type-{{ template_info.template_type }} {% if i == 0 %}active{% endif %}"
                onclick="showTemplate({{ i }})"
                    id="tab-{{ i }}"
                    title="{{ template_info.description }} ({{ template_info.template_type }} template)">
                {% if template_info.template_type == 'knowledge' %}
                    <i class="fas fa-brain"></i>
                {% else %}
                    <i class="fas fa-dna"></i>
                {% endif %}
                {{ template_info.display_name }}
            </button>
        {% endfor %}
        <button class="template-tab template-manage-tab" 
                onclick="openTemplateManager()" 
                id="template-manage-btn"
                title="Manage template names and descriptions">
            <i class="fas fa-edit"></i>
        </button>
    </div>

    <!-- Template Sections -->
    {% for template_info in dashboard_data.template_display_info %}
        {% set sys_template = template_info.system_template %}
        {% set user_template = template_info.user_template %}
        {% set i = loop.index0 %}
        {% set file_template_name = sys_template.split('/')[-1].replace('.txt', '') %}
        <div class="template-section {% if i == 0 %}active{% endif %}" id="template-{{ i }}">
            <div class="template-header">
                <h3>
                    {% if template_info.template_type == 'knowledge' %}
                        <i class="fas fa-brain"></i>
                    {% else %}
                        <i class="fas fa-dna"></i>
                    {% endif %}
                    {{ template_info.display_name }}
                    <span class="template-type-badge template-type-{{ template_info.template_type }}">
                        {{ template_info.template_type|capitalize }} Template
                    </span>
                </h3>
                <div class="template-description">
                    <p>{{ template_info.description }}</p>
                </div>
                <div class="template-info">
                    <small>
                        System: <a href="/view_template/system/{{ file_template_name }}" target="_blank" class="template-link" title="View system template">{{ sys_template.split('/')[-1] }}</a> | 
                        User: <a href="/view_template/user/{{ file_template_name }}" target="_blank" class="template-link" title="View user template">{{ user_template.split('/')[-1] }}</a>
                    </small>
                </div>
            </div>

            <div class="matrix-container">
                <table class="processing-matrix">
                    <thead>
                        <tr>
                            <th class="species-header">Species Files</th>
                            {% for model in dashboard_data.models %}
                            <th class="model-header">
                                <div class="model-name">{{ model.split('/')[-1] }}</div>
                                <button class="delete-model-btn" onclick="deleteModel('{{ model }}')" title="Remove model">√ó</button>
                            </th>
                            {% endfor %}
                            <th class="add-column">
                                <button class="add-btn" onclick="addModel()" title="Add new model">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for species_file in dashboard_data.species_files %}
                            <tr>
                                <td class="species-name">
                                    <div>{{ species_file.split('/')[-1] }}</div>
                                    <button class="delete-species-btn" onclick="deleteSpeciesFile('{{ species_file }}')" title="Remove species file">√ó</button>
                                </td>
                                {% for model in dashboard_data.models %}
                                    {% set cell_key = species_file + '|' + sys_template + '|' + user_template %}
                                    {% set cell_data = dashboard_data.matrix.get(cell_key, {}).get('models', {}).get(model) %}
                                    <td class="matrix-cell" id="cell-{{ i }}-{{ species_file }}-{{ model }}">
                                        {% if cell_data %}
                                            <div class="status-cell status-{{ cell_data.status }}" onclick="showCombinationDetails({{ cell_data.id }})" style="cursor: pointer;" title="Click to see detailed results">
                                                <div class="progress-info">
                                                    <div class="main-progress">
                                                        {% if cell_data.status == 'completed' and cell_data.successful > 0 %}
                                                            <span class="completion-main">{{ cell_data.successful }}/{{ cell_data.total }} Done</span>
                                                        {% elif cell_data.status == 'failed' and cell_data.successful == 0 %}
                                                            <span class="completion-main">{{ cell_data.failed }}/{{ cell_data.total }} Failed</span>
                                                        {% elif cell_data.status == 'running' %}
                                                            <span class="completion-main">{{ cell_data.submitted }}/{{ cell_data.total }} Processing</span>
                                                        {% elif cell_data.status == 'interrupted' %}
                                                            <span class="completion-main">{{ cell_data.successful }}/{{ cell_data.total }} Paused</span>
                                                        {% else %}
                                                            <span class="completion-main">{{ cell_data.total }} Ready</span>
                                                        {% endif %}
                                                    </div>
                                                    
                                                    {% if cell_data.submitted > 0 or cell_data.status == 'running' %}
                                                        <div class="detailed-progress">
                                                            <div class="progress-line">
                                                                <span class="progress-label">Sent:</span>
                                                                <span class="progress-value">{{ cell_data.submitted }}</span>
                                                            </div>
                                                            {% if cell_data.received > 0 %}
                                                                <div class="progress-line">
                                                                    <span class="progress-label">Received:</span>
                                                                    <span class="progress-value">{{ cell_data.received }}</span>
                                                                </div>
                                                            {% endif %}
                                                            {% if cell_data.successful > 0 %}
                                                                <div class="progress-line success">
                                                                    <span class="progress-label">Success:</span>
                                                                    <span class="progress-value">{{ cell_data.successful }}</span>
                                                                </div>
                                                            {% endif %}
                                                            {% if cell_data.failed > 0 %}
                                                                <div class="progress-line failed">
                                                                    <span class="progress-label">Failed:</span>
                                                                    <span class="progress-value">{{ cell_data.failed }}</span>
                                                                </div>
                                                            {% endif %}
                                                        </div>
                                                    {% elif cell_data.imported %}
                                                        <div class="detailed-progress">
                                                            <div class="progress-line imported">
                                                                <span class="progress-label">Source:</span>
                                                                <span class="progress-value">Imported</span>
                                                            </div>
                                                            {% if cell_data.successful > 0 %}
                                                                <div class="progress-line success">
                                                                    <span class="progress-label">Success:</span>
                                                                    <span class="progress-value">{{ cell_data.successful }}</span>
                                                                </div>
                                                            {% endif %}
                                                            {% if cell_data.failed > 0 %}
                                                                <div class="progress-line failed">
                                                                    <span class="progress-label">Failed:</span>
                                                                    <span class="progress-value">{{ cell_data.failed }}</span>
                                                                </div>
                                                            {% endif %}
                                                        </div>
                                                    {% endif %}
                                                    
                                                    {% if cell_data.total > 0 and (cell_data.successful > 0 or cell_data.status == 'running') %}
                                                        <div class="progress-bar">
                                                            <div class="progress-fill" style="width: {{ ((cell_data.successful / cell_data.total * 100)|round) }}%"></div>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                                
                                                {% if cell_data.status == 'pending' %}
                                                    <button onclick="startCombination({{ cell_data.id }})" class="action-btn start-btn">
                                                        <i class="fas fa-play"></i> Start
                                                    </button>
                                                {% elif cell_data.status == 'running' %}
                                                    <div class="status-badge running">
                                                        <i class="fas fa-spinner rotating"></i> Running
                                                    </div>
                                                    <div class="job-controls">
                                                        <button onclick="pauseCombination({{ cell_data.id }})" class="action-btn pause-btn" title="Pause job">
                                                            <i class="fas fa-pause"></i>
                                                        </button>
                                                        <button onclick="stopCombination({{ cell_data.id }})" class="action-btn stop-btn" title="Stop job">
                                                            <i class="fas fa-stop"></i>
                                                        </button>
                                                    </div>
                                                {% elif cell_data.status == 'completed' and cell_data.successful > 0 %}
                                                    <div class="status-badge completed">
                                                        <i class="fas fa-check"></i> Completed
                                                    </div>
                                                    {% if cell_data.imported %}
                                                        <div class="import-badge" title="This data was imported from CSV">
                                                            <i class="fas fa-file-import"></i> Imported
                                                        </div>
                                                    {% endif %}
                                                {% elif cell_data.status == 'failed' or (cell_data.status == 'completed' and cell_data.successful == 0) %}
                                                    <div class="status-badge failed">
                                                        <i class="fas fa-exclamation-triangle"></i> Failed
                                                    </div>
                                                    <button onclick="restartCombination({{ cell_data.id }})" class="action-btn restart-btn">
                                                        <i class="fas fa-redo"></i> Retry
                                                    </button>
                                                {% elif cell_data.status == 'interrupted' %}
                                                    <div class="status-badge interrupted">
                                                        <i class="fas fa-pause"></i> Paused
                                                    </div>
                                                    <button onclick="startCombination({{ cell_data.id }})" class="action-btn start-btn">
                                                        <i class="fas fa-play"></i> Resume
                                                    </button>
                                                {% endif %}
                                                <button onclick="deleteCombination({{ cell_data.id }})" class="delete-combination-btn" title="Delete this combination">√ó</button>
                                            </div>
                                        {% else %}
                                            <div class="status-cell status-empty">
                                                <button onclick="createAndStartCombination('{{ species_file }}', '{{ model }}', '{{ sys_template }}', '{{ user_template }}')" 
                                                        class="action-btn create-btn">
                                                    <i class="fas fa-plus"></i> Create
                                                </button>
                                            </div>
                                        {% endif %}
                                    </td>
                                {% endfor %}
                                <td class="add-cell"></td>
                            </tr>
                        {% endfor %}
                        <tr class="add-row">
                            <td>
                                <button class="add-btn" onclick="addSpeciesFile()" title="Add new species file">
                                    <i class="fas fa-plus"></i> Add Species File
                                </button>
                            </td>
                            {% for model in dashboard_data.models %}
                                <td></td>
                            {% endfor %}
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    {% endfor %}

{% else %}
    <div class="empty-state">
        <div class="empty-icon">
            <i class="fas fa-flask"></i>
        </div>
        <h3>No Processing Combinations Yet</h3>
        <p>Start by adding a species file and selecting models to process</p>
        <button onclick="addSpeciesFile()" class="btn btn-primary btn-large">
            <i class="fas fa-plus"></i> Add First Species File
        </button>
    </div>
{% endif %}

<!-- Detailed Results Modal -->
<div id="detailsModal" class="modal">
    <div class="modal-content details-modal">
        <div class="modal-header">
            <h3 id="detailsTitle">Combination Details</h3>
            <button onclick="closeModal('detailsModal')" class="modal-close">&times;</button>
        </div>
        
        <div id="detailsContent" class="details-content">
            <!-- Content will be populated by JavaScript -->
        </div>
    </div>
</div>

<!-- Modals -->
<div id="addModelModal" class="modal">
    <div class="modal-content">
        <h3>Add Model</h3>
        
        <!-- Input Method Tabs -->
        <div class="input-method-tabs">
            <button class="input-tab active" onclick="switchInputMethod('dropdown')" id="dropdownTab">
                üìã Browse Models
            </button>
            <button class="input-tab" onclick="switchInputMethod('manual')" id="manualTab">
                ‚úèÔ∏è Manual Entry
            </button>
        </div>
        
        <!-- Dropdown Method -->
        <div id="dropdownMethod" class="input-method active">
            <div class="form-group">
                <label for="modelDropdown">Select Model:</label>
                <div class="dropdown-container">
                    <select id="modelDropdown" class="form-control">
                        <option value="">Loading models...</option>
                    </select>
                    <button onclick="refreshModels()" class="refresh-btn" title="Refresh model list">
                        <i class="fas fa-sync"></i>
                    </button>
                </div>
                <small class="form-help">
                    <span id="modelCount">0</span> models available from OpenRouter
                </small>
                <div id="selectedModelInfo" class="model-info" style="display: none;"></div>
            </div>
        </div>
        
        <!-- Manual Input Method -->
        <div id="manualMethod" class="input-method">
            <div class="form-group">
                <label for="newModelInput">Model Name:</label>
                <input type="text" id="newModelInput" class="form-control" 
                       placeholder="e.g., anthropic/claude-3-haiku, openai/gpt-4o, google/gemini-pro">
                <small class="form-help">
                    Enter the full model name as listed on <a href="https://openrouter.ai/models" target="_blank">OpenRouter</a>
                </small>
                <div id="modelValidationStatus" class="validation-status" style="display: none;"></div>
            </div>
        </div>
        
        <div class="modal-buttons">
            <button onclick="closeModal('addModelModal')" class="btn btn-secondary">Cancel</button>
            <button id="addModelBtn" onclick="confirmAddModel()" class="btn btn-primary" disabled>Add Model</button>
        </div>
    </div>
</div>

<div id="addSpeciesModal" class="modal">
    <div class="modal-content">
        <h3>Add Species File</h3>
        <div class="form-group">
            <label>Species File:</label>
            <select id="newSpeciesSelect" class="form-control">
                <option value="">Select a species file...</option>
                {% for file in dashboard_data.available_species_files %}
                    <option value="{{ file }}">{{ file }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="modal-buttons">
            <button onclick="closeModal('addSpeciesModal')" class="btn btn-secondary">Cancel</button>
            <button onclick="confirmAddSpecies()" class="btn btn-primary">Add Species File</button>
        </div>
    </div>
</div>



{% endblock %}

{% block scripts %}
<script>
    // Initialize Socket.IO connection
    const socket = io();
    
    // Helper function to escape HTML for safe display
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }
    
    socket.on('connect', function() {
        console.log('Connected to server');
    });
    
    socket.on('job_update', function(data) {
        console.log('Job update received:', data);
        setTimeout(refreshDashboard, 1000);
    });

    // Check API key status on page load
    checkApiKeyStatus();

    // Load settings on page load
    loadSettings();

    // Initialize active tab from saved state
    setTimeout(initializeActiveTab, 100); // Small delay to ensure DOM is ready

    function loadSettings() {
        fetch('/api/get_settings')
            .then(response => response.json())
            .then(data => {
                document.getElementById('rateLimitInput').value = data.rate_limit;
                document.getElementById('concurrentInput').value = data.max_concurrent_requests;
                document.getElementById('queueLength').textContent = data.queue_length;
            })
            .catch(error => console.error('Error loading settings:', error));
    }

    function toggleSettings() {
        const content = document.getElementById('settingsContent');
        const isVisible = content.style.display !== 'none';
        content.style.display = isVisible ? 'none' : 'block';
        
        if (!isVisible) {
            loadSettings(); // Refresh settings when opening
        }
    }

    function updateRateLimit() {
        const rateLimit = parseFloat(document.getElementById('rateLimitInput').value);
        
        // Find the update button
        const btn = document.querySelector('#settingsContent button[onclick="updateRateLimit()"]');
        
        fetch('/api/set_rate_limit', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({requests_per_second: rateLimit})
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                console.log('Rate limit updated:', data.message);
                // Show brief success indicator
                if (btn) {
                    const originalText = btn.textContent;
                    btn.textContent = '‚úì';
                    btn.style.backgroundColor = '#28a745';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.backgroundColor = '';
                    }, 1000);
                }
            } else {
                alert('Error updating rate limit: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error updating rate limit:', error);
            alert('Error updating rate limit: ' + error.message);
        });
    }

    function updateConcurrency() {
        const concurrency = parseInt(document.getElementById('concurrentInput').value);
        
        // Find the update button
        const btn = document.querySelector('#settingsContent button[onclick="updateConcurrency()"]');
        
        fetch('/api/set_rate_limit', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({max_concurrent_requests: concurrency})
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                console.log('Concurrency updated:', data.message);
                // Show brief success indicator
                if (btn) {
                    const originalText = btn.textContent;
                    btn.textContent = '‚úì';
                    btn.style.backgroundColor = '#28a745';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.backgroundColor = '';
                    }, 1000);
                }
            } else {
                alert('Error updating concurrency: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error updating concurrency:', error);
            alert('Error updating concurrency: ' + error.message);
        });
    }

    function pauseCombination(combinationId) {
        fetch('/api/pause_combination/' + combinationId, {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    console.log('Combination paused successfully');
                    setTimeout(refreshDashboard, 1000);
                } else {
                    alert('Failed to pause combination: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error pausing combination:', error);
                alert('Error pausing combination: ' + error.message);
            });
    }

    function stopCombination(combinationId) {
        if (confirm('Are you sure you want to stop this job? You can resume it later.')) {
            fetch('/api/stop_combination/' + combinationId, {method: 'POST'})
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        console.log('Combination stopped successfully');
                        setTimeout(refreshDashboard, 1000);
                    } else {
                        alert('Failed to stop combination: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error stopping combination:', error);
                    alert('Error stopping combination: ' + error.message);
                });
        }
    }

    function checkApiKeyStatus() {
        fetch('/api/api_key_status')
            .then(response => response.json())
            .then(data => {
                updateApiKeyStatus(data);
            })
            .catch(error => {
                console.error('Error checking API key status:', error);
                updateApiKeyStatus({
                    status: 'error',
                    message: 'Unable to check API key status',
                    configured: false
                });
            });
    }

    function updateApiKeyStatus(data) {
        const statusDiv = document.getElementById('apiKeyCornerStatus');
        const dot = document.getElementById('apiStatusDot');
        const text = document.getElementById('apiStatusText');
        
        // Remove existing status classes
        statusDiv.className = 'api-key-corner-status';
        
        if (data.configured) {
            statusDiv.classList.add('status-success');
            dot.className = 'api-corner-status-dot success';
            text.textContent = 'API key configured';
        } else {
            statusDiv.classList.add('status-error');
            dot.className = 'api-corner-status-dot error';
            text.textContent = 'API key not configured';
        }
    }

    function toggleApiKeyVisibility() {
        const input = document.getElementById('apiKeyInput');
        const btn = document.getElementById('toggleApiKeyBtn');
        
        if (input.type === 'password') {
            input.type = 'text';
            btn.textContent = 'üôà';
        } else {
            input.type = 'password';
            btn.textContent = 'üëÅÔ∏è';
        }
    }

    function updateApiKey() {
        const apiKey = document.getElementById('apiKeyInput').value.trim();
        
        if (!apiKey) {
            alert('Please enter an API key');
            return;
        }
        
        // Find the update button
        const btn = document.querySelector('#settingsContent button[onclick="updateApiKey()"]');
        if (!btn) return;
        
        // Show loading state
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Updating...';
        
        fetch('/api/set_api_key', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({api_key: apiKey})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Clear the input for security
                document.getElementById('apiKeyInput').value = '';
                
                // Show success feedback
                btn.textContent = '‚úì Updated';
                btn.style.backgroundColor = '#28a745';
                
                // Update the status indicator
                setTimeout(() => {
                    checkApiKeyStatus();
                }, 500);
                
                // Reset button after delay
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.backgroundColor = '';
                    btn.disabled = false;
                }, 2000);
                
                // Show info about restart requirement
                if (data.restart_required) {
                    setTimeout(() => {
                        alert('API key updated! Please restart the server for changes to take effect.');
                    }, 100);
                }
            } else {
                alert('Error updating API key: ' + (data.error || 'Unknown error'));
                btn.textContent = originalText;
                btn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error updating API key:', error);
            alert('Error updating API key: ' + error.message);
            btn.textContent = originalText;
            btn.disabled = false;
        });
    }

    // Show detailed results for a combination
    function showCombinationDetails(combinationId) {
        console.log('Showing details for combination:', combinationId);
        
        // Prevent event bubbling when clicking delete button
        if (event.target.classList.contains('delete-combination-btn')) {
            event.stopPropagation();
            return;
        }
        
        fetch('/api/combination_details/' + combinationId)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error loading details: ' + data.error);
                    return;
                }
                
                displayCombinationDetails(data);
                document.getElementById('detailsModal').style.display = 'block';
            })
            .catch(error => {
                console.error('Error fetching combination details:', error);
                alert('Error loading combination details: ' + error.message);
            });
    }

    function displayCombinationDetails(data) {
        const info = data.combination_info;
        const results = data.species_results;
        const unprocessed = data.unprocessed_species;
        const stats = data.prediction_stats;
        
        document.getElementById('detailsTitle').textContent = 
            `${info.model.split('/').pop()} - ${info.species_file} (${info.status})`;
        
        let html = `
            <div class="combination-summary">
                <h4>Summary</h4>
                <div class="summary-stats">
                    <div class="stat-item">
                        <span class="stat-label">Total Species:</span>
                        <span class="stat-value">${info.total_species}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Submitted:</span>
                        <span class="stat-value">${info.submitted_species}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Received:</span>
                        <span class="stat-value">${info.received_species}</span>
                    </div>
                    <div class="stat-item success">
                        <span class="stat-label">Successful:</span>
                        <span class="stat-value">${info.successful_species}</span>
                    </div>
                    <div class="stat-item failed">
                        <span class="stat-label">Failed:</span>
                        <span class="stat-value">${info.failed_species}</span>
                    </div>
                </div>
                ${info.failed_species > 0 ? `
                    <div class="rerun-all-container">
                        <button onclick="rerunAllFailed(${info.id})" class="btn btn-warning">
                            <i class="fas fa-redo"></i> Re-run All Failed (${info.failed_species})
                        </button>
                    </div>
                ` : ''}
                <div class="template-info">
                    <strong>Templates:</strong> ${info.system_template} + ${info.user_template}
                </div>
            </div>
        `;
        
        html += `
            <div class="species-results">
                <h4>Species Results</h4>
        `;
        
        if (results.length === 0) {
            html += `<p class="no-results">No species have been processed yet.</p>`;
        } else {
            // Group results by status
            const successful = results.filter(r => r.status === 'completed');
            const failed = results.filter(r => r.status === 'failed');
            
            if (failed.length > 0) {
                html += `
                    <div class="results-section failed-section">
                        <h5 class="section-title failed">Failed Species (${failed.length})</h5>
                        <div class="species-list">
                `;
                
                failed.forEach(result => {
                    html += `
                        <div class="species-item failed">
                            <div class="species-header" onclick="toggleSpeciesDetails(this)">
                                <span class="species-name">${result.binomial_name}</span>
                                <span class="species-status failed">Failed</span>
                                <span class="toggle-icon">‚ñº</span>
                            </div>
                            <div class="species-details" style="display: none;">
                                <div class="error-info">
                                    <strong>Error:</strong>
                                    <div class="error-message">${result.error || 'No specific error message'}</div>
                                </div>
                                ${result.result ? `
                                    <div class="raw-response">
                                        <strong>Raw Response:</strong>
                                        <div class="response-text">${result.result.substring(0, 500)}${result.result.length > 500 ? '...' : ''}</div>
                                    </div>
                                ` : ''}
                                <div class="timestamp">
                                    <strong>Processed:</strong> ${new Date(result.timestamp).toLocaleString()}
                                </div>
                                <div class="rerun-container">
                                    <button onclick="rerunFailedSpecies(${info.id}, '${result.binomial_name}')" class="btn btn-sm btn-warning">
                                        <i class="fas fa-redo"></i> Re-run This Species
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            if (successful.length > 0) {
                html += `
                    <div class="results-section success-section">
                        <h5 class="section-title success">Successful Species (${successful.length})</h5>
                        <div class="species-list">
                `;
                
                successful.forEach(result => {
                    let mainContent = '';
                    let debugContent = '';
                    
                    if (result.is_knowledge_template) {
                        // For knowledge templates, show knowledge level
                        const knowledgeLevel = result.knowledge_group || 'Not determined';
                        const levelClass = knowledgeLevel.toLowerCase() === 'limited' ? 'knowledge-limited' :
                                         knowledgeLevel.toLowerCase() === 'moderate' ? 'knowledge-moderate' :
                                         knowledgeLevel.toLowerCase() === 'extensive' ? 'knowledge-extensive' :
                                         knowledgeLevel.toLowerCase() === 'na' ? 'knowledge-na' : '';
                        
                        mainContent = `
                            <div class="knowledge-level">
                                <strong>Knowledge Level:</strong>
                                <span class="knowledge-value ${levelClass}">${knowledgeLevel}</span>
                            </div>
                        `;
                        
                        debugContent = `
                            <div class="debug-item">
                                <strong>Knowledge Group:</strong> ${result.knowledge_group || '<em>null/empty</em>'}
                            </div>
                        `;
                    } else {
                        // For phenotype templates, show phenotypes
                        const phenotypes = Object.entries(result.phenotypes || {})
                            .filter(([key, value]) => value)
                            .map(([key, value]) => `${key.replace(/_/g, ' ')}: ${value}`)
                            .join(', ');
                        
                        mainContent = `
                            <div class="phenotypes">
                                <strong>Phenotypes:</strong>
                                <div class="phenotype-list">${phenotypes || 'No phenotypes extracted'}</div>
                            </div>
                        `;
                        
                        debugContent = `
                            <div class="debug-item">
                                <strong>All Phenotype Values:</strong>
                                <ul class="phenotype-debug-list">
                                    ${Object.entries(result.phenotypes || {})
                                        .map(([key, value]) => `<li><strong>${key}:</strong> ${value || '<em>null/empty</em>'}</li>`)
                                        .join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    html += `
                        <div class="species-item success">
                            <div class="species-header" onclick="toggleSpeciesDetails(this)">
                                <span class="species-name">${result.binomial_name}</span>
                                <span class="species-status success">Success</span>
                                <span class="toggle-icon">‚ñº</span>
                            </div>
                            <div class="species-details" style="display: none;">
                                ${mainContent}
                                ${result.result ? `
                                    <div class="raw-response">
                                        <strong>Raw LLM Response:</strong>
                                        <details class="llm-response-details">
                                            <summary>Click to expand raw output</summary>
                                            <pre class="response-text">${escapeHtml(result.result)}</pre>
                                        </details>
                                    </div>
                                ` : ''}
                                <div class="debug-info">
                                    <details class="debug-details">
                                        <summary><strong>Debug Information</strong></summary>
                                        <div class="debug-content">
                                            <div class="debug-item">
                                                <strong>Status:</strong> ${result.status}
                                            </div>
                                            <div class="debug-item">
                                                <strong>Species Name:</strong> ${result.binomial_name}
                                            </div>
                                            <div class="debug-item">
                                                <strong>Timestamp:</strong> ${new Date(result.timestamp).toLocaleString()}
                                            </div>
                                            ${debugContent}
                                        </div>
                                    </details>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
        }
        
        if (unprocessed.length > 0) {
            html += `
                <div class="results-section unprocessed-section">
                    <h5 class="section-title unprocessed">Unprocessed Species (${unprocessed.length})</h5>
                    <div class="unprocessed-list">
                        ${unprocessed.map(species => `<span class="unprocessed-species">${species}</span>`).join(', ')}
                    </div>
                </div>
            `;
        }
        
        html += `</div>`;
        
        document.getElementById('detailsContent').innerHTML = html;
    }

    function toggleSpeciesDetails(header) {
        const details = header.nextElementSibling;
        const icon = header.querySelector('.toggle-icon');
        
        if (details.style.display === 'none') {
            details.style.display = 'block';
            icon.textContent = '‚ñ≤';
        } else {
            details.style.display = 'none';
            icon.textContent = '‚ñº';
        }
    }

    // Template switching
    function showTemplate(templateIndex) {
        // Hide all template sections
        document.querySelectorAll('.template-section').forEach(section => {
            section.classList.remove('active');
        });
        document.querySelectorAll('.template-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Show selected template
        document.getElementById('template-' + templateIndex).classList.add('active');
        document.getElementById('tab-' + templateIndex).classList.add('active');
        
        // Save the active tab to localStorage for persistence across page reloads
        localStorage.setItem('activeTemplateTab', templateIndex);
    }

    // Initialize active tab from localStorage or default to first tab
    function initializeActiveTab() {
        const savedTabIndex = localStorage.getItem('activeTemplateTab');
        
        // Check if saved tab index is valid (exists in DOM)
        if (savedTabIndex !== null) {
            const savedTab = document.getElementById('tab-' + savedTabIndex);
            const savedSection = document.getElementById('template-' + savedTabIndex);
            
            if (savedTab && savedSection) {
                // Restore the saved tab
                showTemplate(parseInt(savedTabIndex));
                return;
            }
        }
        
        // If no valid saved tab, ensure first tab is active (fallback)
        const firstTab = document.getElementById('tab-0');
        if (firstTab && !firstTab.classList.contains('active')) {
            showTemplate(0);
        }
    }

    // Combination actions
    function startCombination(combinationId) {
        console.log('Starting combination:', combinationId);
        
        fetch('/api/start_combination/' + combinationId, {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    console.log('Combination started successfully');
                    setTimeout(refreshDashboard, 1000);
                } else {
                    alert('Failed to start combination: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error starting combination:', error);
                alert('Error starting combination: ' + error.message);
            });
    }

    function restartCombination(combinationId) {
        console.log('Restarting combination:', combinationId);
        
        fetch('/api/restart_combination/' + combinationId, {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    console.log('Combination restarted successfully');
                    setTimeout(refreshDashboard, 1000);
                } else {
                    alert('Failed to restart combination: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error restarting combination:', error);
                alert('Error restarting combination: ' + error.message);
            });
    }

    function createAndStartCombination(speciesFile, model, systemTemplate, userTemplate) {
        console.log('Creating and starting combination:', speciesFile, model, systemTemplate, userTemplate);
        
        fetch('/api/create_combination', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                species_file: speciesFile,
                model: model,
                system_template: systemTemplate,
                user_template: userTemplate
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Combination created and started successfully');
                setTimeout(refreshDashboard, 1000);
            } else {
                alert('Failed to create combination: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error creating combination:', error);
            alert('Error creating combination: ' + error.message);
        });
    }

    function deleteCombination(combinationId) {
        if (confirm('Are you sure you want to delete this combination and all its results?')) {
            fetch('/api/delete_combination/' + combinationId, {method: 'DELETE'})
                .then(response => response.json())
                .then(data => {
                    console.log('Combination deleted');
                    setTimeout(refreshDashboard, 1000);
                })
                .catch(error => {
                    console.error('Error deleting combination:', error);
                    alert('Error deleting combination: ' + error.message);
                });
        }
    }

    // Modal functions
    function addModel() {
        document.getElementById('addModelModal').style.display = 'block';
        
        // Reset both input methods
        document.getElementById('newModelInput').value = '';
        document.getElementById('modelDropdown').selectedIndex = 0;
        document.getElementById('addModelBtn').disabled = true;
        document.getElementById('modelValidationStatus').style.display = 'none';
        document.getElementById('selectedModelInfo').style.display = 'none';
        
        // Switch to dropdown method by default
        switchInputMethod('dropdown');
        
        // Load models for dropdown
        loadOpenRouterModels();
        
        // Add event listeners
        const manualInput = document.getElementById('newModelInput');
        manualInput.removeEventListener('input', validateModelInput);
        manualInput.addEventListener('input', validateModelInput);
        
        const dropdown = document.getElementById('modelDropdown');
        dropdown.removeEventListener('change', onDropdownChange);
        dropdown.addEventListener('change', onDropdownChange);
    }

    function switchInputMethod(method) {
        // Update tab states
        document.querySelectorAll('.input-tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.input-method').forEach(method => method.classList.remove('active'));
        
        if (method === 'dropdown') {
            document.getElementById('dropdownTab').classList.add('active');
            document.getElementById('dropdownMethod').classList.add('active');
        } else {
            document.getElementById('manualTab').classList.add('active');
            document.getElementById('manualMethod').classList.add('active');
        }
        
        // Reset button state and validation
        document.getElementById('addModelBtn').disabled = true;
        document.getElementById('modelValidationStatus').style.display = 'none';
        document.getElementById('selectedModelInfo').style.display = 'none';
    }

    function loadOpenRouterModels() {
        const dropdown = document.getElementById('modelDropdown');
        const countSpan = document.getElementById('modelCount');
        
        dropdown.innerHTML = '<option value="">Loading models...</option>';
        dropdown.disabled = true;
        
        fetch('/api/get_openrouter_models')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    dropdown.innerHTML = '<option value="">Select a model...</option>';
                    
                    // Group models by provider for better organization
                    const providers = {};
                    data.models.forEach(model => {
                        const provider = model.id.split('/')[0];
                        if (!providers[provider]) providers[provider] = [];
                        providers[provider].push(model);
                    });
                    
                    // Add models grouped by provider
                    Object.keys(providers).sort().forEach(provider => {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = provider;
                        
                        providers[provider].forEach(model => {
                            const option = document.createElement('option');
                            option.value = model.id;
                            option.textContent = `${model.name || model.id}`;
                            option.dataset.description = model.description;
                            option.dataset.contextLength = model.context_length;
                            optgroup.appendChild(option);
                        });
                        
                        dropdown.appendChild(optgroup);
                    });
                    
                    countSpan.textContent = data.models.length;
                    dropdown.disabled = false;
                } else {
                    dropdown.innerHTML = '<option value="">Error loading models</option>';
                    countSpan.textContent = '0';
                    console.error('Error loading models:', data.error);
                }
            })
            .catch(error => {
                dropdown.innerHTML = '<option value="">Error loading models</option>';
                countSpan.textContent = '0';
                console.error('Error loading models:', error);
            });
    }

    function refreshModels() {
        loadOpenRouterModels();
    }

    function onDropdownChange() {
        const dropdown = document.getElementById('modelDropdown');
        const selectedOption = dropdown.options[dropdown.selectedIndex];
        const addBtn = document.getElementById('addModelBtn');
        const modelInfo = document.getElementById('selectedModelInfo');
        
        if (dropdown.value) {
            addBtn.disabled = false;
            
            // Show model information
            let infoHtml = `<strong>${selectedOption.textContent}</strong><br>`;
            if (selectedOption.dataset.description) {
                infoHtml += `<small>${selectedOption.dataset.description}</small><br>`;
            }
            if (selectedOption.dataset.contextLength && selectedOption.dataset.contextLength !== '0') {
                infoHtml += `<small>Context: ${parseInt(selectedOption.dataset.contextLength).toLocaleString()} tokens</small>`;
            }
            
            modelInfo.innerHTML = infoHtml;
            modelInfo.style.display = 'block';
        } else {
            addBtn.disabled = true;
            modelInfo.style.display = 'none';
        }
    }

    function getSelectedModel() {
        const activeMethod = document.querySelector('.input-method.active');
        
        if (activeMethod.id === 'dropdownMethod') {
            return document.getElementById('modelDropdown').value.trim();
        } else {
            return document.getElementById('newModelInput').value.trim();
        }
    }

    function validateModelInput() {
        const model = document.getElementById('newModelInput').value.trim();
        const statusDiv = document.getElementById('modelValidationStatus');
        const addBtn = document.getElementById('addModelBtn');
        
        if (!model) {
            statusDiv.style.display = 'none';
            addBtn.disabled = true;
            return;
        }
        
        // Show loading state
        statusDiv.style.display = 'block';
        statusDiv.className = 'validation-status loading';
        statusDiv.innerHTML = '‚è≥ Validating model with OpenRouter...';
        addBtn.disabled = true;
        
        // Debounce the validation call
        clearTimeout(window.modelValidationTimeout);
        window.modelValidationTimeout = setTimeout(() => {
            validateModelWithAPI(model);
        }, 500);
    }

    function validateModelWithAPI(model) {
        fetch('/api/validate_model', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({model: model})
        })
        .then(response => response.json())
        .then(data => {
            const statusDiv = document.getElementById('modelValidationStatus');
            const addBtn = document.getElementById('addModelBtn');
            
            if (data.valid) {
                statusDiv.className = 'validation-status success';
                statusDiv.innerHTML = '‚úÖ ' + data.message;
                addBtn.disabled = false;
            } else {
                statusDiv.className = 'validation-status error';
                statusDiv.innerHTML = '‚ùå ' + data.error;
                addBtn.disabled = true;
            }
        })
        .catch(error => {
            console.error('Model validation error:', error);
            const statusDiv = document.getElementById('modelValidationStatus');
            const addBtn = document.getElementById('addModelBtn');
            
            statusDiv.className = 'validation-status error';
            statusDiv.innerHTML = '‚ùå Validation failed: ' + error.message;
            addBtn.disabled = true;
        });
    }

    function confirmAddModel() {
        const model = getSelectedModel();
        if (model && !document.getElementById('addModelBtn').disabled) {
            // Show loading state
            const addBtn = document.getElementById('addModelBtn');
            const originalText = addBtn.textContent;
            addBtn.disabled = true;
            addBtn.textContent = 'Adding...';
            
            fetch('/api/add_model', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({model: model})
            })
            .then(res => res.json())
            .then(data => {
                console.log(data.message);
                closeModal('addModelModal');
                setTimeout(refreshDashboard, 500);
            })
            .catch(error => {
                console.error('Error adding model:', error);
                alert('Error adding model: ' + error.message);
            })
            .finally(() => {
                addBtn.disabled = false;
                addBtn.textContent = originalText;
            });
        }
    }

    function addSpeciesFile() {
        document.getElementById('addSpeciesModal').style.display = 'block';
    }



    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    function confirmAddSpecies() {
        const speciesFile = document.getElementById('newSpeciesSelect').value;
        if (speciesFile) {
            fetch('/api/add_species_file', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({species_file: speciesFile})
            })
            .then(res => res.json())
            .then(data => {
                console.log(data.message);
                closeModal('addSpeciesModal');
                setTimeout(refreshDashboard, 500);
            });
        }
    }



    function deleteModel(model) {
        if (confirm(`Are you sure you want to remove the model "${model}" from the dashboard view? This will not delete any existing results.`)) {
            fetch('/api/delete_model', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({model: model})
            })
            .then(res => res.json())
            .then(data => {
                console.log(data.message);
                setTimeout(refreshDashboard, 500);
            });
        }
    }

    function deleteSpeciesFile(speciesFile) {
        if (confirm(`Are you sure you want to remove the species file "${speciesFile}" from the dashboard view? This will not delete any existing results.`)) {
            fetch('/api/delete_species_file', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({species_file: speciesFile})
            })
            .then(res => res.json())
            .then(data => {
                console.log(data.message);
                setTimeout(refreshDashboard, 500);
            });
        }
    }

    function refreshDashboard() {
        location.reload();
    }
    
    function rerunFailedSpecies(combinationId, speciesName) {
        if (confirm(`Re-run failed species: ${speciesName}?`)) {
            fetch('/api/rerun_failed_species', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    combination_id: combinationId,
                    species_name: speciesName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    // Close the modal and refresh
                    closeModal('detailsModal');
                    setTimeout(refreshDashboard, 1000);
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error re-running species:', error);
                alert('Error re-running species: ' + error.message);
            });
        }
    }
    
    function rerunAllFailed(combinationId) {
        if (confirm('Re-run all failed species for this combination?')) {
            fetch(`/api/rerun_all_failed/${combinationId}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    // Close the modal and refresh
                    closeModal('detailsModal');
                    setTimeout(refreshDashboard, 1000);
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error re-running failed species:', error);
                alert('Error re-running failed species: ' + error.message);
            });
        }
    }
    
    // Auto-refresh every 30 seconds and update settings
    setInterval(() => {
        refreshDashboard();
        loadSettings();
    }, 30000);

    // Close modals when clicking outside
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    }

    // Template management functions
    function openTemplateManager() {
        const modal = document.getElementById('templateManagerModal');
        modal.style.display = 'block';
        loadTemplateMetadata();
    }

    function loadTemplateMetadata() {
        fetch('/api/template_metadata')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const container = document.getElementById('templateMetadataContainer');
                container.innerHTML = '';
                
                data.metadata.forEach(template => {
                    const templateItem = createTemplateItem(template);
                    container.appendChild(templateItem);
                });
            }
        })
        .catch(error => console.error('Error loading template metadata:', error));
    }

    function createTemplateItem(template) {
        const div = document.createElement('div');
        div.className = 'template-metadata-item template-type-' + template.template_type;
        div.innerHTML = `
            <div class="template-metadata-header">
                <h4>
                    ${template.template_type === 'knowledge' ? '<i class="fas fa-brain"></i>' : '<i class="fas fa-dna"></i>'}
                    ${template.template_name} (Files)
                    <span class="template-type-badge template-type-${template.template_type}">
                        ${template.template_type.charAt(0).toUpperCase() + template.template_type.slice(1)} Template
                    </span>
                </h4>
                <small>${template.system_template} | ${template.user_template}</small>
            </div>
            <div class="template-metadata-form">
                <div class="form-group">
                    <label>Display Name:</label>
                    <input type="text" class="display-name-input" value="${template.display_name}" 
                           data-system="${template.system_template}" data-user="${template.user_template}">
                </div>
                <div class="form-group">
                    <label>Description:</label>
                    <textarea class="description-input" rows="2" 
                              data-system="${template.system_template}" data-user="${template.user_template}">${template.description}</textarea>
                </div>
                <div class="form-group">
                    <label>Template Type:</label>
                    <select class="template-type-select" data-system="${template.system_template}" data-user="${template.user_template}">
                        <option value="phenotype" ${template.template_type === 'phenotype' ? 'selected' : ''}>
                            Phenotype Template (Species Properties)
                        </option>
                        <option value="knowledge" ${template.template_type === 'knowledge' ? 'selected' : ''}>
                            Knowledge Template (Knowledge Assessment)
                        </option>
                    </select>
                </div>
                <button class="btn btn-primary btn-small" onclick="saveTemplateMetadata('${template.system_template}', '${template.user_template}')">
                    Save
                </button>
            </div>
        `;
        return div;
    }

    function saveTemplateMetadata(systemTemplate, userTemplate) {
        const displayNameInput = document.querySelector(`input[data-system="${systemTemplate}"][data-user="${userTemplate}"]`);
        const descriptionInput = document.querySelector(`textarea[data-system="${systemTemplate}"][data-user="${userTemplate}"]`);
        const templateTypeSelect = document.querySelector(`select[data-system="${systemTemplate}"][data-user="${userTemplate}"]`);
        
        const displayName = displayNameInput.value.trim();
        const description = descriptionInput.value.trim();
        const templateType = templateTypeSelect.value;
        
        if (!displayName) {
            alert('Display name is required');
            return;
        }
        
        fetch('/api/update_template_metadata', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                system_template: systemTemplate,
                user_template: userTemplate,
                display_name: displayName,
                description: description,
                template_type: templateType
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Template metadata updated successfully!');
                setTimeout(() => {
                    closeModal('templateManagerModal');
                    refreshDashboard();
                }, 1000);
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error saving template metadata:', error);
            alert('Error saving template metadata');
        });
    }
</script>

<!-- Template Manager Modal -->
<div id="templateManagerModal" class="modal">
    <div class="modal-content template-manager-modal">
        <div class="modal-header">
            <h3>Manage Template Names & Descriptions</h3>
            <span class="close" onclick="closeModal('templateManagerModal')">&times;</span>
        </div>
        <div class="modal-body">
            <p>Customize the display names and descriptions for your template pairs:</p>
            <div id="templateMetadataContainer" class="template-metadata-scrollable">
                <!-- Template metadata items will be loaded here -->
            </div>
        </div>
    </div>
</div>

<style>
.template-manage-tab {
    background: #f8f9fa !important;
    border: 1px dashed #007bff !important;
    color: #007bff !important;
}

.template-manage-tab:hover {
    background: #e3f2fd !important;
}

.template-description {
    margin: 10px 0;
    color: #6c757d;
    font-style: italic;
}

.template-manager-modal {
    max-width: 800px;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
}

.template-manager-modal .modal-body {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}

.template-metadata-scrollable {
    max-height: 60vh;
    overflow-y: auto;
    padding-right: 10px;
}

.template-metadata-item {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    background: #f8f9fa;
}

.template-metadata-item.template-type-knowledge {
    border-left: 4px solid #9b59b6;
}

.template-metadata-item.template-type-phenotype {
    border-left: 4px solid #00796b;
}

.template-metadata-header h4 {
    margin: 0 0 5px 0;
    color: #495057;
}

.template-metadata-header small {
    color: #6c757d;
}

.template-metadata-form {
    margin-top: 15px;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: #495057;
}

.display-name-input, .description-input, .template-type-select {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 14px;
}

.display-name-input:focus, .description-input:focus, .template-type-select:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
}

.template-type-badge {
    font-size: 12px;
    padding: 2px 6px;
    border-radius: 3px;
    margin-left: 8px;
    font-weight: normal;
}

.template-type-badge.template-type-knowledge {
    background-color: #9b59b6;
    color: white;
}

.template-type-badge.template-type-phenotype {
    background-color: #00796b;
    color: white;
}

.progress-line.na-entries {
    color: #6c757d;
}

.progress-line.na-entries .progress-label {
    color: #6c757d;
}

.progress-line.na-entries .progress-value {
    color: #6c757d;
    font-weight: 500;
}

/* Knowledge level styling */
.knowledge-level {
    margin: 10px 0;
}

.knowledge-value {
    font-weight: 600;
    padding: 3px 8px;
    border-radius: 4px;
    display: inline-block;
}

.knowledge-value.knowledge-limited {
    background-color: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}

.knowledge-value.knowledge-moderate {
    background-color: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
}

.knowledge-value.knowledge-extensive {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.knowledge-value.knowledge-na {
    background-color: #e2e3e5;
    color: #6c757d;
    border: 1px solid #d6d8db;
}

.progress-line.na-entries {
}

.setting-item {
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.setting-item label {
    min-width: 150px;
    font-weight: 500;
}

.setting-item input {
    width: 80px;
    padding: 5px 10px;
    border: 1px solid #ced4da;
    border-radius: 4px;
}

.setting-item .form-help {
    color: #6c757d;
    font-size: 0.875rem;
    margin-left: 10px;
}

.settings-note {
    margin-top: 15px;
    padding: 10px;
    background-color: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 4px;
    color: #856404;
    font-size: 0.9rem;
}

.queue-status {
    margin-top: 15px;
    padding: 10px;
    background-color: #d1ecf1;
    border: 1px solid #bee5eb;
    border-radius: 4px;
    color: #0c5460;
}

.rerun-all-container {
    margin-top: 15px;
    text-align: center;
}

.rerun-container {
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid #dee2e6;
}

.btn-warning {
    background-color: #ffc107;
    border-color: #ffc107;
    color: #212529;
}

.btn-warning:hover {
    background-color: #e0a800;
    border-color: #d39e00;
    color: #212529;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    line-height: 1.5;
    border-radius: 0.2rem;
}
</style>

{% endblock %} 