{% extends "base.html" %}

{% block title %}MicrobeBench Dashboard{% endblock %}

{% block body_class %}page-dashboard{% endblock %}

{% block content %}
<div class="content-wrapper">
    <div class="card">
        <h2>Dashboard</h2>
        <p>Manage your microbial prediction jobs</p>
    </div>
    
    <!-- API Key Warning -->
    <div id="apiKeyWarning" class="card api-warning" style="display: none;">
        <h3>⚠️ API Key Not Configured</h3>
        <p>OpenRouter API key is not set. Jobs will fail without a valid API key.</p>
        <button onclick="window.location.href='/settings'" class="button">Configure API Key</button>
    </div>
    
    <!-- API Status -->
    <div class="card" style="margin-bottom: 20px;">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div>
                <h3 style="margin: 0 0 5px 0;">API Status</h3>
                <p style="margin: 0; color: var(--text-secondary); font-size: 12px;">OpenRouter API connection status</p>
            </div>
            <div class="status-indicator" id="apiStatus">
                <span class="status-dot"></span>
                <span id="apiStatusText">CHECKING</span>
            </div>
        </div>
    </div>

    <div class="dashboard-header">
        <div class="dashboard-controls">
            <button onclick="toggleSettings()" class="btn btn-ghost">
                <i class="fas fa-cog"></i> Settings
            </button>
            <a href="/export" class="btn">
                <i class="fas fa-download"></i> Export
            </a>
            <a href="/import" class="btn">
                <i class="fas fa-upload"></i> Import
            </a>
            <button onclick="refreshDashboard(true)" class="btn" id="refreshBtn">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </div>

    {% if dashboard_data.matrix %}
        <!-- Template Navigation -->
        <div class="template-tabs">
            {% set templates = dashboard_data.template_display_info %}
            {% for template_info in templates %}
                {% set i = loop.index0 %}
                <button class="template-tab {% if i == 0 %}active{% endif %}"
                        onclick="showTemplate({{ i }})"
                        id="tab-{{ i }}"
                        data-tooltip="{{ template_info.description }} ({{ template_info.template_type }} template)">
                    {{ template_info.display_name }}
                </button>
            {% endfor %}
            <button class="template-tab" 
                    onclick="openTemplateManager()" 
                    id="template-manage-btn"
                    data-tooltip="Manage template names">
                <i class="fas fa-edit"></i>
            </button>
        </div>

        <!-- Template Sections -->
        {% for template_info in dashboard_data.template_display_info %}
            {% set sys_template = template_info.system_template %}
            {% set user_template = template_info.user_template %}
            {% set i = loop.index0 %}
            {% set file_template_name = sys_template.split('/')[-1].replace('.txt', '') %}
            <div class="template-section {% if i == 0 %}active{% endif %}" id="template-{{ i }}">
                <div class="template-info card mb-3">
                    <p class="text-muted mb-1">{{ template_info.description }}</p>
                    <div class="text-small">
                        System: <a href="/view_template/system/{{ file_template_name }}" target="_blank">{{ sys_template.split('/')[-1] }}</a> | 
                        User: <a href="/view_template/user/{{ file_template_name }}" target="_blank">{{ user_template.split('/')[-1] }}</a>
                    </div>
                </div>

                <div class="matrix-container">
                    <div class="matrix-scroll" id="matrix-scroll-{{ i }}">
                        <table class="processing-matrix">
                            <thead>
                                <tr>
                                    <th class="species-header">Species Files</th>
                                    {% for model in dashboard_data.models %}
                                    <th class="model-header">
                                        <div class="model-name">{{ model.split('/')[-1] }}</div>
                                        <button class="btn btn-ghost btn-sm" onclick="deleteModel('{{ model }}')" title="Remove model">×</button>
                                    </th>
                                    {% endfor %}
                                    <th class="add-column">
                                        <button class="btn btn-accent btn-sm" onclick="addModel()" title="Add model">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for species_file in dashboard_data.species_files %}
                                    <tr>
                                        <td class="species-name">
                                            <div>{{ species_file.split('/')[-1] }}</div>
                                            <button class="btn btn-ghost btn-sm" onclick="deleteSpeciesFile('{{ species_file }}')" title="Remove file">×</button>
                                        </td>
                                        {% for model in dashboard_data.models %}
                                            {% set cell_key = species_file + '|' + sys_template + '|' + user_template %}
                                            {% set cell_data = dashboard_data.matrix.get(cell_key, {}).get('models', {}).get(model) %}
                                            <td class="matrix-cell" id="cell-{{ i }}-{{ species_file }}-{{ model }}">
                                                {% if cell_data %}
                                                    <div class="status-cell status-{{ cell_data.status }}" onclick="showCombinationDetails({{ cell_data.id }})" data-combination-id="{{ cell_data.id }}">
                                                        <button class="delete-btn" onclick="event.stopPropagation(); deleteCombination({{ cell_data.id }})">&times;</button>
                                                        <div class="progress-info">
                                                            <div class="progress-main">
                                                                {% if cell_data.status == 'running' %}
                                                                    <span class="progress-running">{{ cell_data.submitted }}/{{ cell_data.total }}</span>
                                                                {% elif cell_data.status in ['completed', 'failed', 'interrupted'] %}
                                                                    <span>{{ cell_data.successful }}/{{ cell_data.total }}</span>
                                                                {% else %}
                                                                    <span class="status-label">{{ cell_data.status }}</span>
                                                                {% endif %}
                                                            </div>
                                                            <div class="progress-details progress-completed">
                                                                {% if cell_data.status in ['completed', 'failed', 'interrupted'] %}
                                                                    {% set parts = [] %}
                                                                    {% if cell_data.successful > 0 %}{% set _ = parts.append(cell_data.successful ~ ' success') %}{% endif %}
                                                                    {% if cell_data.failed > 0 %}{% set _ = parts.append(cell_data.failed ~ ' failed') %}{% endif %}
                                                                    {% if cell_data.timeouts > 0 %}{% set _ = parts.append(cell_data.timeouts ~ ' timeout') %}{% endif %}
                                                                    {{ parts | join(', ') }}
                                                                {% elif cell_data.status == 'running' %}
                                                                    {{ cell_data.successful }} success
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                        
                                                        {% if cell_data.total > 0 and (cell_data.status == 'running' or cell_data.successful > 0 or cell_data.failed > 0 or cell_data.timeouts > 0) %}
                                                            <div class="progress-bar">
                                                                <div class="progress-fill" style="width: {{ (( (cell_data.successful + cell_data.failed + cell_data.timeouts) / cell_data.total * 100)|round) }}%"></div>
                                                            </div>
                                                        {% endif %}
                                                        
                                                        <div class="cell-actions">
                                                            {% if cell_data.status == 'pending' %}
                                                                <button onclick="event.stopPropagation(); startCombination({{ cell_data.id }})" class="action-btn start-btn">Start</button>
                                                            {% elif cell_data.status == 'running' %}
                                                                <button onclick="event.stopPropagation(); pauseCombination({{ cell_data.id }})" class="action-btn pause-btn" title="Pause">Pause</button>
                                                                <button onclick="event.stopPropagation(); stopCombination({{ cell_data.id }})" class="action-btn stop-btn" title="Stop">Stop</button>
                                                            {% elif cell_data.status == 'completed' and cell_data.failed == 0 and cell_data.timeouts == 0 %}
                                                                <span class="status-label">Complete</span>
                                                            {% elif cell_data.status in ['completed', 'failed', 'interrupted'] %}
                                                                <button onclick="event.stopPropagation(); restartCombination({{ cell_data.id }})" class="action-btn start-btn">Retry</button>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                {% else %}
                                                    <div class="status-cell status-empty">
                                                        <button onclick="event.stopPropagation(); createAndStartCombination('{{ species_file }}', '{{ model }}', '{{ sys_template }}', '{{ user_template }}')" 
                                                                class="action-btn">
                                                            Create
                                                        </button>
                                                    </div>
                                                {% endif %}
                                            </td>
                                        {% endfor %}
                                        <td class="add-cell"></td>
                                    </tr>
                                {% endfor %}
                                <tr class="add-row">
                                    <td>
                                        <button class="btn btn-accent btn-sm" onclick="addSpeciesFile()">
                                            <i class="fas fa-plus"></i> Add File
                                        </button>
                                    </td>
                                    {% for model in dashboard_data.models %}
                                        <td></td>
                                    {% endfor %}
                                    <td></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        {% endfor %}

    {% else %}
        <div class="empty-state">
            <div class="empty-icon">
                <i class="fas fa-flask"></i>
            </div>
            <h3>No Processing Combinations Yet</h3>
            <p class="text-muted">Start by adding a species file and selecting models to process</p>
            <button onclick="addSpeciesFile()" class="btn btn-primary">
                <i class="fas fa-plus"></i> Add First Species File
            </button>
        </div>
    {% endif %}

    <!-- Live Status Display -->
    <div id="liveStatusModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 id="liveStatusTitle">Live Status</h3>
                <button onclick="closeModal('liveStatusModal')" class="modal-close">×</button>
            </div>
            <div class="modal-body" id="liveStatusContent">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="detailsModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 id="detailsTitle">Combination Details</h3>
                <button onclick="closeModal('detailsModal')" class="modal-close">×</button>
            </div>
            <div class="modal-body" id="detailsContent">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Add Model Modal -->
    <div id="addModelModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Model</h3>
                <button onclick="closeModal('addModelModal')" class="modal-close">×</button>
            </div>
            <div class="modal-body">
                <div class="setting-group">
                    <label class="setting-label">Model Selection</label>
                    <div class="input-tabs mb-2">
                        <button class="input-tab active" onclick="switchInputMethod('dropdown')" id="dropdownTab">
                            Browse
                        </button>
                        <button class="input-tab" onclick="switchInputMethod('manual')" id="manualTab">
                            Manual
                        </button>
                    </div>
                    
                    <div id="dropdownMethod" class="input-method active">
                        <div class="input-group">
                            <select id="modelDropdown" class="form-control">
                                <option value="">Loading models...</option>
                            </select>
                            <button onclick="refreshModels()" class="btn btn-ghost btn-sm" title="Refresh">
                                <i class="fas fa-sync"></i>
                            </button>
                        </div>
                        <small class="text-muted mt-1">
                            <span id="modelCount">0</span> models available
                        </small>
                        <div id="selectedModelInfo" class="model-info mt-2" style="display: none;"></div>
                    </div>
                    
                    <div id="manualMethod" class="input-method">
                        <input type="text" id="newModelInput" class="form-control" 
                               placeholder="e.g., anthropic/claude-3-haiku">
                        <small class="text-muted mt-1">
                            Enter the full model name from <a href="https://openrouter.ai/models" target="_blank">OpenRouter</a>
                        </small>
                        <div id="modelValidationStatus" class="validation-status mt-2" style="display: none;"></div>
                    </div>
                </div>
                
                <div class="mt-3" style="text-align: right;">
                    <button onclick="closeModal('addModelModal')" class="btn">Cancel</button>
                    <button id="addModelBtn" onclick="confirmAddModel()" class="btn btn-primary" disabled>Add Model</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Species Modal -->
    <div id="addSpeciesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Species File</h3>
                <button onclick="closeModal('addSpeciesModal')" class="modal-close">×</button>
            </div>
            <div class="modal-body">
                <div class="setting-group">
                    <label class="setting-label">Select Species File</label>
                    <select id="newSpeciesSelect" class="form-control">
                        <option value="">Select a file...</option>
                        {% for file in dashboard_data.available_species_files %}
                            <option value="{{ file }}">{{ file }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mt-3" style="text-align: right;">
                    <button onclick="closeModal('addSpeciesModal')" class="btn">Cancel</button>
                    <button onclick="confirmAddSpecies()" class="btn btn-primary">Add File</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Raw Response Modal -->
    <div id="rawResponseModal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h3 id="rawResponseTitle">Raw Response</h3>
                <button onclick="closeModal('rawResponseModal')" class="modal-close">×</button>
            </div>
            <div class="modal-body">
                <div class="response-tabs">
                    <button class="response-tab active" onclick="switchResponseTab('raw')" id="rawTab">
                        Raw Response
                    </button>
                    <button class="response-tab" onclick="switchResponseTab('parsed')" id="parsedTab">
                        Parsed Data
                    </button>
                </div>
                
                <div id="rawResponseContent" class="response-content active">
                    <pre id="rawResponseText"></pre>
                </div>
                
                <div id="parsedResponseContent" class="response-content">
                    <div id="parsedResponseData"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block settings_content %}
<div class="setting-group">
    <label class="setting-label">API Configuration</label>
    <div class="api-key-input-group">
        <input type="password" id="apiKeyInput" placeholder="Enter your OpenRouter API key">
        <button onclick="toggleApiKeyVisibility()" class="btn btn-ghost btn-sm" id="toggleApiKeyBtn">Show</button>
        <button onclick="updateApiKey()" class="btn btn-primary btn-sm">Update</button>
    </div>
    <small class="text-muted mt-1">
        Get your key from <a href="https://openrouter.ai/keys" target="_blank">OpenRouter</a>
    </small>
</div>

<div class="setting-group">
    <label class="setting-label">Processing Rate</label>
    <div class="input-group">
        <input type="number" id="rateLimitInput" min="0.1" max="100" step="0.1" value="30">
        <span class="text-muted">req/sec</span>
        <button onclick="updateRateLimit()" class="btn btn-primary btn-sm">Update</button>
    </div>
</div>

<div class="setting-group">
    <label class="setting-label">Concurrent Requests</label>
    <div class="input-group">
        <input type="number" id="concurrentInput" min="1" max="30" step="1" value="30">
        <span class="text-muted">workers</span>
        <button onclick="updateConcurrency()" class="btn btn-primary btn-sm">Update</button>
    </div>
    <small class="text-muted mt-1">Number of species to process in parallel</small>
</div>

<div class="setting-group">
    <label class="setting-label">Queue Status</label>
    <div class="queue-info">
        <span id="queueLength">0</span> jobs waiting
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
    /* Dashboard specific styles */
    .dashboard-header {
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    /* Template section visibility */
    .template-section {
        display: none;
    }
    
    .template-section.active {
        display: block;
    }
    
    .dashboard-controls {
        display: flex;
        gap: 8px;
        align-items: center;
    }
    
    .template-info {
        background: var(--bg-secondary);
        padding: 16px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
    }
    
    .cell-actions {
        display: flex;
        gap: 4px;
        margin-top: 4px;
    }
    
    .status-label {
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-secondary);
    }
    
    .progress-running {
        animation: pulse 1s ease-in-out infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }
    
    .text-success { color: var(--accent-secondary); }
    .text-error { color: var(--accent-error); }
    .text-warning { color: var(--accent-warning); }
    
    .api-key-input-group {
        display: flex;
        gap: 8px;
        align-items: center;
    }
    
    .api-key-input-group input {
        flex: 1;
    }
    
    .queue-info {
        padding: 12px;
        background: var(--bg-secondary);
        border-radius: 6px;
        text-align: center;
        font-weight: 600;
    }
    
    .input-tabs {
        display: flex;
        gap: 2px;
        background: var(--bg-secondary);
        padding: 2px;
        border-radius: 6px;
    }
    
    .input-tab {
        flex: 1;
        padding: 6px 12px;
        background: transparent;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 11px;
        font-weight: 500;
        color: var(--text-secondary);
        transition: all 0.2s;
    }
    
    .input-tab:hover {
        color: var(--text-primary);
    }
    
    .input-tab.active {
        background: var(--white);
        color: var(--text-primary);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .input-method {
        display: none;
    }
    
    .input-method.active {
        display: block;
    }
    
    .model-info {
        background: var(--bg-secondary);
        padding: 12px;
        border-radius: 6px;
        font-size: 11px;
        line-height: 1.5;
    }
    
    .validation-status {
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 500;
    }
    
    .validation-status.loading {
        background: var(--bg-secondary);
        color: var(--text-secondary);
    }
    
    .validation-status.success {
        background: var(--accent-secondary);
        color: var(--white);
    }
    
    .validation-status.error {
        background: var(--accent-error);
        color: var(--white);
    }
    
    /* Live status display */
    .live-status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 12px;
        margin-top: 16px;
    }
    
    .live-status-item {
        padding: 12px;
        background: var(--bg-secondary);
        border-radius: 6px;
        text-align: center;
        transition: all 0.2s;
    }
    
    .live-status-item.processing {
        background: linear-gradient(135deg, var(--accent-secondary) 0%, transparent 70%);
        border: 1px solid var(--accent-secondary);
    }
    
    .live-status-item.success {
        background: linear-gradient(135deg, var(--accent-primary) 0%, transparent 70%);
        border: 1px solid var(--accent-primary);
    }
    
    .live-status-item.failed {
        background: linear-gradient(135deg, var(--accent-error) 0%, transparent 70%);
        border: 1px solid var(--accent-error);
    }
    
    .species-name-live {
        font-weight: 600;
        font-size: 11px;
        margin-bottom: 4px;
        font-style: italic;
    }
    
    .species-status-live {
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    /* Fix for sticky positioning */
    .processing-matrix {
        position: relative;
    }
    
    .species-header,
    .species-name {
        position: sticky;
        left: 0;
        background: var(--bg-secondary);
        z-index: 9;
    }
    
    .model-header {
        position: sticky;
        top: 0;
        background: var(--bg-secondary);
        z-index: 8;
    }
    
    .species-header {
        z-index: 10;
    }
    
    /* Delete buttons */
    .species-name button,
    .model-header button {
        position: absolute;
        top: 4px;
        right: 4px;
        opacity: 0;
        transition: opacity 0.2s;
    }
    
    .species-name:hover button,
    .model-header:hover button {
        opacity: 1;
    }
    
    /* Details modal styles */
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 16px;
        margin-top: 16px;
    }
    
    .summary-grid > div {
        padding: 12px;
        background: var(--bg-secondary);
        border-radius: 6px;
        text-align: center;
        font-size: 12px;
    }
    
    .species-list {
        max-height: 400px;
        overflow-y: auto;
        margin-top: 16px;
    }
    
    .species-result {
        padding: 8px 12px;
        margin-bottom: 8px;
        border-radius: 4px;
        font-size: 11px;
        border: 1px solid var(--border-color);
    }
    
    .species-result.success {
        background: rgba(146, 205, 182, 0.1);
        border-color: var(--accent-secondary);
    }
    
    .species-result.failed {
        background: rgba(255, 179, 186, 0.1);
        border-color: var(--accent-error);
    }
    
    .error-msg {
        margin-top: 4px;
        font-size: 10px;
        color: var(--accent-error);
    }
    
    .species-result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
    }
    
    .species-actions {
        display: flex;
        gap: 4px;
    }
    
    .btn-small {
        padding: 2px 6px;
        font-size: 9px;
        border-radius: 3px;
        border: 1px solid currentColor;
        background: transparent;
        cursor: pointer;
        transition: all 0.2s;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .btn-small:hover {
        background: currentColor;
        color: var(--white);
    }
    
    .btn-retry { color: var(--accent-warning); }
    .btn-view { color: var(--accent-primary); }
    
    .response-tabs {
        display: flex;
        gap: 2px;
        background: var(--bg-secondary);
        padding: 2px;
        border-radius: 6px;
        margin-bottom: 16px;
    }
    
    .response-tab {
        flex: 1;
        padding: 8px 16px;
        background: transparent;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 500;
        color: var(--text-secondary);
        transition: all 0.2s;
    }
    
    .response-tab:hover {
        color: var(--text-primary);
    }
    
    .response-tab.active {
        background: var(--white);
        color: var(--text-primary);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .response-content {
        display: none;
    }
    
    .response-content.active {
        display: block;
    }
    
    .response-content pre {
        background: var(--bg-secondary);
        padding: 16px;
        border-radius: 6px;
        font-size: 11px;
        line-height: 1.5;
        overflow-x: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    
    .parsed-data-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
    }
    
    .parsed-field {
        padding: 12px;
        background: var(--bg-secondary);
        border-radius: 6px;
        border-left: 3px solid var(--accent-primary);
    }
    
    .field-label {
        font-weight: 600;
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-secondary);
        margin-bottom: 4px;
    }
    
    .field-value {
        font-size: 12px;
        color: var(--text-primary);
    }
</style>

<script>
    // Initialize Socket.IO connection
    const socket = io();
    
    // State management
    let activeTemplateIndex = 0;
    let liveStatusTracking = null;
    let autoRefreshEnabled = true;
    let lastUpdateTime = Date.now();
    
    socket.on('connect', function() {
        console.log('Connected to server');
        checkApiKeyStatus();
    });
    
    socket.on('job_update', function(data) {
        console.log('Job update received:', data);
        // Update cell directly with WebSocket data instead of making API call
        updateCellProgress(data.combination_id, data);
        updateCellStatusClass(data.combination_id, data.status);
        updateCellActions(data.combination_id, data);
    });
    
    socket.on('progress_update', function(data) {
        // Real-time progress updates
        updateCellProgress(data.combination_id, data);
    });
    
    socket.on('log_message', function(data) {
        // Update live status if modal is open
        if (liveStatusTracking === data.combination_id) {
            updateLiveStatus(data);
        }
    });
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Check API key status
        fetch('/api/api_key_status')
            .then(response => response.json())
            .then(data => {
                if (!data.configured) {
                    document.getElementById('apiKeyWarning').style.display = 'block';
                }
            });
        
        // Initialize template tabs
        const savedTab = localStorage.getItem('activeTemplateTab');
        if (savedTab !== null && document.getElementById('tab-' + savedTab)) {
            showTemplate(parseInt(savedTab));
        } else {
            // Make sure at least the first tab is active
            showTemplate(0);
        }
        
        // Load settings
        loadSettings();
        
        // Set up auto-save scroll positions
        document.querySelectorAll('.matrix-scroll').forEach((container, index) => {
            container.addEventListener('scroll', () => {
                saveScrollPosition(`template-${index}`);
            });
        });
        
        // Restore scroll positions
        setTimeout(() => {
            document.querySelectorAll('.matrix-scroll').forEach((container, index) => {
                restoreScrollPosition(`template-${index}`);
            });
        }, 100);
    });
    
    // Template management
    function showTemplate(index) {
        console.log('Switching to template tab:', index);
        activeTemplateIndex = index;
        
        // Save current scroll position
        const currentActive = document.querySelector('.template-section.active');
        if (currentActive) {
            const currentScroll = currentActive.querySelector('.matrix-scroll');
            if (currentScroll) {
                const currentIndex = currentActive.id.split('-')[1];
                saveScrollPosition(`template-${currentIndex}`);
            }
        }
        
        // Update tabs - exclude the manage button
        const tabs = document.querySelectorAll('.template-tab:not(#template-manage-btn)');
        tabs.forEach((tab, i) => {
            if (i === index) {
                tab.classList.add('active');
            } else {
                tab.classList.remove('active');
            }
        });
        
        // Update sections
        const sections = document.querySelectorAll('.template-section');
        sections.forEach((section, i) => {
            if (i === index) {
                section.classList.add('active');
            } else {
                section.classList.remove('active');
            }
        });
        
        // Save preference
        localStorage.setItem('activeTemplateTab', index);
        
        // Restore scroll position for new tab
        setTimeout(() => {
            restoreScrollPosition(`template-${index}`);
        }, 10);
    }
    
    // API Key Management
    function checkApiKeyStatus() {
        fetch('/api/api_key_status')
            .then(response => response.json())
            .then(data => {
                const statusEl = document.getElementById('apiStatus');
                const textEl = document.getElementById('apiStatusText');
                
                if (data.status === 'configured') {
                    statusEl.classList.add('active');
                    statusEl.classList.remove('error');
                    textEl.textContent = 'API READY';
                } else {
                    statusEl.classList.add('error');
                    statusEl.classList.remove('active');
                    textEl.textContent = data.message || 'NO API KEY';
                }
            })
            .catch(error => {
                console.error('Error checking API key status:', error);
            });
    }
    
    function toggleApiKeyVisibility() {
        const input = document.getElementById('apiKeyInput');
        const btn = document.getElementById('toggleApiKeyBtn');
        
        if (input.type === 'password') {
            input.type = 'text';
            btn.textContent = 'Hide';
        } else {
            input.type = 'password';
            btn.textContent = 'Show';
        }
    }
    
    function updateApiKey() {
        const apiKey = document.getElementById('apiKeyInput').value.trim();
        
        if (!apiKey) {
            alert('Please enter an API key');
            return;
        }
        
        fetch('/api/set_api_key', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({api_key: apiKey})
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('API key updated. Please restart the server for changes to take effect.');
                document.getElementById('apiKeyInput').value = '';
                checkApiKeyStatus();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error updating API key:', error);
            alert('Error updating API key');
        });
    }
    
    // Settings Management
    function loadSettings() {
        fetch('/api/get_settings')
            .then(response => response.json())
            .then(data => {
                document.getElementById('rateLimitInput').value = data.rate_limit;
                document.getElementById('concurrentInput').value = data.max_concurrent_requests;
                document.getElementById('queueLength').textContent = data.queue_length;
            })
            .catch(error => console.error('Error loading settings:', error));
    }
    
    function updateRateLimit() {
        const rateLimit = parseFloat(document.getElementById('rateLimitInput').value);
        
        fetch('/api/set_rate_limit', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({requests_per_second: rateLimit})
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                showNotification('Rate limit updated', 'success');
            } else {
                showNotification('Error: ' + data.error, 'error');
            }
        });
    }
    
    function updateConcurrency() {
        const concurrency = parseInt(document.getElementById('concurrentInput').value);
        
        fetch('/api/set_rate_limit', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({max_concurrent_requests: concurrency})
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                showNotification('Concurrency updated', 'success');
            } else {
                showNotification('Error: ' + data.error, 'error');
            }
        });
    }
    
    // Cell updates without full refresh
    function updateCellStatus(combinationId) {
        fetch(`/api/combination_details/${combinationId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) return;
                
                // Find and update the specific cell
                const cell = document.querySelector(`[data-combination-id="${combinationId}"]`);
                if (cell) {
                    updateCellContent(cell, data);
                }
            });
    }
    
    function updateCellProgress(combinationId, progressData) {
        const cell = document.querySelector(`[data-combination-id="${combinationId}"]`);
        if (cell) {
            const progressMain = cell.querySelector('.progress-main');
            const progressFill = cell.querySelector('.progress-fill');
            const progressCompleted = cell.querySelector('.progress-completed');
            
            // Calculate processed count (successful + failed + timeouts)
            const processed = (progressData.successful || 0) + (progressData.failed || 0) + (progressData.timeouts || 0);
            const total = progressData.total || 0;
            
            // Only update progress if we have valid data (avoid showing 0/0 for completed jobs)
            if (total > 0) {
                if (progressMain) {
                    // For completed jobs, show final results
                    if (progressData.status === 'completed' || progressData.status === 'failed' || progressData.status === 'interrupted') {
                        progressMain.innerHTML = `<span class="progress-completed">${processed}/${total}</span>`;
                    } else {
                        progressMain.innerHTML = `<span class="progress-running">${processed}/${total}</span>`;
                    }
                }
                
                if (progressCompleted) {
                    // Show detailed breakdown for completed jobs
                    if (progressData.status === 'completed' || progressData.status === 'failed' || progressData.status === 'interrupted') {
                        const parts = [];
                        if (progressData.successful > 0) parts.push(`${progressData.successful} success`);
                        if (progressData.failed > 0) parts.push(`${progressData.failed} failed`);
                        if (progressData.timeouts > 0) parts.push(`${progressData.timeouts} timeout`);
                        progressCompleted.textContent = parts.join(', ');
                    } else {
                        progressCompleted.textContent = `${progressData.successful || 0} success`;
                    }
                }
                
                if (progressFill) {
                    const percentage = (processed / total * 100).toFixed(0);
                    progressFill.style.width = percentage + '%';
                }
            }
            
            // Update status icon if needed
            if (progressData.status) {
                updateCellStatusClass(combinationId, progressData.status);
            }
        }
    }
    
    function updateCellStatusClass(combinationId, status) {
        const cell = document.querySelector(`[data-combination-id="${combinationId}"]`);
        if (cell) {
            // Remove existing status classes
            cell.classList.remove('status-pending', 'status-running', 'status-completed', 'status-failed', 'status-interrupted');
            // Add new status class
            cell.classList.add(`status-${status}`);
        }
    }
    
    function updateCellContent(cell, data) {
        // Update cell status class
        cell.className = `status-cell status-${data.status}`;
        
        // Update progress info
        const progressInfo = cell.querySelector('.progress-info');
        if (progressInfo) {
            // Update based on new data
            // ... (implementation details)
        }
    }
    
    function updateCellActions(combinationId, data) {
        const cell = document.querySelector(`[data-combination-id="${combinationId}"]`);
        if (!cell) return;
        
        const actionsContainer = cell.querySelector('.cell-actions');
        if (!actionsContainer) return;

        let newHtml = '';
        const status = data.status;
        const failed_count = data.failed || 0;
        const timeout_count = data.timeouts || 0;

        if (status === 'pending') {
            newHtml = `<button onclick="event.stopPropagation(); startCombination(${combinationId})" class="action-btn start-btn">Start</button>`;
        } else if (status === 'running') {
            newHtml = `
                <button onclick="event.stopPropagation(); pauseCombination(${combinationId})" class="action-btn pause-btn" title="Pause">Pause</button>
                <button onclick="event.stopPropagation(); stopCombination(${combinationId})" class="action-btn stop-btn" title="Stop">Stop</button>
            `;
        } else if (status === 'completed' && failed_count === 0 && timeout_count === 0) {
            newHtml = `<span class="status-label">Complete</span>`;
        } else if (['completed', 'failed', 'interrupted'].includes(status)) {
            newHtml = `<button onclick="event.stopPropagation(); restartCombination(${combinationId})" class="action-btn start-btn">Retry</button>`;
        }
        
        actionsContainer.innerHTML = newHtml;
    }
    
    // Refresh dashboard with scroll preservation
    function refreshDashboard(manual = false) {
        if (manual) {
            const btn = document.getElementById('refreshBtn');
            btn.classList.add('loading');
        }
        
        // Save all scroll positions
        document.querySelectorAll('.matrix-scroll').forEach((container, index) => {
            saveScrollPosition(`template-${index}`);
        });
        
        fetch('/api/dashboard_data')
            .then(response => response.json())
            .then(data => {
                // Update only changed elements
                updateDashboardData(data);
                
                // Restore scroll positions
                setTimeout(() => {
                    document.querySelectorAll('.matrix-scroll').forEach((container, index) => {
                        restoreScrollPosition(`template-${index}`);
                    });
                }, 10);
                
                if (manual) {
                    const btn = document.getElementById('refreshBtn');
                    btn.classList.remove('loading');
                    showNotification('Dashboard refreshed', 'success');
                }
            });
    }
    
    function updateDashboardData(data) {
        // Smart update logic - only update changed cells
        // This prevents losing scroll position and modal states
        // ... (implementation details)
    }
    
    // Combination Management
    function showCombinationDetails(combinationId) {
        console.log('Showing details for combination:', combinationId);
        
        // Check if currently running - show live status instead
        const cell = document.querySelector(`[data-combination-id="${combinationId}"]`);
        if (cell && cell.classList.contains('status-running')) {
            showLiveStatus(combinationId);
            return;
        }
        
        fetch(`/api/combination_details/${combinationId}`)
            .then(response => response.json())
            .then(data => {
                console.log('Combination details data:', data);
                
                if (data.error) {
                    showNotification(data.error, 'error');
                    return;
                }
                
                const info = data.combination_info || {};
                document.getElementById('detailsTitle').textContent = 
                    `${info.species_file || 'Unknown'} - ${(info.model || 'Unknown').split('/').pop()}`;
                    
                const content = generateDetailsContent(data);
                document.getElementById('detailsContent').innerHTML = content;
                
                showModal('detailsModal');
            })
            .catch(error => {
                console.error('Error fetching combination details:', error);
                showNotification('Failed to load details', 'error');
            });
    }
    
    function showLiveStatus(combinationId) {
        liveStatusTracking = combinationId;
        
        fetch(`/api/combination_details/${combinationId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) return;
                
                document.getElementById('liveStatusTitle').textContent = 
                    `Live: ${data.species_file} - ${data.model.split('/').pop()}`;
                
                const content = generateLiveStatusContent(data);
                document.getElementById('liveStatusContent').innerHTML = content;
                
                showModal('liveStatusModal');
            });
    }
    
    function generateDetailsContent(data) {
        // Generate detailed view content
        const info = data.combination_info || {};
        const results = data.species_results || [];
        
        let html = `
            <div class="card mb-3">
                <h4>Summary</h4>
                <div class="summary-grid">
                    <div>Total: ${info.total_species || 0}</div>
                    <div>Success: ${info.successful_species || 0}</div>
                    <div>Failed: ${info.failed_species || 0}</div>
                    <div>Timeouts: ${info.timeout_species || 0}</div>
                </div>
                ${info.user_template && info.user_template.includes('phenotype') ? `
                    <div style="margin-top: 16px; text-align: center;">
                        <button onclick="reparsePhenotypeData(${info.id})" class="btn btn-primary" style="margin-right: 8px;">
                            <i class="fas fa-sync"></i> Re-parse Phenotype Data
                        </button>
                        ${info.failed_species && info.failed_species > 0 ? `
                            <button onclick="rerunAllFailed(${info.id})" class="btn btn-secondary">
                                <i class="fas fa-redo"></i> Re-run Failed Samples
                            </button>
                        ` : ''}
                        <div style="margin-top: 8px; font-size: 11px; color: var(--text-secondary);">
                            Re-parse: Extract phenotype fields from existing responses | Re-run: Process failed samples with LLM again
                        </div>
                    </div>
                ` : ''}
            </div>
        `;
        
        if (results.length > 0) {
            html += `
                <div class="card">
                    <h4>Results</h4>
                    <div class="results-content">
                        <div class="species-list">
            `;
            
            results.forEach(result => {
                const statusClass = result.status === 'completed' ? 'success' : 'failed';
                html += `
                    <div class="species-result ${statusClass}">
                        <div class="species-result-header">
                            <div>
                                <strong>${result.binomial_name}</strong> - ${result.status}
                                ${result.error ? `<div class="error-msg">${result.error}</div>` : ''}
                            </div>
                            <div class="species-actions">
                                ${result.status === 'failed' ? `
                                    <button onclick="rerunSpecies(${info.id}, '${result.binomial_name}')" 
                                            class="btn-small btn-retry" title="Re-run this species">
                                        Retry
                                    </button>
                                ` : ''}
                                ${result.result ? `
                                    <button data-species="${result.binomial_name}" 
                                            data-raw='${result.result.replace(/'/g, "&#39;")}' 
                                            data-parsed='${JSON.stringify(result.phenotypes || (result.knowledge_group ? {knowledge_group: result.knowledge_group} : {})).replace(/'/g, "&#39;")}'
                                            onclick="showRawResponseFromData(this)" 
                                            class="btn-small btn-view" title="View raw response">
                                        View
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                        </div>
                    </div>
                </div>
            `;
        }
        
        return html;
    }
    
    function generateLiveStatusContent(data) {
        return `
            <div class="card mb-3">
                <h4>Processing Status</h4>
                <div class="progress-bar" style="height: 20px;">
                    <div class="progress-fill" style="width: ${(data.summary.successful / data.summary.total * 100)}%"></div>
                </div>
                <div class="text-center mt-2">
                    ${data.summary.submitted} / ${data.summary.total} submitted
                </div>
            </div>
            
            <h4>Species Status</h4>
            <div class="live-status-grid" id="liveStatusGrid">
                ${generateLiveStatusGrid(data)}
            </div>
        `;
    }
    
    function generateResultsList(data) {
        // Generate results list HTML
        // ... (implementation details)
        return '<div>Results will be displayed here</div>';
    }
    
    function generateLiveStatusGrid(data) {
        // Generate live status grid HTML
        // ... (implementation details)
        return '<div>Live status will be displayed here</div>';
    }
    
    function updateLiveStatus(logData) {
        // Update live status display
        // ... (implementation details)
    }
    
    // Action Functions
    function startCombination(id) {
        fetch(`/api/start_combination/${id}`, {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Job started', 'success');
                    setTimeout(() => location.reload(), 500);
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            });
    }
    
    function pauseCombination(id) {
        fetch(`/api/pause_combination/${id}`, {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Job paused', 'success');
                    setTimeout(() => location.reload(), 500);
                }
            });
    }
    
    function stopCombination(id) {
        if (confirm('Are you sure you want to stop this job?')) {
            fetch(`/api/stop_combination/${id}`, {method: 'POST'})
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Job stopped', 'success');
                        setTimeout(() => location.reload(), 500);
                    }
                });
        }
    }
    
    function restartCombination(id) {
        fetch(`/api/restart_combination/${id}`, {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Job restarted', 'success');
                    setTimeout(() => location.reload(), 500);
                }
            });
    }
    
    function createAndStartCombination(species_file, model, system_template, user_template) {
        // Check API key status first
        fetch('/api/api_key_status')
            .then(response => response.json())
            .then(data => {
                if (!data.configured) {
                    showNotification('API key not configured. Please configure it in Settings.', 'error');
                    return;
                }
                
                const templateName = document.querySelector('.template-tab.active').textContent.trim();
                
                showNotification('Creating combination...', 'info');
                
                fetch('/api/create_combination', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        species_file: species_file,
                        model: model,
                        system_template: system_template,
                        user_template: user_template
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Combination created successfully!', 'success');
                        // Refresh the page to show the new combination
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    } else {
                        showNotification('Error creating combination: ' + (data.error || 'Unknown error'), 'error');
                    }
                })
                .catch(error => {
                    console.error('Error creating combination:', error);
                    showNotification('Failed to create combination', 'error');
                });
            })
            .catch(error => {
                console.error('Error checking API key:', error);
                showNotification('Failed to check API key status', 'error');
            });
    }
    
    function deleteCombination(id) {
        if (confirm('Are you sure you want to delete this combination and all its results?')) {
            fetch(`/api/delete_combination/${id}`, {method: 'DELETE'})
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Combination deleted', 'success');
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    }
                });
        }
    }
    
    function reparsePhenotypeData(combinationId) {
        if (confirm('This will re-parse all raw phenotype responses for this combination. Continue?')) {
            showNotification('Re-parsing phenotype data...', 'info');
            
            fetch(`/api/reparse_phenotype_data/${combinationId}`, {method: 'POST'})
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(`Successfully re-parsed ${data.updated} results`, 'success');
                        // Close modal and refresh details
                        closeModal('detailsModal');
                        setTimeout(() => {
                            showCombinationDetails(combinationId);
                        }, 500);
                    } else {
                        showNotification(data.message || 'Error re-parsing data', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error re-parsing phenotype data:', error);
                    showNotification('Failed to re-parse phenotype data', 'error');
                });
        }
    }
    
    function rerunAllFailed(combinationId) {
        if (confirm('This will re-run all failed samples for this combination using the LLM. This may take time and consume API credits. Continue?')) {
            showNotification('Re-running failed samples...', 'info');
            
            fetch(`/api/rerun_all_failed/${combinationId}`, {method: 'POST'})
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(`Re-running ${data.failed_count} failed samples...`, 'success');
                        // Close modal and refresh page to show updated status
                        closeModal('detailsModal');
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    } else {
                        showNotification(data.error || 'Error re-running failed samples', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error re-running failed samples:', error);
                    showNotification('Failed to re-run failed samples', 'error');
                });
        }
    }
    
    // Model Management
    function addModel() {
        // Load available models
        refreshModels();
        showModal('addModelModal');
    }
    
    function refreshModels() {
        const dropdown = document.getElementById('modelDropdown');
        dropdown.innerHTML = '<option value="">Loading...</option>';
        
        fetch('/api/get_openrouter_models')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    dropdown.innerHTML = '<option value="">Error loading models</option>';
                    return;
                }
                
                dropdown.innerHTML = '<option value="">Select a model...</option>';
                data.models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = `${model.name} ($${model.pricing.prompt}/1K)`;
                    option.dataset.info = JSON.stringify(model);
                    dropdown.appendChild(option);
                });
                
                document.getElementById('modelCount').textContent = data.models.length;
            });
    }
    
    function switchInputMethod(method) {
        document.querySelectorAll('.input-tab').forEach(tab => {
            tab.classList.toggle('active', tab.id === method + 'Tab');
        });
        
        document.querySelectorAll('.input-method').forEach(m => {
            m.classList.toggle('active', m.id === method + 'Method');
        });
        
        // Reset validation
        document.getElementById('addModelBtn').disabled = true;
        document.getElementById('modelValidationStatus').style.display = 'none';
    }
    
    // Set up event listeners after DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        const modelDropdown = document.getElementById('modelDropdown');
        if (modelDropdown) {
            modelDropdown.addEventListener('change', function() {
                const selected = this.options[this.selectedIndex];
                const infoDiv = document.getElementById('selectedModelInfo');
                const addBtn = document.getElementById('addModelBtn');
                
                if (selected.value) {
                    const info = JSON.parse(selected.dataset.info);
                    infoDiv.innerHTML = `
                        <strong>${info.name}</strong><br>
                        Context: ${info.context_length.toLocaleString()} tokens<br>
                        Pricing: $${info.pricing.prompt}/1K prompt, $${info.pricing.completion}/1K completion
                    `;
                    infoDiv.style.display = 'block';
                    addBtn.disabled = false;
                } else {
                    infoDiv.style.display = 'none';
                    addBtn.disabled = true;
                }
            });
        }
        
        const newModelInput = document.getElementById('newModelInput');
        if (newModelInput) {
            newModelInput.addEventListener('input', function() {
                const value = this.value.trim();
                const addBtn = document.getElementById('addModelBtn');
                const status = document.getElementById('modelValidationStatus');
                
                if (!value) {
                    addBtn.disabled = true;
                    status.style.display = 'none';
                    return;
                }
                
                // Validate model format
                if (value.includes('/')) {
                    status.textContent = 'Validating...';
                    status.className = 'validation-status loading';
                    status.style.display = 'block';
                    
                    // Validate with API
                    fetch('/api/validate_model', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({model: value})
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.valid) {
                            status.textContent = 'Valid model';
                            status.className = 'validation-status success';
                            addBtn.disabled = false;
                        } else {
                            status.textContent = data.error || 'Invalid model';
                            status.className = 'validation-status error';
                            addBtn.disabled = true;
                        }
                    });
                } else {
                    status.textContent = 'Format: provider/model-name';
                    status.className = 'validation-status error';
                    status.style.display = 'block';
                    addBtn.disabled = true;
                }
            });
        }
    });
    
    function confirmAddModel() {
        const dropdownMethod = document.getElementById('dropdownMethod').classList.contains('active');
        const model = dropdownMethod 
            ? document.getElementById('modelDropdown').value 
            : document.getElementById('newModelInput').value.trim();
        
        if (!model) return;
        
        fetch('/api/add_model', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({model: model})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                closeModal('addModelModal');
                showNotification('Model added', 'success');
                // Force a full page reload to show new column
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                showNotification('Error: ' + data.error, 'error');
            }
        });
    }
    
    function deleteModel(model) {
        if (confirm(`Remove model ${model.split('/').pop()} from dashboard?`)) {
            fetch('/api/delete_model', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({model: model})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Model removed', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                }
            });
        }
    }
    
    // Species File Management
    function addSpeciesFile() {
        showModal('addSpeciesModal');
    }
    
    function confirmAddSpecies() {
        const file = document.getElementById('newSpeciesSelect').value;
        
        if (!file) {
            showNotification('Please select a species file', 'error');
            return;
        }
        
        fetch('/api/add_species_file', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({species_file: file})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                closeModal('addSpeciesModal');
                showNotification('Species file added', 'success');
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                showNotification('Error: ' + data.error, 'error');
            }
        });
    }
    
    function deleteSpeciesFile(file) {
        if (confirm(`Remove species file ${file} from dashboard?`)) {
            fetch('/api/delete_species_file', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({species_file: file})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Species file removed', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                }
            });
        }
    }
    
    // Template Manager
    function openTemplateManager() {
        // Implementation for template manager
        showNotification('Template manager coming soon', 'info');
    }
    
    // Re-run individual species
    function rerunSpecies(combinationId, speciesName) {
        if (confirm(`Re-run processing for ${speciesName}?`)) {
            showNotification(`Re-running ${speciesName}...`, 'info');
            
            fetch('/api/rerun_failed_species', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    combination_id: combinationId,
                    species_name: speciesName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    // Refresh the details modal
                    setTimeout(() => {
                        showCombinationDetails(combinationId);
                    }, 1000);
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error re-running species:', error);
                showNotification('Failed to re-run species', 'error');
            });
        }
    }
    
    // Show raw response modal from data attributes
    function showRawResponseFromData(button) {
        const speciesName = button.getAttribute('data-species');
        const rawResponse = button.getAttribute('data-raw').replace(/&#39;/g, "'");
        let parsedData = {};
        
        try {
            parsedData = JSON.parse(button.getAttribute('data-parsed').replace(/&#39;/g, "'"));
        } catch (e) {
            console.error('Error parsing data:', e);
        }
        
        showRawResponse(speciesName, rawResponse, parsedData);
    }
    
    // Show raw response modal
    function showRawResponse(speciesName, rawResponse, parsedData) {
        document.getElementById('rawResponseTitle').textContent = `Raw Response - ${speciesName}`;
        document.getElementById('rawResponseText').textContent = rawResponse || 'No raw response available';
        
        // Generate parsed data display
        let parsedHtml = '<div class="parsed-data-grid">';
        
        if (parsedData && typeof parsedData === 'object') {
            for (const [key, value] of Object.entries(parsedData)) {
                if (value !== null && value !== undefined && value !== '') {
                    const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    parsedHtml += `
                        <div class="parsed-field">
                            <div class="field-label">${label}</div>
                            <div class="field-value">${value}</div>
                        </div>
                    `;
                }
            }
        } else {
            parsedHtml += '<div class="text-muted">No parsed data available</div>';
        }
        
        parsedHtml += '</div>';
        document.getElementById('parsedResponseData').innerHTML = parsedHtml;
        
        // Reset to raw tab
        switchResponseTab('raw');
        showModal('rawResponseModal');
    }
    
    // Switch response tab
    function switchResponseTab(tab) {
        // Update tabs
        document.querySelectorAll('.response-tab').forEach(t => {
            t.classList.toggle('active', t.id === tab + 'Tab');
        });
        
        // Update content
        document.querySelectorAll('.response-content').forEach(c => {
            c.classList.toggle('active', c.id === tab + 'ResponseContent');
        });
    }
    
    // Notification System
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.textContent = message;
        
        // Add to page
        document.body.appendChild(notification);
        
        // Animate in
        setTimeout(() => notification.classList.add('show'), 10);
        
        // Remove after 3 seconds
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
    
    // Add notification styles
    const notificationStyles = document.createElement('style');
    notificationStyles.textContent = `
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            background: var(--gray-900);
            color: var(--white);
            border-radius: 6px;
            font-size: 12px;
            z-index: 3000;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .notification-success {
            background: var(--accent-secondary);
        }
        
        .notification-error {
            background: var(--accent-error);
        }
        
        .notification-info {
            background: var(--accent-primary);
        }
        
        .api-warning {
            background: var(--accent-warning);
            border-left: 4px solid var(--accent-error);
            margin-bottom: 20px;
        }
        
        .api-warning h3 {
            color: var(--gray-900);
            margin-bottom: 10px;
        }
        
        .api-warning p {
            color: var(--gray-700);
            margin-bottom: 15px;
        }
        
        .api-warning button {
            background: var(--gray-900);
            color: var(--white);
        }
    `;
    document.head.appendChild(notificationStyles);
</script>
{% endblock %} 