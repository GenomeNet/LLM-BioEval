{% extends "admin_base.html" %}

{% block title %}Dashboard - MicrobeLLM Admin{% endblock %}

{% block body_class %}page-dashboard{% endblock %}

{% block content %}
    <div class="page-header">
        <h1 class="page-title">Processing Dashboard</h1>
        <p class="page-subtitle">Manage and monitor your microbial prediction jobs</p>
    </div>
    
    <!-- API Key Warning -->
    <div id="apiKeyWarning" class="api-warning" style="display: none;">
        <h3>⚠️ API Key Not Configured</h3>
        <p>OpenRouter API key is not set. Jobs will fail without a valid API key.</p>
        <button onclick="toggleSettings()" class="btn btn-primary">Configure API Key</button>
    </div>

    <div class="dashboard-header">
        <div class="dashboard-controls">
            <button onclick="refreshDashboard(true)" class="btn btn-secondary" id="refreshBtn">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </div>

    {% if dashboard_data.matrix %}
        <!-- Template Navigation -->
        <div class="template-tabs">
            {% set templates = dashboard_data.template_display_info %}
            {% for template_info in templates %}
                {% set i = loop.index0 %}
                <button class="template-tab {% if i == 0 %}active{% endif %}"
                        onclick="showTemplate({{ i }})"
                        id="tab-{{ i }}"
                        data-tooltip="{{ template_info.description }} ({{ template_info.template_type }} template)">
                    {{ template_info.display_name }}
                </button>
            {% endfor %}
            <button class="template-tab" 
                    onclick="openTemplateManager()" 
                    id="template-manage-btn"
                    data-tooltip="Manage template names">
                <i class="fas fa-edit"></i>
            </button>
        </div>

        <!-- Template Sections -->
        {% for template_info in dashboard_data.template_display_info %}
            {% set sys_template = template_info.system_template %}
            {% set user_template = template_info.user_template %}
            {% set i = loop.index0 %}
            {% set file_template_name = sys_template.split('/')[-1].replace('.txt', '') %}
            <div class="template-section {% if i == 0 %}active{% endif %}" id="template-{{ i }}">
                <div class="template-info card mb-3">
                    <p class="text-muted mb-1">{{ template_info.description }}</p>
                    <div class="text-small">
                        System: <a href="/templates#{{ file_template_name }}" target="_blank">{{ sys_template.split('/')[-1] }}</a> | 
                        User: <a href="/templates#{{ file_template_name }}" target="_blank">{{ user_template.split('/')[-1] }}</a>
                    </div>
                </div>

                <div class="matrix-container">
                    <button class="scroll-to-add-btn" onclick="scrollToAddColumn({{ i }})" title="Scroll to add column">
                        <i class="fas fa-arrow-right"></i> Add Column
                    </button>
                    <div class="matrix-scroll" id="matrix-scroll-{{ i }}">
                        <table class="processing-matrix">
                            <thead>
                                <tr>
                                    <th class="species-header">Species Files</th>
                                    {% for model in dashboard_data.models %}
                                    <th class="model-header">
                                        <div class="model-name">{{ model.split('/')[-1] }}</div>
                                        <button class="btn btn-ghost btn-sm" onclick="deleteModel('{{ model }}')" title="Remove model">×</button>
                                    </th>
                                    {% endfor %}
                                    <th class="add-column">
                                        <button class="btn btn-accent btn-sm" onclick="window.addModel()" title="Add model">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for species_file in dashboard_data.species_files %}
                                    <tr>
                                        <td class="species-name">
                                            <div>{{ species_file.split('/')[-1] }}</div>
                                            <button class="btn btn-ghost btn-sm" onclick="deleteSpeciesFile('{{ species_file }}')" title="Remove file">×</button>
                                        </td>
                                        {% for model in dashboard_data.models %}
                                            {% set species_name = species_file.split('/')[-1] %}
                                            {% set sys_name = sys_template.split('/')[-1] if sys_template else sys_template %}
                                            {% set usr_name = user_template.split('/')[-1] if user_template else user_template %}
                                            {% set cell_key = species_name + '|' + sys_name + '|' + usr_name %}
                                            {% set cell_data = dashboard_data.matrix.get(cell_key, {}).get('models', {}).get(model) %}
                                            <td class="matrix-cell" id="cell-{{ i }}-{{ species_file }}-{{ model }}">
                                                {% if cell_data %}
                                                    <div class="status-cell status-{{ cell_data.status }} {% if cell_data.historical %}historical{% endif %}" 
                                                         {% if cell_data.id %}onclick="showCombinationDetails({{ cell_data.id }})"{% endif %} 
                                                         data-combination-id="{{ cell_data.id or 'historical' }}">
                                                        {% if cell_data.id %}
                                                            <button class="delete-btn" onclick="event.stopPropagation(); deleteCombination({{ cell_data.id }})">&times;</button>
                                                        {% endif %}
                                                        <div class="progress-info">
                                                            <div class="progress-main">
                                                                {% if cell_data.status == 'running' %}
                                                                    <span class="progress-running">{{ cell_data.submitted }}/{{ cell_data.total }}</span>
                                                                {% elif cell_data.status in ['completed', 'failed', 'interrupted'] %}
                                                                    <span>{{ cell_data.successful }}/{{ cell_data.total }}</span>
                                                                {% else %}
                                                                    <span>{{ cell_data.status|title }}</span>
                                                                {% endif %}
                                                            </div>
                                                            {% if cell_data.total > 0 and (cell_data.successful > 0 or cell_data.failed > 0 or cell_data.timeouts > 0) %}
                                                                <div class="progress-stats">
                                                                    {% if cell_data.successful > 0 %}
                                                                        <span class="stat-success" title="{{ cell_data.successful }} successful">✓{{ cell_data.successful }}</span>
                                                                    {% endif %}
                                                                    {% if cell_data.failed > 0 %}
                                                                        <span class="stat-failed" title="{{ cell_data.failed }} failed">✗{{ cell_data.failed }}</span>
                                                                    {% endif %}
                                                                    {% if cell_data.timeouts > 0 %}
                                                                        <span class="stat-timeout" title="{{ cell_data.timeouts }} timeout">⌛{{ cell_data.timeouts }}</span>
                                                                    {% endif %}
                                                                </div>
                                                            {% endif %}
                                                        </div>
                                                        
                                                        {% if cell_data.total > 0 and (cell_data.status == 'running' or cell_data.successful > 0 or cell_data.failed > 0 or cell_data.timeouts > 0) %}
                                                            <div class="progress-bar">
                                                                <div class="progress-fill" style="width: {{ (( (cell_data.successful + cell_data.failed + cell_data.timeouts) / cell_data.total * 100)|round) }}%"></div>
                                                            </div>
                                                        {% endif %}
                                                        
                                                        <div class="cell-actions">
                                                            {% if cell_data.status == 'pending' %}
                                                                <button onclick="event.stopPropagation(); startCombination({{ cell_data.id }})" class="action-btn start-btn">Start</button>
                                                            {% elif cell_data.status == 'running' %}
                                                                <button onclick="event.stopPropagation(); pauseCombination({{ cell_data.id }})" class="action-btn pause-btn" title="Pause">Pause</button>
                                                                <button onclick="event.stopPropagation(); stopCombination({{ cell_data.id }})" class="action-btn stop-btn" title="Stop">Stop</button>
                                                            {% elif cell_data.status == 'completed' and cell_data.failed == 0 and cell_data.timeouts == 0 %}
                                                                <span class="status-label">Complete</span>
                                                            {% elif cell_data.status in ['completed', 'failed', 'interrupted'] %}
                                                                <button onclick="event.stopPropagation(); restartCombination({{ cell_data.id }})" class="action-btn start-btn">Retry</button>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                {% else %}
                                                    <div class="status-cell status-empty">
                                                        <button onclick="event.stopPropagation(); createAndStartCombination('{{ species_file }}', '{{ model }}', '{{ sys_template }}', '{{ user_template }}')" 
                                                                class="action-btn">
                                                            Create
                                                        </button>
                                                    </div>
                                                {% endif %}
                                            </td>
                                        {% endfor %}
                                        <td class="add-cell"></td>
                                    </tr>
                                {% endfor %}
                                <tr class="add-row">
                                    <td>
                                        <button class="btn btn-accent btn-sm" onclick="window.addSpeciesFile()">
                                            <i class="fas fa-plus"></i> Add File
                                        </button>
                                    </td>
                                    {% for model in dashboard_data.models %}
                                        <td></td>
                                    {% endfor %}
                                    <td></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        {% endfor %}

    {% else %}
        <div class="empty-state">
            <div class="empty-icon">
                <i class="fas fa-flask"></i>
            </div>
            <h3>No Processing Combinations Yet</h3>
            <p class="text-muted">Start by adding a species file and selecting models to process</p>
            <button onclick="window.addSpeciesFile()" class="btn btn-primary">
                <i class="fas fa-plus"></i> Add First Species File
            </button>
        </div>
    {% endif %}

    <!-- Live Status Display -->
    <div id="liveStatusModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 id="liveStatusTitle">Live Status</h3>
                <button onclick="closeModal('liveStatusModal')" class="modal-close">×</button>
            </div>
            <div class="modal-body" id="liveStatusContent">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="detailsModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 id="detailsTitle">Combination Details</h3>
                <button onclick="closeModal('detailsModal')" class="modal-close">×</button>
            </div>
            <div class="modal-body" id="detailsContent">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Add Model Modal -->
    <div id="addModelModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Model</h3>
                <button onclick="closeModal('addModelModal')" class="modal-close">×</button>
            </div>
            <div class="modal-body">
                <div class="setting-group">
                    <label class="setting-label">Model Selection</label>
                    <div class="input-tabs mb-2">
                        <button class="input-tab active" onclick="switchInputMethod('dropdown')" id="dropdownTab">
                            Browse
                        </button>
                        <button class="input-tab" onclick="switchInputMethod('manual')" id="manualTab">
                            Manual
                        </button>
                    </div>
                    
                    <div id="dropdownMethod" class="input-method active">
                        <div class="input-group">
                            <select id="modelDropdown" class="form-control">
                                <option value="">Loading models...</option>
                            </select>
                            <button onclick="refreshModels()" class="btn btn-ghost btn-sm" title="Refresh">
                                <i class="fas fa-sync"></i>
                            </button>
                        </div>
                        <small class="text-muted mt-1">
                            <span id="modelCount">0</span> models available
                        </small>
                        <div id="selectedModelInfo" class="model-info mt-2" style="display: none;"></div>
                    </div>
                    
                    <div id="manualMethod" class="input-method">
                        <input type="text" id="newModelInput" class="form-control" 
                               placeholder="e.g., anthropic/claude-3-haiku">
                        <small class="text-muted mt-1">
                            Enter the full model name from <a href="https://openrouter.ai/models" target="_blank">OpenRouter</a>
                        </small>
                        <div id="modelValidationStatus" class="validation-status mt-2" style="display: none;"></div>
                    </div>
                </div>
                
                <div class="mt-3" style="text-align: right;">
                    <button onclick="closeModal('addModelModal')" class="btn">Cancel</button>
                    <button id="addModelBtn" onclick="confirmAddModel()" class="btn btn-primary" disabled>Add Model</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Species Modal -->
    <div id="addSpeciesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Species File</h3>
                <button onclick="closeModal('addSpeciesModal')" class="modal-close">×</button>
            </div>
            <div class="modal-body">
                <div class="setting-group">
                    <label class="setting-label">Select Species File</label>
                    <select id="newSpeciesSelect" class="form-control">
                        <option value="">Select a file...</option>
                        {% for file in dashboard_data.available_species_files %}
                            <option value="{{ file }}">{{ file }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mt-3" style="text-align: right;">
                    <button onclick="closeModal('addSpeciesModal')" class="btn">Cancel</button>
                    <button onclick="confirmAddSpecies()" class="btn btn-primary">Add File</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Raw Response Modal -->
    <div id="rawResponseModal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h3 id="rawResponseTitle">Raw Response</h3>
                <button onclick="closeModal('rawResponseModal')" class="modal-close">×</button>
            </div>
            <div class="modal-body">
                <div class="response-tabs">
                    <button class="response-tab active" onclick="switchResponseTab('raw')" id="rawTab">
                        Raw Response
                    </button>
                    <button class="response-tab" onclick="switchResponseTab('parsed')" id="parsedTab">
                        Parsed Data
                    </button>
                </div>
                
                <div id="rawResponseContent" class="response-content active">
                    <pre id="rawResponseText"></pre>
                </div>
                
                <div id="parsedResponseContent" class="response-content">
                    <div id="parsedResponseData"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block scripts %}
<style>
    /* CSS Variables for dashboard */
    :root {
        --white: #ffffff;
        --blue-600: #2563eb;
        --green-600: #059669;
        --gray-600: #4b5563;
        --gray-700: #374151;
        --gray-900: #111827;
        --border-color: #e5e7eb;
        --bg-secondary: #f9fafb;
        --text-primary: #111827;
        --text-secondary: #6b7280;
        --accent-primary: #3b82f6;
        --accent-secondary: #92cdb6;
        --accent-error: #ef4444;
        --accent-warning: #f59e0b;
    }
    
    /* Dashboard specific styles */
    .dashboard-header {
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    /* Template section visibility */
    .template-section {
        display: none;
    }
    
    .template-section.active {
        display: block;
    }
    
    .dashboard-controls {
        display: flex;
        gap: 8px;
        align-items: center;
    }
    
    .template-info {
        background: var(--bg-secondary);
        padding: 16px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
    }
    
    .cell-actions {
        display: flex;
        gap: 4px;
        margin-top: 4px;
    }
    
    .status-label {
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-secondary);
    }
    
    .progress-running {
        animation: pulse 1s ease-in-out infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }
    
    .text-success { color: var(--accent-secondary); }
    .text-error { color: var(--accent-error); }
    .text-warning { color: var(--accent-warning); }
    
    .api-key-input-group {
        display: flex;
        gap: 8px;
        align-items: center;
    }
    
    .api-key-input-group input {
        flex: 1;
    }
    
    .queue-info {
        padding: 12px;
        background: var(--bg-secondary);
        border-radius: 6px;
        text-align: center;
        font-weight: 600;
    }
    
    .input-tabs {
        display: flex;
        gap: 2px;
        background: var(--bg-secondary);
        padding: 2px;
        border-radius: 6px;
    }
    
    .input-tab {
        flex: 1;
        padding: 6px 12px;
        background: transparent;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 11px;
        font-weight: 500;
        color: var(--text-secondary);
        transition: all 0.2s;
    }
    
    .input-tab:hover {
        color: var(--text-primary);
    }
    
    .input-tab.active {
        background: var(--white);
        color: var(--text-primary);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .input-method {
        display: none;
    }
    
    .input-method.active {
        display: block;
    }
    
    .model-info {
        background: var(--bg-secondary);
        padding: 12px;
        border-radius: 6px;
        font-size: 11px;
        line-height: 1.5;
    }
    
    .validation-status {
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 500;
    }
    
    .validation-status.loading {
        background: var(--bg-secondary);
        color: var(--text-secondary);
    }
    
    .validation-status.success {
        background: var(--accent-secondary);
        color: var(--white);
    }
    
    .validation-status.error {
        background: var(--accent-error);
        color: var(--white);
    }
    
    /* Live status display */
    .live-status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 12px;
        margin-top: 16px;
    }
    
    .live-status-item {
        padding: 12px;
        background: var(--bg-secondary);
        border-radius: 6px;
        text-align: center;
        transition: all 0.2s;
    }
    
    .live-status-item.processing {
        background: linear-gradient(135deg, var(--accent-secondary) 0%, transparent 70%);
        border: 1px solid var(--accent-secondary);
    }
    
    .live-status-item.success {
        background: linear-gradient(135deg, var(--accent-primary) 0%, transparent 70%);
        border: 1px solid var(--accent-primary);
    }
    
    .live-status-item.failed {
        background: linear-gradient(135deg, var(--accent-error) 0%, transparent 70%);
        border: 1px solid var(--accent-error);
    }
    
    .species-name-live {
        font-weight: 600;
        font-size: 11px;
        margin-bottom: 4px;
        font-style: italic;
    }
    
    .species-status-live {
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    /* Fix for sticky positioning */
    .processing-matrix {
        position: relative;
    }
    
    .species-header,
    .species-name {
        position: sticky;
        left: 0;
        background: var(--bg-secondary);
        z-index: 9;
    }
    
    .model-header {
        position: sticky;
        top: 0;
        background: var(--bg-secondary);
        z-index: 8;
    }
    
    .species-header {
        z-index: 10;
    }
    
    /* Improved scrolling for matrix */
    .matrix-container {
        position: relative;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: var(--white);
        margin-bottom: 24px;
    }
    
    .matrix-scroll {
        overflow: auto;
        max-height: 70vh;
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
    }
    
    /* Custom scrollbar styling */
    .matrix-scroll::-webkit-scrollbar {
        width: 12px;
        height: 12px;
    }
    
    .matrix-scroll::-webkit-scrollbar-track {
        background: var(--bg-secondary);
        border-radius: 6px;
    }
    
    .matrix-scroll::-webkit-scrollbar-thumb {
        background: var(--gray-400);
        border-radius: 6px;
        border: 2px solid var(--bg-secondary);
    }
    
    .matrix-scroll::-webkit-scrollbar-thumb:hover {
        background: var(--gray-600);
    }
    
    /* Make the add column button more visible */
    .add-column {
        position: sticky;
        right: 0;
        background: var(--bg-secondary);
        border-left: 2px solid var(--border-color);
        min-width: 60px;
        text-align: center;
        z-index: 8;
    }
    
    .add-cell {
        position: sticky;
        right: 0;
        background: var(--white);
        border-left: 2px solid var(--border-color);
        min-width: 60px;
    }
    
    /* Scroll to add button */
    .scroll-to-add-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 20;
        background: var(--accent-primary);
        color: var(--white);
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .scroll-to-add-btn:hover {
        background: var(--blue-600);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    /* Matrix cell styles */
    .matrix-cell {
        padding: 4px;
        min-width: 100px;
        max-width: 150px;
        position: relative;
        vertical-align: middle;
    }
    
    /* Status cell enhanced styles */
    .status-cell {
        padding: 8px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
        min-height: 60px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        border: 2px solid transparent;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .status-cell:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    /* Status-specific styles with better colors */
    .status-pending {
        background: #fff3cd;
        border-color: #ffeaa7;
        color: #856404;
    }
    
    /* Historical results styling */
    .status-cell.historical {
        background: #e8f4f8;
        border: 2px dashed #b0d4e3;
        cursor: default;
    }
    
    .status-cell.historical:hover {
        transform: none;
        box-shadow: none;
    }
    
    .status-running {
        background: #cce5ff;
        border-color: #b8daff;
        color: #004085;
        animation: running-pulse 2s ease-in-out infinite;
    }
    
    @keyframes running-pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.8; }
    }
    
    .status-completed {
        background: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
    }
    
    .status-failed {
        background: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
    }
    
    .status-interrupted {
        background: #e2e3e5;
        border-color: #d6d8db;
        color: #383d41;
    }
    
    .status-empty {
        background: #f8f9fa;
        border: 2px dashed #dee2e6;
        color: #6c757d;
    }
    
    /* Progress info styling */
    .progress-info {
        font-size: 11px;
        line-height: 1.3;
        text-align: center;
        width: 100%;
    }
    
    .progress-main {
        font-weight: 600;
        margin-bottom: 2px;
    }
    
    .progress-secondary {
        font-size: 10px;
        opacity: 0.8;
    }
    
    .progress-stats {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-top: 4px;
        font-size: 9px;
    }
    
    .stat-success {
        color: #28a745;
    }
    
    .stat-failed {
        color: #dc3545;
    }
    
    .stat-timeout {
        color: #ffc107;
    }
    
    /* Delete button styling */
    .delete-btn {
        position: absolute;
        top: 2px;
        right: 2px;
        width: 16px;
        height: 16px;
        border: none;
        background: rgba(255, 255, 255, 0.8);
        color: #dc3545;
        border-radius: 50%;
        font-size: 10px;
        font-weight: bold;
        cursor: pointer;
        opacity: 0;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
        padding: 0;
    }
    
    .status-cell:hover .delete-btn {
        opacity: 1;
    }
    
    .delete-btn:hover {
        background: #dc3545;
        color: white;
        transform: scale(1.1);
    }
    
    /* Progress bar */
    .progress-bar {
        width: 100%;
        height: 3px;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 2px;
        margin-top: 4px;
        overflow: hidden;
    }
    
    .progress-fill {
        height: 100%;
        background: currentColor;
        opacity: 0.6;
        transition: width 0.3s ease;
    }
    
    /* Action button for empty cells */
    .action-btn {
        font-size: 11px;
        padding: 4px 12px;
        background: #6366f1;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
    }
    
    .action-btn:hover {
        background: #4f46e5;
        transform: translateY(-1px);
    }
    
    /* Hide cell actions by default, show on hover */
    .cell-actions {
        display: none;
        margin-top: 4px;
        gap: 4px;
        justify-content: center;
    }
    
    .status-cell:hover .cell-actions {
        display: flex;
    }
    
    .action-btn.start-btn,
    .action-btn.pause-btn,
    .action-btn.stop-btn {
        font-size: 9px;
        padding: 2px 8px;
    }
    
    /* Delete buttons */
    .species-name button,
    .model-header button {
        position: absolute;
        top: 4px;
        right: 4px;
        opacity: 0;
        transition: opacity 0.2s;
    }
    
    .species-name:hover button,
    .model-header:hover button {
        opacity: 1;
    }
    
    /* Details modal styles */
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 16px;
        margin-top: 16px;
    }
    
    .summary-grid > div {
        padding: 12px;
        background: var(--bg-secondary);
        border-radius: 6px;
        text-align: center;
        font-size: 12px;
    }
    
    .species-list {
        max-height: 600px;
        overflow-y: auto;
        margin-top: 16px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 8px;
        background: #fafafa;
    }
    
    .species-result {
        padding: 8px 12px;
        margin-bottom: 8px;
        border-radius: 4px;
        font-size: 11px;
        border: 1px solid var(--border-color);
    }
    
    .species-result.success {
        background: rgba(146, 205, 182, 0.1);
        border-color: var(--accent-secondary);
    }
    
    .species-result.failed {
        background: rgba(255, 179, 186, 0.1);
        border-color: var(--accent-error);
    }
    
    .error-msg {
        margin-top: 4px;
        font-size: 10px;
        color: var(--accent-error);
    }
    
    .species-result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
    }
    
    .species-actions {
        display: flex;
        gap: 4px;
    }
    
    .btn-small {
        padding: 2px 6px;
        font-size: 9px;
        border-radius: 3px;
        border: 1px solid currentColor;
        background: transparent;
        cursor: pointer;
        transition: all 0.2s;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .btn-small:hover {
        background: currentColor;
        color: var(--white);
    }
    
    .btn-retry { color: var(--accent-warning); }
    .btn-view { color: var(--accent-primary); }
    
    .response-tabs {
        display: flex;
        gap: 2px;
        background: var(--bg-secondary);
        padding: 2px;
        border-radius: 6px;
        margin-bottom: 16px;
    }
    
    .response-tab {
        flex: 1;
        padding: 8px 16px;
        background: transparent;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 500;
        color: var(--text-secondary);
        transition: all 0.2s;
    }
    
    .response-tab:hover {
        color: var(--text-primary);
    }
    
    .response-tab.active {
        background: var(--white);
        color: var(--text-primary);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .response-content {
        display: none;
    }
    
    .response-content.active {
        display: block;
    }
    
    .response-content pre {
        background: var(--bg-secondary);
        padding: 16px;
        border-radius: 6px;
        font-size: 11px;
        line-height: 1.5;
        overflow-x: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    
    .parsed-data-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
    }
    
    .parsed-field {
        padding: 12px;
        background: var(--bg-secondary);
        border-radius: 6px;
        border-left: 3px solid var(--accent-primary);
    }
    
    .field-label {
        font-weight: 600;
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-secondary);
        margin-bottom: 4px;
    }
    
    .field-value {
        font-size: 12px;
        color: var(--text-primary);
    }
    
    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
        animation: fadeIn 0.2s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .modal-content {
        background-color: var(--white);
        margin: 50px auto;
        padding: 0;
        border-radius: 8px;
        width: 90%;
        max-width: 600px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
        from {
            transform: translateY(-20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    .modal-header {
        padding: 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
    }
    
    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--text-secondary);
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: all 0.2s;
    }
    
    .modal-close:hover {
        background: var(--bg-secondary);
        color: var(--text-primary);
    }
    
    .modal-body {
        padding: 20px;
    }
    
    /* Form controls */
    .form-control {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 14px;
        background: var(--white);
        color: var(--text-primary);
        transition: all 0.2s;
    }
    
    .form-control:focus {
        outline: none;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .form-control:disabled {
        background: var(--bg-secondary);
        color: var(--text-secondary);
        cursor: not-allowed;
    }
    
    select.form-control {
        cursor: pointer;
    }
    
    /* Button styles */
    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }
    
    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .btn-primary {
        background: var(--accent-primary);
        color: var(--white);
    }
    
    .btn-primary:hover:not(:disabled) {
        background: var(--blue-600);
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    }
    
    .btn-secondary {
        background: var(--gray-600);
        color: var(--white);
    }
    
    .btn-secondary:hover:not(:disabled) {
        background: var(--gray-700);
    }
    
    .btn-ghost {
        background: transparent;
        color: var(--text-secondary);
        border: 1px solid transparent;
    }
    
    .btn-ghost:hover:not(:disabled) {
        background: var(--bg-secondary);
        color: var(--text-primary);
    }
    
    .btn-sm {
        padding: 4px 8px;
        font-size: 11px;
    }
    
    .btn-accent {
        background: var(--accent-secondary);
        color: var(--white);
    }
    
    .btn-accent:hover:not(:disabled) {
        background: var(--green-600);
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(146, 205, 182, 0.3);
    }
    
    /* Utility classes */
    .mt-1 { margin-top: 4px; }
    .mt-2 { margin-top: 8px; }
    .mt-3 { margin-top: 16px; }
    .mb-2 { margin-bottom: 8px; }
    .mb-3 { margin-bottom: 16px; }
    .text-muted { color: var(--text-secondary); font-size: 12px; }
    .text-small { font-size: 11px; }
    
    /* Enhanced details modal styles */
    .combination-summary {
        background: var(--bg-secondary);
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .summary-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 16px;
        margin: 20px 0;
    }
    
    .stat-item {
        background: var(--white);
        padding: 16px;
        border-radius: 6px;
        text-align: center;
        border: 1px solid var(--border-color);
    }
    
    .stat-label {
        display: block;
        font-size: 11px;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
    }
    
    .stat-value {
        display: block;
        font-size: 24px;
        font-weight: 600;
        color: var(--text-primary);
    }
    
    .stat-item.success .stat-value { color: var(--accent-secondary); }
    .stat-item.failed .stat-value { color: var(--accent-error); }
    .stat-item.timeout .stat-value { color: var(--accent-warning); }
    
    .rerun-all-container {
        text-align: center;
        margin: 20px 0;
    }
    
    .btn-warning {
        background: var(--accent-warning);
        color: var(--white);
    }
    
    .btn-warning:hover {
        background: #e0a800;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
    }
    
    .template-info {
        font-size: 12px;
        color: var(--text-secondary);
        margin-top: 16px;
    }
    
    /* Species results styles */
    .species-results {
        margin-top: 20px;
    }
    
    .results-section {
        margin-bottom: 24px;
    }
    
    .section-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 12px;
        padding: 8px 12px;
        border-radius: 6px;
        display: inline-block;
    }
    
    .section-title.failed {
        background: rgba(239, 68, 68, 0.1);
        color: var(--accent-error);
    }
    
    .section-title.timeout {
        background: rgba(245, 158, 11, 0.1);
        color: var(--accent-warning);
    }
    
    .section-title.success {
        background: rgba(16, 185, 129, 0.1);
        color: var(--accent-secondary);
    }
    
    .species-list {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        overflow: hidden;
    }
    
    .species-item {
        border-bottom: 1px solid var(--border-color);
        background: var(--white);
    }
    
    .species-item:last-child {
        border-bottom: none;
    }
    
    .species-header {
        padding: 12px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        transition: background 0.2s;
    }
    
    .species-header:hover {
        background: var(--bg-secondary);
    }
    
    .species-name {
        font-weight: 500;
        font-style: italic;
        flex: 1;
    }
    
    .species-status {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin: 0 8px;
    }
    
    .species-status.success {
        background: var(--accent-secondary);
        color: var(--white);
    }
    
    .species-status.failed {
        background: var(--accent-error);
        color: var(--white);
    }
    
    .species-status.timeout {
        background: var(--accent-warning);
        color: var(--white);
    }
    
    .toggle-icon {
        font-family: monospace;
        font-size: 14px;
        color: var(--text-secondary);
    }
    
    .species-details {
        padding: 16px;
        background: var(--bg-secondary);
        border-top: 1px solid var(--border-color);
    }
    
    .error-info, .raw-response, .knowledge-level, .phenotypes {
        margin-bottom: 12px;
    }
    
    .error-message {
        margin-top: 4px;
        padding: 8px;
        background: rgba(239, 68, 68, 0.1);
        border-radius: 4px;
        font-size: 12px;
        color: var(--accent-error);
    }
    
    .response-text {
        margin-top: 4px;
        padding: 8px;
        background: var(--white);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 11px;
        font-family: var(--font-mono);
        white-space: pre-wrap;
        word-break: break-word;
        max-height: 200px;
        overflow-y: auto;
    }
    
    .llm-response-details {
        margin-top: 8px;
    }
    
    .llm-response-details summary {
        cursor: pointer;
        color: var(--primary);
        font-size: 12px;
    }
    
    .llm-response-details pre {
        margin-top: 8px;
        max-height: 400px;
        overflow-y: auto;
    }
    
    .rerun-container {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid var(--border-color);
    }
    
    /* Knowledge level styles */
    .knowledge-value {
        font-weight: 600;
        padding: 4px 8px;
        border-radius: 4px;
        display: inline-block;
        font-size: 12px;
    }
    
    .knowledge-value.knowledge-limited {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    
    .knowledge-value.knowledge-moderate {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }
    
    .knowledge-value.knowledge-extensive {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .knowledge-value.knowledge-na {
        background-color: #e2e3e5;
        color: #6c757d;
        border: 1px solid #d6d8db;
    }
    
    .phenotype-list {
        margin-top: 4px;
        font-size: 12px;
        line-height: 1.5;
    }
    
    .no-results {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
    }
</style>

<script>
    // Define all functions in global scope immediately
    
    // Model Management
    window.addModel = function() {
        console.log('addModel function called from window');
        
        // Check if modal exists
        const modal = document.getElementById('addModelModal');
        if (!modal) {
            console.error('addModelModal not found in DOM');
            alert('Error: Modal not found. Please refresh the page.');
            return;
        }
        
        console.log('Modal found, refreshing models...');
        
        // Load available models
        window.refreshModels();
        window.showModal('addModelModal');
    };
    
    // Species File Management
    window.addSpeciesFile = function() {
        console.log('addSpeciesFile function called from window');
        window.showModal('addSpeciesModal');
    };
    
    // Modal helper functions
    window.showModal = function(modalId) {
        console.log('showModal called for:', modalId);
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
            console.log('Modal displayed');
        } else {
            console.error('Modal not found:', modalId);
            alert('Modal not found: ' + modalId);
        }
    };
    
    window.closeModal = function(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    };
    
    // Refresh models function
    window.refreshModels = function() {
        console.log('refreshModels called');
        const dropdown = document.getElementById('modelDropdown');
        if (!dropdown) {
            console.error('modelDropdown not found');
            return;
        }
        
        dropdown.innerHTML = '<option value="">Loading...</option>';
        
        fetch('/api/get_openrouter_models')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    dropdown.innerHTML = '<option value="">Error loading models</option>';
                    return;
                }
                
                dropdown.innerHTML = '<option value="">Select a model...</option>';
                data.models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = `${model.name} ($${model.pricing.prompt}/1K)`;
                    option.dataset.info = JSON.stringify(model);
                    dropdown.appendChild(option);
                });
                
                document.getElementById('modelCount').textContent = data.models.length;
            })
            .catch(error => {
                console.error('Error fetching models:', error);
                dropdown.innerHTML = '<option value="">Error loading models</option>';
            });
    };
    
    // Add error handler
    window.addEventListener('error', function(event) {
        console.error('JavaScript error:', event.error);
        console.error('At:', event.filename, 'line:', event.lineno, 'col:', event.colno);
    });
    
    // Initialize Socket.IO connection
    const socket = io();
    
    console.log('Dashboard script loaded. Functions available:');
    console.log('- window.addModel:', typeof window.addModel);
    console.log('- window.addSpeciesFile:', typeof window.addSpeciesFile);
    console.log('- window.showModal:', typeof window.showModal);
    
    // State management
    let activeTemplateIndex = 0;
    let liveStatusTracking = null;
    let autoRefreshEnabled = true;
    let lastUpdateTime = Date.now();
    
    // Scroll position management
    const scrollPositions = {};
    
    function saveScrollPosition(key) {
        const container = document.querySelector(`#${key.replace('template-', 'matrix-scroll-')}`);
        if (container) {
            scrollPositions[key] = {
                left: container.scrollLeft,
                top: container.scrollTop
            };
        }
    }
    
    function restoreScrollPosition(key) {
        const container = document.querySelector(`#${key.replace('template-', 'matrix-scroll-')}`);
        const position = scrollPositions[key];
        if (container && position) {
            container.scrollLeft = position.left;
            container.scrollTop = position.top;
        }
    }
    
    socket.on('connect', function() {
        console.log('Connected to server');
        checkApiKeyStatus();
    });
    
    socket.on('job_update', function(data) {
        console.log('Job update received:', data);
        // Update cell directly with WebSocket data instead of making API call
        updateCellProgress(data.combination_id, data);
        updateCellStatusClass(data.combination_id, data.status);
        updateCellActions(data.combination_id, data);
    });
    
    socket.on('progress_update', function(data) {
        // Real-time progress updates
        updateCellProgress(data.combination_id, data);
    });
    
    socket.on('log_message', function(data) {
        // Update live status if modal is open
        if (liveStatusTracking === data.combination_id) {
            updateLiveStatus(data);
        }
    });
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Dashboard DOM loaded');
        
        // Check API key status
        fetch('/api/api_key_status')
            .then(response => response.json())
            .then(data => {
                if (!data.configured) {
                    document.getElementById('apiKeyWarning').style.display = 'block';
                }
            });
        
        // Initialize template tabs
        const savedTab = localStorage.getItem('activeTemplateTab');
        if (savedTab !== null && document.getElementById('tab-' + savedTab)) {
            showTemplate(parseInt(savedTab));
        } else {
            // Make sure at least the first tab is active
            showTemplate(0);
        }
        
        // Load settings
        loadSettings();
        
        // Set up auto-save scroll positions
        document.querySelectorAll('.matrix-scroll').forEach((container, index) => {
            container.addEventListener('scroll', () => {
                saveScrollPosition(`template-${index}`);
            });
        });
        
        // Restore scroll positions
        setTimeout(() => {
            document.querySelectorAll('.matrix-scroll').forEach((container, index) => {
                restoreScrollPosition(`template-${index}`);
            });
        }, 100);
        
        // Debug: Check if modals exist
        console.log('addModelModal exists:', !!document.getElementById('addModelModal'));
        console.log('addSpeciesModal exists:', !!document.getElementById('addSpeciesModal'));
        
        // Debug: Add click listener to all add buttons
        document.querySelectorAll('[onclick*="addModel"]').forEach(btn => {
            console.log('Found add model button:', btn);
        });
    });
    
    // Template management
    function showTemplate(index) {
        console.log('Switching to template tab:', index);
        activeTemplateIndex = index;
        
        // Save current scroll position
        const currentActive = document.querySelector('.template-section.active');
        if (currentActive) {
            const currentScroll = currentActive.querySelector('.matrix-scroll');
            if (currentScroll) {
                const currentIndex = currentActive.id.split('-')[1];
                saveScrollPosition(`template-${currentIndex}`);
            }
        }
        
        // Update tabs - exclude the manage button
        const tabs = document.querySelectorAll('.template-tab:not(#template-manage-btn)');
        tabs.forEach((tab, i) => {
            if (i === index) {
                tab.classList.add('active');
            } else {
                tab.classList.remove('active');
            }
        });
        
        // Update sections
        const sections = document.querySelectorAll('.template-section');
        sections.forEach((section, i) => {
            if (i === index) {
                section.classList.add('active');
            } else {
                section.classList.remove('active');
            }
        });
        
        // Save preference
        localStorage.setItem('activeTemplateTab', index);
        
        // Restore scroll position for new tab
        setTimeout(() => {
            restoreScrollPosition(`template-${index}`);
        }, 10);
    }
    
    // API Key Management
    function checkApiKeyStatus() {
        fetch('/api/api_key_status')
            .then(response => response.json())
            .then(data => {
                const statusEl = document.getElementById('apiStatus');
                const textEl = document.getElementById('apiStatusText');
                
                if (data.status === 'configured') {
                    statusEl.classList.add('active');
                    statusEl.classList.remove('error');
                    textEl.textContent = 'API READY';
                } else {
                    statusEl.classList.add('error');
                    statusEl.classList.remove('active');
                    textEl.textContent = data.message || 'NO API KEY';
                }
            })
            .catch(error => {
                console.error('Error checking API key status:', error);
            });
    }
    
    function toggleApiKeyVisibility() {
        const input = document.getElementById('apiKeyInput');
        const btn = document.getElementById('toggleApiKeyBtn');
        
        if (input.type === 'password') {
            input.type = 'text';
            btn.textContent = 'Hide';
        } else {
            input.type = 'password';
            btn.textContent = 'Show';
        }
    }
    
    function updateApiKey() {
        const apiKey = document.getElementById('apiKeyInput').value.trim();
        
        if (!apiKey) {
            alert('Please enter an API key');
            return;
        }
        
        fetch('/api/set_api_key', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({api_key: apiKey})
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('API key updated. Please restart the server for changes to take effect.');
                document.getElementById('apiKeyInput').value = '';
                checkApiKeyStatus();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error updating API key:', error);
            alert('Error updating API key');
        });
    }
    
    // Settings Management
    function loadSettings() {
        fetch('/api/get_settings')
            .then(response => response.json())
            .then(data => {
                document.getElementById('rateLimitInput').value = data.rate_limit;
                document.getElementById('concurrentInput').value = data.max_concurrent_requests;
                document.getElementById('queueLength').textContent = data.queue_length;
            })
            .catch(error => console.error('Error loading settings:', error));
    }
    
    function updateRateLimit() {
        const rateLimit = parseFloat(document.getElementById('rateLimitInput').value);
        
        fetch('/api/set_rate_limit', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({requests_per_second: rateLimit})
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                showNotification('Rate limit updated', 'success');
            } else {
                showNotification('Error: ' + data.error, 'error');
            }
        });
    }
    
    function updateConcurrency() {
        const concurrency = parseInt(document.getElementById('concurrentInput').value);
        
        fetch('/api/set_rate_limit', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({max_concurrent_requests: concurrency})
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                showNotification('Concurrency updated', 'success');
            } else {
                showNotification('Error: ' + data.error, 'error');
            }
        });
    }
    
    // Cell updates without full refresh
    function updateCellStatus(combinationId) {
        fetch(`/api/combination_details/${combinationId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) return;
                
                // Find and update the specific cell
                const cell = document.querySelector(`[data-combination-id="${combinationId}"]`);
                if (cell) {
                    updateCellContent(cell, data);
                }
            });
    }
    
    function updateCellProgress(combinationId, progressData) {
        const cell = document.querySelector(`[data-combination-id="${combinationId}"]`);
        if (cell) {
            const progressMain = cell.querySelector('.progress-main');
            const progressFill = cell.querySelector('.progress-fill');
            const progressCompleted = cell.querySelector('.progress-completed');
            
            // Calculate processed count (successful + failed + timeouts)
            const processed = (progressData.successful || 0) + (progressData.failed || 0) + (progressData.timeouts || 0);
            const total = progressData.total || 0;
            
            // Only update progress if we have valid data (avoid showing 0/0 for completed jobs)
            if (total > 0) {
                if (progressMain) {
                    // For completed jobs, show final results
                    if (progressData.status === 'completed' || progressData.status === 'failed' || progressData.status === 'interrupted') {
                        progressMain.innerHTML = `<span class="progress-completed">${processed}/${total}</span>`;
                    } else {
                        progressMain.innerHTML = `<span class="progress-running">${processed}/${total}</span>`;
                    }
                }
                
                if (progressCompleted) {
                    // Show detailed breakdown for completed jobs
                    if (progressData.status === 'completed' || progressData.status === 'failed' || progressData.status === 'interrupted') {
                        const parts = [];
                        if (progressData.successful > 0) parts.push(`${progressData.successful} success`);
                        if (progressData.failed > 0) parts.push(`${progressData.failed} failed`);
                        if (progressData.timeouts > 0) parts.push(`${progressData.timeouts} timeout`);
                        progressCompleted.textContent = parts.join(', ');
                    } else {
                        progressCompleted.textContent = `${progressData.successful || 0} success`;
                    }
                }
                
                if (progressFill) {
                    const percentage = (processed / total * 100).toFixed(0);
                    progressFill.style.width = percentage + '%';
                }
            }
            
            // Update status icon if needed
            if (progressData.status) {
                updateCellStatusClass(combinationId, progressData.status);
            }
        }
    }
    
    function updateCellStatusClass(combinationId, status) {
        const cell = document.querySelector(`[data-combination-id="${combinationId}"]`);
        if (cell) {
            // Remove existing status classes
            cell.classList.remove('status-pending', 'status-running', 'status-completed', 'status-failed', 'status-interrupted');
            // Add new status class
            cell.classList.add(`status-${status}`);
        }
    }
    
    function updateCellContent(cell, data) {
        // Update cell status class
        cell.className = `status-cell status-${data.status}`;
        
        // Update progress info
        const progressInfo = cell.querySelector('.progress-info');
        if (progressInfo) {
            // Update based on new data
            // ... (implementation details)
        }
    }
    
    function updateCellActions(combinationId, data) {
        const cell = document.querySelector(`[data-combination-id="${combinationId}"]`);
        if (!cell) return;
        
        const actionsContainer = cell.querySelector('.cell-actions');
        if (!actionsContainer) return;

        let newHtml = '';
        const status = data.status;
        const failed_count = data.failed || 0;
        const timeout_count = data.timeouts || 0;

        if (status === 'pending') {
            newHtml = `<button onclick="event.stopPropagation(); startCombination(${combinationId})" class="action-btn start-btn">Start</button>`;
        } else if (status === 'running') {
            newHtml = `
                <button onclick="event.stopPropagation(); pauseCombination(${combinationId})" class="action-btn pause-btn" title="Pause">Pause</button>
                <button onclick="event.stopPropagation(); stopCombination(${combinationId})" class="action-btn stop-btn" title="Stop">Stop</button>
            `;
        } else if (status === 'completed' && failed_count === 0 && timeout_count === 0) {
            newHtml = `<span class="status-label">Complete</span>`;
        } else if (['completed', 'failed', 'interrupted'].includes(status)) {
            newHtml = `<button onclick="event.stopPropagation(); restartCombination(${combinationId})" class="action-btn start-btn">Retry</button>`;
        }
        
        actionsContainer.innerHTML = newHtml;
    }
    
    // Refresh dashboard with scroll preservation
    function refreshDashboard(manual = false) {
        if (manual) {
            const btn = document.getElementById('refreshBtn');
            btn.classList.add('loading');
        }
        
        // Save all scroll positions
        document.querySelectorAll('.matrix-scroll').forEach((container, index) => {
            saveScrollPosition(`template-${index}`);
        });
        
        fetch('/api/dashboard_data')
            .then(response => response.json())
            .then(data => {
                // Update only changed elements
                updateDashboardData(data);
                
                // Restore scroll positions
                setTimeout(() => {
                    document.querySelectorAll('.matrix-scroll').forEach((container, index) => {
                        restoreScrollPosition(`template-${index}`);
                    });
                }, 10);
                
                if (manual) {
                    const btn = document.getElementById('refreshBtn');
                    btn.classList.remove('loading');
                    showNotification('Dashboard refreshed', 'success');
                }
            });
    }
    
    function updateDashboardData(data) {
        // Smart update logic - only update changed cells
        // This prevents losing scroll position and modal states
        // ... (implementation details)
    }
    
    // Combination Management
    function showCombinationDetails(combinationId) {
        console.log('Showing details for combination:', combinationId);
        
        // Check if currently running - show live status instead
        const cell = document.querySelector(`[data-combination-id="${combinationId}"]`);
        if (cell && cell.classList.contains('status-running')) {
            showLiveStatus(combinationId);
            return;
        }
        
        fetch(`/api/combination_details/${combinationId}`)
            .then(response => response.json())
            .then(data => {
                console.log('Combination details data:', data);
                
                if (data.error) {
                    showNotification(data.error, 'error');
                    return;
                }
                
                const info = data.combination_info || {};
                document.getElementById('detailsTitle').textContent = 
                    `${info.species_file || 'Unknown'} - ${(info.model || 'Unknown').split('/').pop()}`;
                    
                const content = generateDetailsContent(data);
                document.getElementById('detailsContent').innerHTML = content;
                
                showModal('detailsModal');
            })
            .catch(error => {
                console.error('Error fetching combination details:', error);
                showNotification('Failed to load details', 'error');
            });
    }
    
    function showLiveStatus(combinationId) {
        liveStatusTracking = combinationId;
        
        fetch(`/api/combination_details/${combinationId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) return;
                
                document.getElementById('liveStatusTitle').textContent = 
                    `Live: ${data.species_file} - ${data.model.split('/').pop()}`;
                
                const content = generateLiveStatusContent(data);
                document.getElementById('liveStatusContent').innerHTML = content;
                
                showModal('liveStatusModal');
            });
    }
    
    function generateDetailsContent(data) {
        // Generate detailed view content
        const info = data.combination_info || {};
        const results = data.species_results || [];
        
        // Helper function to escape HTML
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
        
        let html = `
            <div class="combination-summary">
                <h4>Summary</h4>
                <div class="summary-stats">
                    <div class="stat-item">
                        <span class="stat-label">Total Species:</span>
                        <span class="stat-value">${info.total_species || 0}</span>
                    </div>
                    <div class="stat-item success">
                        <span class="stat-label">Success:</span>
                        <span class="stat-value">${info.successful_species || 0}</span>
                    </div>
                    <div class="stat-item failed">
                        <span class="stat-label">Failed:</span>
                        <span class="stat-value">${info.failed_species || 0}</span>
                    </div>
                    <div class="stat-item timeout">
                        <span class="stat-label">Timeouts:</span>
                        <span class="stat-value">${info.timeout_species || 0}</span>
                    </div>
                </div>
                ${info.failed_species > 0 ? `
                    <div class="rerun-all-container">
                        <button onclick="rerunAllFailed(${info.id})" class="btn btn-warning">
                            <i class="fas fa-redo"></i> Re-run All Failed (${info.failed_species})
                        </button>
                    </div>
                ` : ''}
                <div class="template-info">
                    <strong>Templates:</strong> ${info.system_template} + ${info.user_template}
                </div>
            </div>
        `;
        
        if (results.length > 0) {
            html += `<div class="species-results"><h4>Species Results</h4>`;
            
            // Group results by status
            const successful = results.filter(r => r.status === 'completed');
            const failed = results.filter(r => r.status === 'failed');
            const timeouts = results.filter(r => r.status === 'timeout');
            
            // Failed species section
            if (failed.length > 0) {
                html += `
                    <div class="results-section failed-section">
                        <h5 class="section-title failed">Failed Species (${failed.length})</h5>
                        ${failed.length > 10 ? '<p style="font-size: 12px; color: #6b7280; margin: 8px 0;">Scroll to see all ' + failed.length + ' species</p>' : ''}
                        <div class="species-list">
                `;
                
                failed.forEach(result => {
                    html += `
                        <div class="species-item failed">
                            <div class="species-header" onclick="toggleSpeciesDetails(this)">
                                <span class="species-name">${result.binomial_name}</span>
                                <span class="species-status failed">Failed</span>
                                <span class="toggle-icon">[+]</span>
                            </div>
                            <div class="species-details" style="display: none;">
                                <div class="error-info">
                                    <strong>Error:</strong>
                                    <div class="error-message">${result.error || 'No specific error message'}</div>
                                </div>
                                ${result.result ? `
                                    <div class="raw-response">
                                        <strong>Raw Response:</strong>
                                        <div class="response-text">${escapeHtml(result.result.substring(0, 500))}${result.result.length > 500 ? '...' : ''}</div>
                                    </div>
                                ` : ''}
                                <div class="rerun-container">
                                    <button onclick="rerunFailedSpecies(${info.id}, '${result.binomial_name}')" class="btn btn-sm btn-warning">
                                        <i class="fas fa-redo"></i> Re-run This Species
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            }
            
            // Timeout species section
            if (timeouts.length > 0) {
                html += `
                    <div class="results-section timeout-section">
                        <h5 class="section-title timeout">Timeout Species (${timeouts.length})</h5>
                        <div class="species-list">
                `;
                
                timeouts.forEach(result => {
                    html += `
                        <div class="species-item timeout">
                            <div class="species-header" onclick="toggleSpeciesDetails(this)">
                                <span class="species-name">${result.binomial_name}</span>
                                <span class="species-status timeout">Timeout</span>
                                <span class="toggle-icon">[+]</span>
                            </div>
                            <div class="species-details" style="display: none;">
                                <div class="error-info">
                                    <strong>Status:</strong> Request timed out
                                </div>
                                <div class="rerun-container">
                                    <button onclick="rerunFailedSpecies(${info.id}, '${result.binomial_name}')" class="btn btn-sm btn-warning">
                                        <i class="fas fa-redo"></i> Re-run This Species
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            }
            
            // Successful species section
            if (successful.length > 0) {
                html += `
                    <div class="results-section success-section">
                        <h5 class="section-title success">Successful Species (${successful.length})</h5>
                        ${successful.length > 10 ? '<p style="font-size: 12px; color: #6b7280; margin: 8px 0;">Scroll to see all ' + successful.length + ' species</p>' : ''}
                        <div class="species-list">
                `;
                
                successful.forEach(result => {
                    let mainContent = '';
                    
                    // Check if this is a knowledge template
                    const isKnowledgeTemplate = info.user_template && info.user_template.includes('knowledge');
                    
                    if (isKnowledgeTemplate && result.knowledge_group) {
                        // For knowledge templates, show knowledge level
                        const knowledgeLevel = result.knowledge_group || 'Not determined';
                        const levelClass = knowledgeLevel.toLowerCase() === 'limited' ? 'knowledge-limited' :
                                         knowledgeLevel.toLowerCase() === 'moderate' ? 'knowledge-moderate' :
                                         knowledgeLevel.toLowerCase() === 'extensive' ? 'knowledge-extensive' :
                                         knowledgeLevel.toLowerCase() === 'na' ? 'knowledge-na' : '';
                        
                        mainContent = `
                            <div class="knowledge-level">
                                <strong>Knowledge Level:</strong>
                                <span class="knowledge-value ${levelClass}">${knowledgeLevel}</span>
                            </div>
                        `;
                    } else if (result.phenotypes && Object.keys(result.phenotypes).length > 0) {
                        // For phenotype templates, show phenotypes
                        const phenotypes = Object.entries(result.phenotypes)
                            .filter(([key, value]) => value)
                            .map(([key, value]) => `${key.replace(/_/g, ' ')}: ${value}`)
                            .join(', ');
                        
                        mainContent = `
                            <div class="phenotypes">
                                <strong>Phenotypes:</strong>
                                <div class="phenotype-list">${phenotypes || 'No phenotypes extracted'}</div>
                            </div>
                        `;
                    }
                    
                    html += `
                        <div class="species-item success">
                            <div class="species-header" onclick="toggleSpeciesDetails(this)">
                                <span class="species-name">${result.binomial_name}</span>
                                <span class="species-status success">Success</span>
                                <span class="toggle-icon">[+]</span>
                            </div>
                            <div class="species-details" style="display: none;">
                                ${mainContent}
                                ${result.result ? `
                                    <div class="raw-response">
                                        <strong>Raw LLM Response:</strong>
                                        <details class="llm-response-details">
                                            <summary>Click to expand raw output</summary>
                                            <pre class="response-text">${escapeHtml(result.result)}</pre>
                                        </details>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            }
            
            html += `</div>`;
        } else {
            html += `<p class="no-results">No species have been processed yet.</p>`;
        }
        
        return html;
    }
    
    function generateLiveStatusContent(data) {
        return `
            <div class="card mb-3">
                <h4>Processing Status</h4>
                <div class="progress-bar" style="height: 20px;">
                    <div class="progress-fill" style="width: ${(data.summary.successful / data.summary.total * 100)}%"></div>
                </div>
                <div class="text-center mt-2">
                    ${data.summary.submitted} / ${data.summary.total} submitted
                </div>
            </div>
            
            <h4>Species Status</h4>
            <div class="live-status-grid" id="liveStatusGrid">
                ${generateLiveStatusGrid(data)}
            </div>
        `;
    }
    
    function generateResultsList(data) {
        // Generate results list HTML
        // ... (implementation details)
        return '<div>Results will be displayed here</div>';
    }
    
    function generateLiveStatusGrid(data) {
        // Generate live status grid HTML
        // ... (implementation details)
        return '<div>Live status will be displayed here</div>';
    }
    
    function updateLiveStatus(logData) {
        // Update live status display
        // ... (implementation details)
    }
    
    // Action Functions
    function startCombination(id) {
        fetch(`/api/start_combination/${id}`, {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Job started', 'success');
                    setTimeout(() => location.reload(), 500);
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            });
    }
    
    function pauseCombination(id) {
        fetch(`/api/pause_combination/${id}`, {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Job paused', 'success');
                    setTimeout(() => location.reload(), 500);
                }
            });
    }
    
    function stopCombination(id) {
        if (confirm('Are you sure you want to stop this job?')) {
            fetch(`/api/stop_combination/${id}`, {method: 'POST'})
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Job stopped', 'success');
                        setTimeout(() => location.reload(), 500);
                    }
                });
        }
    }
    
    function restartCombination(id) {
        fetch(`/api/restart_combination/${id}`, {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Job restarted', 'success');
                    setTimeout(() => location.reload(), 500);
                }
            });
    }
    
    function createAndStartCombination(species_file, model, system_template, user_template) {
        // Check API key status first
        fetch('/api/api_key_status')
            .then(response => response.json())
            .then(data => {
                if (!data.configured) {
                    showNotification('API key not configured. Please configure it in Settings.', 'error');
                    return;
                }
                
                const templateName = document.querySelector('.template-tab.active').textContent.trim();
                
                showNotification('Creating combination...', 'info');
                
                fetch('/api/create_combination', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        species_file: species_file,
                        model: model,
                        system_template: system_template,
                        user_template: user_template
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Combination created successfully!', 'success');
                        // Refresh the page to show the new combination
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    } else {
                        showNotification('Error creating combination: ' + (data.error || 'Unknown error'), 'error');
                    }
                })
                .catch(error => {
                    console.error('Error creating combination:', error);
                    showNotification('Failed to create combination', 'error');
                });
            })
            .catch(error => {
                console.error('Error checking API key:', error);
                showNotification('Failed to check API key status', 'error');
            });
    }
    
    function deleteCombination(id) {
        if (confirm('Are you sure you want to delete this combination and all its results?')) {
            fetch(`/api/delete_combination/${id}`, {method: 'DELETE'})
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Combination deleted', 'success');
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    }
                });
        }
    }
    
    function reparsePhenotypeData(combinationId) {
        if (confirm('This will re-parse all raw phenotype responses for this combination. Continue?')) {
            showNotification('Re-parsing phenotype data...', 'info');
            
            fetch(`/api/reparse_phenotype_data/${combinationId}`, {method: 'POST'})
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(`Successfully re-parsed ${data.updated} results`, 'success');
                        // Close modal and refresh details
                        closeModal('detailsModal');
                        setTimeout(() => {
                            showCombinationDetails(combinationId);
                        }, 500);
                    } else {
                        showNotification(data.message || 'Error re-parsing data', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error re-parsing phenotype data:', error);
                    showNotification('Failed to re-parse phenotype data', 'error');
                });
        }
    }
    
    function rerunAllFailed(combinationId) {
        if (confirm('This will re-run all failed samples for this combination using the LLM. This may take time and consume API credits. Continue?')) {
            showNotification('Re-running failed samples...', 'info');
            
            fetch(`/api/rerun_all_failed/${combinationId}`, {method: 'POST'})
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(`Re-running ${data.failed_count} failed samples...`, 'success');
                        // Close modal and refresh page to show updated status
                        closeModal('detailsModal');
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    } else {
                        showNotification(data.error || 'Error re-running failed samples', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error re-running failed samples:', error);
                    showNotification('Failed to re-run failed samples', 'error');
                });
        }
    }
    
    // Model Management functions are already defined globally at the top
    
    function switchInputMethod(method) {
        document.querySelectorAll('.input-tab').forEach(tab => {
            tab.classList.toggle('active', tab.id === method + 'Tab');
        });
        
        document.querySelectorAll('.input-method').forEach(m => {
            m.classList.toggle('active', m.id === method + 'Method');
        });
        
        // Reset validation
        document.getElementById('addModelBtn').disabled = true;
        document.getElementById('modelValidationStatus').style.display = 'none';
    }
    
    // Set up event listeners after DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        const modelDropdown = document.getElementById('modelDropdown');
        if (modelDropdown) {
            modelDropdown.addEventListener('change', function() {
                const selected = this.options[this.selectedIndex];
                const infoDiv = document.getElementById('selectedModelInfo');
                const addBtn = document.getElementById('addModelBtn');
                
                if (selected.value) {
                    const info = JSON.parse(selected.dataset.info);
                    infoDiv.innerHTML = `
                        <strong>${info.name}</strong><br>
                        Context: ${info.context_length.toLocaleString()} tokens<br>
                        Pricing: $${info.pricing.prompt}/1K prompt, $${info.pricing.completion}/1K completion
                    `;
                    infoDiv.style.display = 'block';
                    addBtn.disabled = false;
                } else {
                    infoDiv.style.display = 'none';
                    addBtn.disabled = true;
                }
            });
        }
        
        const newModelInput = document.getElementById('newModelInput');
        if (newModelInput) {
            newModelInput.addEventListener('input', function() {
                const value = this.value.trim();
                const addBtn = document.getElementById('addModelBtn');
                const status = document.getElementById('modelValidationStatus');
                
                if (!value) {
                    addBtn.disabled = true;
                    status.style.display = 'none';
                    return;
                }
                
                // Validate model format
                if (value.includes('/')) {
                    status.textContent = 'Validating...';
                    status.className = 'validation-status loading';
                    status.style.display = 'block';
                    
                    // Validate with API
                    fetch('/api/validate_model', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({model: value})
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.valid) {
                            status.textContent = 'Valid model';
                            status.className = 'validation-status success';
                            addBtn.disabled = false;
                        } else {
                            status.textContent = data.error || 'Invalid model';
                            status.className = 'validation-status error';
                            addBtn.disabled = true;
                        }
                    });
                } else {
                    status.textContent = 'Format: provider/model-name';
                    status.className = 'validation-status error';
                    status.style.display = 'block';
                    addBtn.disabled = true;
                }
            });
        }
    });
    
    function confirmAddModel() {
        const dropdownMethod = document.getElementById('dropdownMethod').classList.contains('active');
        const model = dropdownMethod 
            ? document.getElementById('modelDropdown').value 
            : document.getElementById('newModelInput').value.trim();
        
        if (!model) return;
        
        fetch('/api/add_model', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({model: model})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                closeModal('addModelModal');
                showNotification('Model added', 'success');
                // Force a full page reload to show new column
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                showNotification('Error: ' + data.error, 'error');
            }
        });
    }
    
    function deleteModel(model) {
        if (confirm(`Remove model ${model.split('/').pop()} from dashboard?`)) {
            fetch('/api/delete_model', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({model: model})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Model removed', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                }
            });
        }
    }
    
    // Species File Management function is already defined globally at the top
    
    function confirmAddSpecies() {
        const file = document.getElementById('newSpeciesSelect').value;
        
        if (!file) {
            showNotification('Please select a species file', 'error');
            return;
        }
        
        fetch('/api/add_species_file', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({species_file: file})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                closeModal('addSpeciesModal');
                showNotification('Species file added', 'success');
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                showNotification('Error: ' + data.error, 'error');
            }
        });
    }
    
    function deleteSpeciesFile(file) {
        if (confirm(`Remove species file ${file} from dashboard?`)) {
            fetch('/api/delete_species_file', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({species_file: file})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Species file removed', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                }
            });
        }
    }
    
    // Template Manager
    function openTemplateManager() {
        // Implementation for template manager
        showNotification('Template manager coming soon', 'info');
    }
    
    // Toggle species details
    function toggleSpeciesDetails(header) {
        const details = header.nextElementSibling;
        const icon = header.querySelector('.toggle-icon');
        
        if (details.style.display === 'none') {
            details.style.display = 'block';
            icon.textContent = '[-]';
        } else {
            details.style.display = 'none';
            icon.textContent = '[+]';
        }
    }
    
    // Re-run individual failed species
    function rerunFailedSpecies(combinationId, speciesName) {
        if (confirm(`Re-run processing for ${speciesName}?`)) {
            showNotification(`Re-running ${speciesName}...`, 'info');
            
            fetch('/api/rerun_failed_species', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    combination_id: combinationId,
                    species_name: speciesName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    // Close modal and refresh
                    closeModal('detailsModal');
                    setTimeout(() => {
                        refreshDashboard();
                    }, 1000);
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error re-running species:', error);
                showNotification('Failed to re-run species', 'error');
            });
        }
    }
    
    // Show raw response modal from data attributes
    function showRawResponseFromData(button) {
        const speciesName = button.getAttribute('data-species');
        const rawResponse = button.getAttribute('data-raw').replace(/&#39;/g, "'");
        let parsedData = {};
        
        try {
            parsedData = JSON.parse(button.getAttribute('data-parsed').replace(/&#39;/g, "'"));
        } catch (e) {
            console.error('Error parsing data:', e);
        }
        
        showRawResponse(speciesName, rawResponse, parsedData);
    }
    
    // Show raw response modal
    function showRawResponse(speciesName, rawResponse, parsedData) {
        document.getElementById('rawResponseTitle').textContent = `Raw Response - ${speciesName}`;
        document.getElementById('rawResponseText').textContent = rawResponse || 'No raw response available';
        
        // Generate parsed data display
        let parsedHtml = '<div class="parsed-data-grid">';
        
        if (parsedData && typeof parsedData === 'object') {
            for (const [key, value] of Object.entries(parsedData)) {
                if (value !== null && value !== undefined && value !== '') {
                    const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    parsedHtml += `
                        <div class="parsed-field">
                            <div class="field-label">${label}</div>
                            <div class="field-value">${value}</div>
                        </div>
                    `;
                }
            }
        } else {
            parsedHtml += '<div class="text-muted">No parsed data available</div>';
        }
        
        parsedHtml += '</div>';
        document.getElementById('parsedResponseData').innerHTML = parsedHtml;
        
        // Reset to raw tab
        switchResponseTab('raw');
        showModal('rawResponseModal');
    }
    
    // Switch response tab
    function switchResponseTab(tab) {
        // Update tabs
        document.querySelectorAll('.response-tab').forEach(t => {
            t.classList.toggle('active', t.id === tab + 'Tab');
        });
        
        // Update content
        document.querySelectorAll('.response-content').forEach(c => {
            c.classList.toggle('active', c.id === tab + 'ResponseContent');
        });
    }
    
    // Notification System
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.textContent = message;
        
        // Add to page
        document.body.appendChild(notification);
        
        // Animate in
        setTimeout(() => notification.classList.add('show'), 10);
        
        // Remove after 3 seconds
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
    
    // Add notification styles
    const notificationStyles = document.createElement('style');
    notificationStyles.textContent = `
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            background: var(--gray-900);
            color: var(--white);
            border-radius: 6px;
            font-size: 12px;
            z-index: 3000;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .notification-success {
            background: var(--accent-secondary);
        }
        
        .notification-error {
            background: var(--accent-error);
        }
        
        .notification-info {
            background: var(--accent-primary);
        }
        
        .api-warning {
            background: var(--accent-warning);
            border-left: 4px solid var(--accent-error);
            margin-bottom: 20px;
        }
        
        .api-warning h3 {
            color: var(--gray-900);
            margin-bottom: 10px;
        }
        
        .api-warning p {
            color: var(--gray-700);
            margin-bottom: 15px;
        }
        
        .api-warning button {
            background: var(--gray-900);
            color: var(--white);
        }
    `;
    document.head.appendChild(notificationStyles);
    
    // Settings panel functionality
    let settingsPanelOpen = false;
    
    function toggleSettings() {
        const existingPanel = document.getElementById('settingsPanel');
        
        if (existingPanel) {
            existingPanel.remove();
            settingsPanelOpen = false;
            return;
        }
        
        settingsPanelOpen = true;
        
        const settingsPanel = document.createElement('div');
        settingsPanel.id = 'settingsPanel';
        settingsPanel.className = 'settings-panel';
        settingsPanel.innerHTML = `
            <div class="settings-panel-header">
                <h3>Settings</h3>
                <button onclick="toggleSettings()" class="modal-close">×</button>
            </div>
            <div class="settings-panel-content">
                <div class="setting-group">
                    <label class="setting-label">API Configuration</label>
                    <div class="api-key-input-group">
                        <input type="password" id="apiKeyInput" placeholder="Enter your OpenRouter API key">
                        <button onclick="toggleApiKeyVisibility()" class="btn btn-ghost btn-sm" id="toggleApiKeyBtn">Show</button>
                        <button onclick="updateApiKey()" class="btn btn-primary btn-sm">Update</button>
                    </div>
                    <small class="text-muted mt-1">
                        Get your key from <a href="https://openrouter.ai/keys" target="_blank">OpenRouter</a>
                    </small>
                </div>
                
                <div class="setting-group">
                    <label class="setting-label">Processing Rate</label>
                    <div class="input-group">
                        <input type="number" id="rateLimitInput" min="0.1" max="100" step="0.1" value="30">
                        <span class="text-muted">req/sec</span>
                        <button onclick="updateRateLimit()" class="btn btn-primary btn-sm">Update</button>
                    </div>
                </div>
                
                <div class="setting-group">
                    <label class="setting-label">Concurrent Requests</label>
                    <div class="input-group">
                        <input type="number" id="concurrentInput" min="1" max="30" step="1" value="30">
                        <span class="text-muted">workers</span>
                        <button onclick="updateConcurrency()" class="btn btn-primary btn-sm">Update</button>
                    </div>
                    <small class="text-muted mt-1">Number of species to process in parallel</small>
                </div>
                
                <div class="setting-group">
                    <label class="setting-label">Queue Status</label>
                    <div class="queue-info">
                        <span id="queueLength">0</span> jobs waiting
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(settingsPanel);
        
        // Add styles for settings panel
        if (!document.getElementById('settingsPanelStyles')) {
            const settingsStyles = document.createElement('style');
            settingsStyles.id = 'settingsPanelStyles';
            settingsStyles.textContent = `
                .settings-panel {
                    position: fixed;
                    right: 0;
                    top: 0;
                    height: 100vh;
                    width: 400px;
                    background: var(--white);
                    box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
                    z-index: 1000;
                    overflow-y: auto;
                    animation: slideIn 0.3s ease-out;
                }
                
                @keyframes slideIn {
                    from {
                        transform: translateX(100%);
                    }
                    to {
                        transform: translateX(0);
                    }
                }
                
                .settings-panel-header {
                    padding: 20px;
                    border-bottom: 1px solid var(--border-color);
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }
                
                .settings-panel-content {
                    padding: 20px;
                }
                
                .setting-group {
                    margin-bottom: 24px;
                }
                
                .setting-label {
                    display: block;
                    font-weight: 600;
                    margin-bottom: 8px;
                    font-size: 14px;
                }
                
                .input-group {
                    display: flex;
                    gap: 8px;
                    align-items: center;
                }
                
                .api-key-input-group {
                    display: flex;
                    gap: 8px;
                    align-items: center;
                }
                
                .api-key-input-group input {
                    flex: 1;
                }
                
                .queue-info {
                    padding: 12px;
                    background: var(--bg-secondary);
                    border-radius: 6px;
                    text-align: center;
                    font-weight: 600;
                }
            `;
            document.head.appendChild(settingsStyles);
        }
    }
    
    // Modal helper functions are already defined globally at the top
    
    // Close modals when clicking outside
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    }
    
    // Scroll to add column button
    function scrollToAddColumn(templateIndex) {
        const container = document.getElementById(`matrix-scroll-${templateIndex}`);
        if (container) {
            // Scroll to the far right
            container.scrollLeft = container.scrollWidth;
        }
    }
    
    // Make all necessary functions globally accessible
    window.scrollToAddColumn = scrollToAddColumn;
    window.confirmAddModel = confirmAddModel;
    window.confirmAddSpecies = confirmAddSpecies;
    window.switchInputMethod = switchInputMethod;
    window.refreshModels = refreshModels;
    window.deleteModel = deleteModel;
    window.deleteSpeciesFile = deleteSpeciesFile;
    window.createAndStartCombination = createAndStartCombination;
    window.startCombination = startCombination;
    window.pauseCombination = pauseCombination;
    window.stopCombination = stopCombination;
    window.restartCombination = restartCombination;
    window.deleteCombination = deleteCombination;
    window.showCombinationDetails = showCombinationDetails;
    window.showTemplate = showTemplate;
    window.toggleSettings = toggleSettings;
    window.toggleApiKeyVisibility = toggleApiKeyVisibility;
    window.updateApiKey = updateApiKey;
    window.updateRateLimit = updateRateLimit;
    window.updateConcurrency = updateConcurrency;
    window.refreshDashboard = refreshDashboard;
    window.openTemplateManager = openTemplateManager;
    window.reparsePhenotypeData = reparsePhenotypeData;
    window.rerunAllFailed = rerunAllFailed;
    window.rerunSpecies = rerunSpecies;
    window.showRawResponseFromData = showRawResponseFromData;
    window.switchResponseTab = switchResponseTab;
</script>
{% endblock %} 