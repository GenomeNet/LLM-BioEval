<div class="flow-diagram-wrapper">
<div class="flow-diagram">
    <!-- Input Box -->
    <div class="flow-box flow-input">
        <div class="flow-species">Pseudobacterium imaginarius</div>
        <div class="flow-label">Completely fictional species</div>
    </div>
    
    <!-- Arrow 1 -->
    <div class="flow-arrow">
        <svg width="60" height="40" viewBox="0 0 60 40" fill="none">
            <path d="M5 20 L45 20 M45 20 L38 13 M45 20 L38 27" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </div>
    
    <!-- Query Box -->
    <div class="flow-box flow-query">
        <div class="query-title">LLM Query</div>
        <div class="output-description">Fictional species embedded in queries<br>asking models to assess their knowledge level</div>
        <div class="query-templates">
            <div class="query-template" data-query="1">
                <span class="template-number">Q1</span>
                <span class="template-type">no NA option</span>
            </div>
            <div class="query-template" data-query="2">
                <span class="template-number">Q2</span>
                <span class="template-type">with NA option short query</span>
            </div>
            <div class="query-template" data-query="3">
                <span class="template-number">Q3</span>
                <span class="template-type">with NA verbose query</span>
            </div>
        </div>
    </div>
    
    <!-- Arrow 2 -->
    <div class="flow-arrow">
        <svg width="60" height="40" viewBox="0 0 60 40" fill="none">
            <path d="M5 20 L45 20 M45 20 L38 13 M45 20 L38 27" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </div>
    
    <!-- Output Box -->
    <div class="flow-box flow-output">
        <div class="output-title">LLM Response</div>
        <div class="output-description">LLM response of the knowledge level<br>based on the query</div>
        <div class="output-options">
            <div class="output-option caution" data-level="limited">
                <span>Limited</span>
                <div class="expectation-indicator">
                    <span class="expect-q1">✓</span>
                </div>
            </div>
            <div class="output-option bad" data-level="moderate">
                <span>Moderate</span>
                <div class="expectation-indicator">
                    <span class="expect-none">✗</span>
                </div>
            </div>
            <div class="output-option worst" data-level="extensive">
                <span>Extensive</span>
                <div class="expectation-indicator">
                    <span class="expect-none">✗</span>
                </div>
            </div>
            <div class="output-option good" data-level="na">
                <span>NA</span>
                <div class="expectation-indicator">
                    <span class="expect-q2 expect-q3">✓</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Legend -->
<div class="flow-legend">
    <div class="legend-item">
        <span class="legend-symbol">Q1, Q2, Q3</span> = Query types
    </div>
    <div class="legend-item">
        <span class="legend-symbol">✓</span> = Expected best response
    </div>
    <div class="legend-item">
        <span class="legend-symbol">✗</span> = Hallucination (bad response)
    </div>
</div>
</div>

<script>
// Animation for hallucination detection flow
(function() {
    console.log('[HallucinationFlow] Animation script starting...');
    
    function initAnimation() {
        console.log('[HallucinationFlow] Looking for flow diagram...');
        
        // Find all possible containers
        const containers = document.querySelectorAll('.flow-diagram-wrapper');
        console.log('[HallucinationFlow] Found', containers.length, 'flow diagram wrappers');
        
        containers.forEach((container, index) => {
            console.log('[HallucinationFlow] Processing container', index);
            const diagram = container.querySelector('.flow-diagram');
            if (!diagram) {
                console.log('[HallucinationFlow] No flow-diagram found in container', index);
                return;
            }
            
            const queryTemplates = diagram.querySelectorAll('.query-template');
            const outputOptions = diagram.querySelectorAll('.output-option');
            const naOption = diagram.querySelector('.output-option[data-level="na"]');
            
            console.log('[HallucinationFlow] Found', queryTemplates.length, 'query templates and', outputOptions.length, 'output options');
            
            if (queryTemplates.length === 0 || outputOptions.length === 0) {
                console.error('[HallucinationFlow] Could not find query or output elements.');
                return;
            }
            
            // Only add CSS once
            if (!document.getElementById('hallucination-flow-styles')) {
                const style = document.createElement('style');
                style.id = 'hallucination-flow-styles';
                style.textContent = `
                    .query-template.active {
                        border: 2px solid #6366f1 !important;
                        background: rgba(99, 102, 241, 0.05) !important;
                        transform: translateY(-2px) !important;
                        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15) !important;
                    }
                    
                    .output-option.highlight {
                        transform: scale(1.05) !important;
                        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1) !important;
                        border-color: var(--primary) !important;
                        border-width: 2px !important;
                    }
                    
                    .output-option.hide {
                        opacity: 0.3 !important;
                        transform: scale(0.95) !important;
                    }
                    
                    .expectation-indicator span {
                        display: none;
                        animation: popIn 0.3s ease;
                    }
                    
                    @keyframes popIn {
                        0% { transform: scale(0); }
                        50% { transform: scale(1.2); }
                        100% { transform: scale(1); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            function resetHighlights() {
                queryTemplates.forEach(q => q.classList.remove('active'));
                outputOptions.forEach(o => o.classList.remove('highlight'));
                diagram.querySelectorAll('.expectation-indicator span').forEach(span => {
                    span.style.display = 'none';
                });
            }
            
            const animations = [
                { query: '1', output: 'limited', duration: 3000 },
                { query: '2', output: 'na', duration: 3000 },
                { query: '3', output: 'na', duration: 3000 }
            ];
            
            let currentIndex = 0;
            
            function showNext() {
                resetHighlights();
                
                const current = animations[currentIndex];
                const queryElement = diagram.querySelector(`.query-template[data-query="${current.query}"]`);
                const outputElement = diagram.querySelector(`.output-option[data-level="${current.output}"]`);
                
                console.log('[HallucinationFlow] Animating:', current, queryElement, outputElement);
                
                // Show/hide NA option based on query
                if (current.query === '1') {
                    if (naOption) {
                        naOption.classList.add('hide');
                    }
                } else {
                    if (naOption) {
                        naOption.classList.remove('hide');
                    }
                }
                
                if (queryElement && outputElement) {
                    // Highlight query template
                    queryElement.classList.add('active');
                    
                    // After a delay, highlight the output
                    setTimeout(() => {
                        outputElement.classList.add('highlight');
                        
                        // Show the appropriate indicator
                        const expectIndicator = outputElement.querySelector(`.expect-q${current.query}`);
                        if (expectIndicator) {
                            expectIndicator.style.display = 'inline-block';
                        }
                    }, 500);
                }
                
                currentIndex = (currentIndex + 1) % animations.length;
                setTimeout(showNext, current.duration);
            }
            
            // Start animation after a delay
            console.log('[HallucinationFlow] Starting animation for container', index);
            setTimeout(showNext, 1500);
        });
    }
    
    // Initialize immediately
    initAnimation();
    
    // Also try after DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initAnimation);
    }
    
    // And after a short delay for dynamic content
    setTimeout(initAnimation, 500);
    
    // Expose for component viewer
    window.initHallucinationFlow = initAnimation;
})();

// Call init if in component viewer
if (window.location.pathname.includes('/components/')) {
    console.log('[HallucinationFlow] Component viewer detected, initializing after delay...');
    setTimeout(() => {
        if (typeof window.initHallucinationFlow === 'function') {
            window.initHallucinationFlow();
        }
    }, 1000);
}
</script>

<style>
/* Interactive hover effects */
.flow-diagram {
    display: flex;
    align-items: center;
    justify-content: center;
}

.query-template {
    transition: all 0.3s ease;
    cursor: pointer;
}

.query-template:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(99, 102, 241, 0.2);
}

.output-option {
    transition: all 0.3s ease;
}

/* Hover interactions */
.query-template[data-query="1"]:hover ~ * .output-option .expect-q1,
.query-template[data-query="2"]:hover ~ * .output-option .expect-q2,
.query-template[data-query="3"]:hover ~ * .output-option .expect-q3 {
    font-size: 24px;
    font-weight: 700;
}

.flow-legend {
    display: flex;
    gap: 24px;
    justify-content: center;
    margin-top: 8px;
    margin-bottom: 0;
    font-size: 14px;
    color: var(--gray-600);
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.legend-symbol {
    font-weight: 600;
    color: var(--gray-900);
}
</style>