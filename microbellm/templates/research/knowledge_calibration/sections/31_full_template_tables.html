<div id="fullTemplateTablesContainer">
    <!-- Full template analysis tables will be rendered here -->
</div>

<style>
/* Loading animation styles */
.loading-container {
    text-align: center;
    padding: 40px 20px;
}

.loading-progress {
    width: 200px;
    height: 4px;
    background: #f3f4f6;
    border-radius: 2px;
    margin: 0 auto 16px;
    overflow: hidden;
}

.loading-progress-bar {
    height: 100%;
    background: #7c3aed;
    width: 30%;
    border-radius: 2px;
    animation: loading 1.5s ease-in-out infinite;
}

@keyframes loading {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(400%); }
}

.loading-text {
    color: #6b7280;
    font-size: 14px;
}

/* Bar chart styles for knowledge levels */
.bar-chart-wrapper {
    background: transparent;
    border-radius: 6px;
    overflow: hidden;
    border: 1px solid #f3f4f6;
}

.bar-chart-segments {
    display: flex;
    height: 24px;
    width: 100%;
    font-size: 11px;
    font-weight: 500;
    color: white;
    line-height: 24px;
    text-align: center;
}

.bar-segment {
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: opacity 0.2s;
}

.bar-segment:hover {
    opacity: 0.9;
}

/* Knowledge level colors */
.knowledge-na {
    background: linear-gradient(135deg, #e2e3e5 0%, #d6d8db 100%);
    color: #6b7280;
}

.knowledge-limited {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    color: #806520;
}

.knowledge-moderate {
    background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
    color: #0c5460;
}

.knowledge-extensive {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    color: #155724;
}

.knowledge-failed {
    background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
    color: #721c24;
}

/* Hide rows by default */
.hidden-row {
    display: none;
}

.hidden-row.show {
    display: table-row;
    background: white;
}

/* Tooltip styles */
.bar-tooltip {
    position: absolute;
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 12px;
    white-space: nowrap;
    z-index: 1000;
    pointer-events: none;
    display: none;
}
</style>

<script>
function renderTemplateAnalysisTables(templateArray, inputTypeArray, modelData) {
    let html = '';
    
    // Template descriptions
    const templateDescriptions = {
        'template1_knowlege': 'Basic knowledge level assessment template (limited, moderate, extensive)',
        'template2_knowlege': 'Knowledge level assessment template with NA support', 
        'template3_knowlege': 'Alternative knowledge level assessment template with NA support'
    };
    
    // Create compact table layout for each template
    templateArray.forEach((templateName, templateIndex) => {
        // Add spacing between templates
        if (templateIndex > 0) {
            html += '<div style="margin: 40px 0;"></div>';
        }
        
        // Simple structure without section-callout wrapper
        html += `<div class="template-analysis-section">`;
        
        // Section header with title and description
        html += `<h3 style="font-size: 24px; font-weight: 600; margin-bottom: 8px;">`;
        html += `<a href="/templates" class="template-header-link" onclick="scrollToTemplate('${templateName}')" style="color: inherit; text-decoration: none;">${templateName}</a>`;
        html += `</h3>`;
        html += `<p style="font-size: 16px; color: #6b7280; line-height: 1.6; margin-bottom: 24px;">${templateDescriptions[templateName] || 'Template for model evaluation'}. The bar charts below show response distributions for each model across the artificial species categories.</p>`;
        
        html += createBarChartLegend();
        
        html += `<div class="table-fade" id="table-fade-${templateIndex}" style="margin-top: 16px;">`;
        html += `<div style="background: #FAFAFA; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden;">`;
        html += `<table class="knowledge-analysis-table" style="width: 100%; border-collapse: collapse;">`;
        
        // Header row
        html += `<thead><tr style="background: #F9FAFB; border-bottom: 1px solid #e5e7eb;">`;
        html += `<th style="padding: 16px; text-align: left; font-weight: 500; color: #6b7280; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Model</th>`;
        inputTypeArray.forEach(inputType => {
            const displayType = formatTypeName(inputType);
            html += `<th style="padding: 16px; text-align: center; font-weight: 500; color: #6b7280; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">${displayType}</th>`;
        });
        html += `<th style="padding: 16px; text-align: center; width: 120px; font-weight: 500; color: #6b7280; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Quality Score</th>`;
        html += `</tr></thead>`;
        
        // Data rows
        html += `<tbody>`;
        
        // Calculate metrics for sorting
        const modelScores = Object.entries(modelData)
            .filter(([modelName, templates]) => templates[templateName])
            .map(([modelName, templates]) => {
                let totalQualityScore = 0;
                let totalSamples = 0;
                
                inputTypeArray.forEach(inputType => {
                    const data = templates[templateName][inputType];
                    if (data) {
                        const naFailedCount = (data.NA || 0) + (data.no_result || 0) + (data.inference_failed || 0);
                        const limitedCount = data.limited || 0;
                        const moderateCount = data.moderate || 0;
                        const extensiveCount = data.extensive || 0;
                        
                        totalQualityScore += (naFailedCount * 3) + (limitedCount * 2) + (moderateCount * 1) + (extensiveCount * 0);
                        totalSamples += data.total || 0;
                    }
                });
                
                return {
                    modelName,
                    templates: templates[templateName],
                    qualityScore: totalQualityScore,
                    totalSamples,
                    averageQualityScore: totalSamples > 0 ? totalQualityScore / totalSamples : 0
                };
            })
            .sort((a, b) => {
                // Sort by quality score (higher is better)
                if (b.averageQualityScore !== a.averageQualityScore) {
                    return b.averageQualityScore - a.averageQualityScore;
                }
                // Secondary: by total quality score
                if (b.qualityScore !== a.qualityScore) {
                    return b.qualityScore - a.qualityScore;
                }
                // Final fallback: alphabetical by model name
                return a.modelName.localeCompare(b.modelName);
            });
        
        modelScores.forEach(({modelName, templates, averageQualityScore, qualityScore, totalSamples}, index) => {
            const isHidden = index >= 3;
            html += `<tr class="${isHidden ? 'hidden-row' : ''}" style="border-bottom: 1px solid #f3f4f6;">`;
            html += `<td style="padding: 16px; font-weight: 500; color: #111827;">${modelName.split('/').pop()}</td>`;
            
            inputTypeArray.forEach(inputType => {
                html += `<td style="padding: 16px;">`;
                if (templates[inputType]) {
                    html += createKnowledgeBarChart(templates[inputType]);
                } else {
                    html += '<div style="text-align: center; color: #9ca3af; font-style: italic; font-size: 14px;">No data</div>';
                }
                html += `</td>`;
            });
            
            // Add quality score column
            html += `<td style="padding: 16px; text-align: center;">`;
            if (totalSamples > 0) {
                html += `<span style="font-weight: 600; color: #7c3aed; font-size: 16px;">${averageQualityScore.toFixed(2)}</span>`;
            } else {
                html += '<span style="color: #9ca3af; font-style: italic; font-size: 14px;">No data</span>';
            }
            html += `</td>`;
            
            html += `</tr>`;
        });
        html += `</tbody></table>`;
        
        // Add expand/collapse button if there are more than 3 models
        if (modelScores.length > 3) {
            html += `<div style="text-align: center; padding: 16px; background: white; border-top: 1px solid #f3f4f6;">`;
            html += `<button style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; background: white; border: 1px solid #e5e7eb; border-radius: 6px; color: #6b7280; font-size: 14px; font-weight: 500; cursor: pointer; transition: border-color 0.2s, color 0.2s;" onclick="toggleTableExpansion(this, ${templateIndex})" onmouseover="this.style.borderColor='#9ca3af'; this.style.color='#4b5563';" onmouseout="this.style.borderColor='#e5e7eb'; this.style.color='#6b7280';">`;
            html += `<span>Show ${modelScores.length - 3} more models</span>`;
            html += `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.2s;">`;
            html += `<path d="M6 9l6 6 6-6"/>`;
            html += `</svg>`;
            html += `</button>`;
            html += `</div>`;
        }
        
        html += `</div>`; // Close table wrapper
        html += `</div>`; // Close table-fade
    });
    
    return html;
}

// Create knowledge bar chart for table cells
function createKnowledgeBarChart(data) {
    const total = data.total || 0;
    if (total === 0) {
        return '<div class="no-data">No data</div>';
    }
    
    // Calculate percentages
    const segments = [
        { type: 'na', count: data.NA || 0, class: 'knowledge-na' },
        { type: 'limited', count: data.limited || 0, class: 'knowledge-limited' },
        { type: 'moderate', count: data.moderate || 0, class: 'knowledge-moderate' },
        { type: 'extensive', count: data.extensive || 0, class: 'knowledge-extensive' },
        { type: 'failed', count: (data.no_result || 0) + (data.inference_failed || 0), class: 'knowledge-failed' }
    ].filter(s => s.count > 0);
    
    let html = '<div class="bar-chart-wrapper"><div class="bar-chart-segments">';
    
    segments.forEach(segment => {
        const percentage = (segment.count / total) * 100;
        const showCount = percentage > 10;
        
        html += `<div class="bar-segment ${segment.class}" 
                      style="width: ${percentage}%"
                      data-count="${segment.count}"
                      data-type="${segment.type}"
                      data-total="${total}"
                      onmouseover="showBarTooltip(event, this)"
                      onmouseout="hideBarTooltip()">`;
        if (showCount) {
            html += segment.count;
        }
        html += `</div>`;
    });
    
    html += '</div></div>';
    return html;
}

// Toggle table expansion
function toggleTableExpansion(button, templateIndex) {
    const tableWrapper = button.closest('.table-fade');
    const hiddenRows = tableWrapper.querySelectorAll('.hidden-row');
    const fadeContainer = document.querySelector(`#table-fade-${templateIndex}`);
    const isExpanded = button.classList.contains('expanded');
    
    if (isExpanded) {
        // Collapse
        hiddenRows.forEach(row => row.classList.remove('show'));
        button.classList.remove('expanded');
        button.querySelector('span').textContent = `Show ${hiddenRows.length} more models`;
        if (fadeContainer) fadeContainer.classList.remove('expanded');
    } else {
        // Expand
        hiddenRows.forEach(row => row.classList.add('show'));
        button.classList.add('expanded');
        button.querySelector('span').textContent = 'Show less';
        if (fadeContainer) fadeContainer.classList.add('expanded');
    }
}

// Transform API data to expected format
function transformKnowledgeData(knowledgeAnalysis) {
    console.log('[FullTemplateTables] Transforming data...');
    const modelData = {};
    const templateSet = new Set();
    const inputTypeSet = new Set();
    
    // Process only files with type columns
    Object.entries(knowledgeAnalysis).forEach(([fileName, fileData]) => {
        if (!fileData.has_type_column || !fileData.types) {
            return;
        }
        
        // Process each input type
        Object.entries(fileData.types).forEach(([inputType, templateData]) => {
            inputTypeSet.add(inputType);
            
            // Process each template
            Object.entries(templateData).forEach(([templateName, models]) => {
                templateSet.add(templateName);
                
                // Process each model
                Object.entries(models).forEach(([modelName, stats]) => {
                    // Initialize model data structure if needed
                    if (!modelData[modelName]) {
                        modelData[modelName] = {};
                    }
                    if (!modelData[modelName][templateName]) {
                        modelData[modelName][templateName] = {};
                    }
                    
                    // Store the stats
                    modelData[modelName][templateName][inputType] = stats;
                });
            });
        });
    });
    
    return {
        modelData: modelData,
        templateArray: Array.from(templateSet).sort(),
        inputTypeArray: Array.from(inputTypeSet).sort()
    };
}

// Load tables when knowledge data is available
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('fullTemplateTablesContainer');
    if (!container) return;
    
    // Check if we're in component viewer context
    const isComponentViewer = window.location.pathname.includes('/components/');
    
    if (isComponentViewer || !window.knowledgeData) {
        // Fetch data directly if in component viewer or data not available
        console.log('[FullTemplateTables] Fetching data directly...');
        container.innerHTML = '<div class="loading-container"><div class="loading-progress"><div class="loading-progress-bar"></div></div><div class="loading-text">Loading template analysis data...</div></div>';
        
        fetch('/api/knowledge_analysis_data')
            .then(response => response.json())
            .then(data => {
                if (data.knowledge_analysis) {
                    const transformedData = transformKnowledgeData(data.knowledge_analysis);
                    window.knowledgeData = transformedData; // Store globally
                    container.innerHTML = renderTemplateAnalysisTables(
                        transformedData.templateArray,
                        transformedData.inputTypeArray,
                        transformedData.modelData
                    );
                } else {
                    container.innerHTML = '<div class="error-message">No knowledge analysis data available</div>';
                }
            })
            .catch(error => {
                console.error('[FullTemplateTables] Failed to load data:', error);
                container.innerHTML = '<div class="error-message">Failed to load template analysis data</div>';
            });
    } else {
        // Use existing data
        const checkDataInterval = setInterval(function() {
            if (window.knowledgeData) {
                clearInterval(checkDataInterval);
                if (window.knowledgeData.templateArray && window.knowledgeData.inputTypeArray && window.knowledgeData.modelData) {
                    container.innerHTML = renderTemplateAnalysisTables(
                        window.knowledgeData.templateArray,
                        window.knowledgeData.inputTypeArray,
                        window.knowledgeData.modelData
                    );
                }
            }
        }, 100);
        
        // Stop checking after 10 seconds
        setTimeout(function() {
            clearInterval(checkDataInterval);
        }, 10000);
    }
});

// Helper function to format type names
function formatTypeName(typeName) {
    // Format type names for display
    const typeDescriptions = {
        'random_words': 'Random Words',
        'latin_random_words': 'Fictional Latin',
        'real_genus_latin_strain': 'Real Genus + Fake Species',
        'latin_genus_real_strain': 'Fake Genus + Real Species'
    };
    return typeDescriptions[typeName] || typeName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

// Create bar chart legend
function createBarChartLegend() {
    return `
        <div class="legend" style="margin-bottom: 16px;">
            <div style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--gray-700);">
                <div style="width: 14px; height: 14px; border-radius: 4px; border: 1px solid rgba(0,0,0,0.1); background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);"></div>
                <span>Extensive</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--gray-700);">
                <div style="width: 14px; height: 14px; border-radius: 4px; border: 1px solid rgba(0,0,0,0.1); background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);"></div>
                <span>Moderate</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--gray-700);">
                <div style="width: 14px; height: 14px; border-radius: 4px; border: 1px solid rgba(0,0,0,0.1); background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);"></div>
                <span>Limited</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--gray-700);">
                <div style="width: 14px; height: 14px; border-radius: 4px; border: 1px solid rgba(0,0,0,0.1); background: linear-gradient(135deg, #e2e3e5 0%, #d6d8db 100%);"></div>
                <span>NA</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--gray-700);">
                <div style="width: 14px; height: 14px; border-radius: 4px; border: 1px solid rgba(0,0,0,0.1); background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);"></div>
                <span>Failed</span>
            </div>
        </div>
    `;
}

// Bar tooltip functions
let tooltipElement = null;

function showBarTooltip(event, element) {
    const count = element.getAttribute('data-count');
    const type = element.getAttribute('data-type');
    const total = element.getAttribute('data-total');
    const percentage = ((count / total) * 100).toFixed(1);
    
    // Create tooltip if it doesn't exist
    if (!tooltipElement) {
        tooltipElement = document.createElement('div');
        tooltipElement.className = 'bar-tooltip';
        document.body.appendChild(tooltipElement);
    }
    
    // Set content
    let typeLabel = type.charAt(0).toUpperCase() + type.slice(1);
    if (type === 'na') typeLabel = 'NA';
    tooltipElement.innerHTML = `
        <strong>${typeLabel}</strong><br>
        ${count} / ${total} (${percentage}%)
    `;
    
    // Position tooltip
    const rect = element.getBoundingClientRect();
    tooltipElement.style.left = rect.left + (rect.width / 2) - (tooltipElement.offsetWidth / 2) + 'px';
    tooltipElement.style.top = rect.top - tooltipElement.offsetHeight - 10 + 'px';
    tooltipElement.style.display = 'block';
}

function hideBarTooltip() {
    if (tooltipElement) {
        tooltipElement.style.display = 'none';
    }
}

// Make functions globally available
window.toggleTableExpansion = toggleTableExpansion;
window.showBarTooltip = showBarTooltip;
window.hideBarTooltip = hideBarTooltip;
</script>