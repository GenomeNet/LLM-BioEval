<div id="qualityScoreChartContainer">
    <!-- Quality score distribution chart will be rendered here -->
</div>

<script>
// Self-contained script for quality score chart
(function() {
    console.log('[QualityScoreChart] Script starting...');
    
    // Wait a bit for DOM to settle
    setTimeout(function() {
        console.log('[QualityScoreChart] Looking for container...');
        initializeAllCharts();
    }, 100);
    
    // Function to initialize all charts on the page
    function initializeAllCharts() {
        const allContainers = document.querySelectorAll('#qualityScoreChartContainer');
        console.log('[QualityScoreChart] Found', allContainers.length, 'containers to initialize');
        
        allContainers.forEach((container, index) => {
            console.log('[QualityScoreChart] Initializing container', index);
            initializeQualityScoreChart(container);
        });
    }
    
    // Function to find container with fallback
    function findContainer() {
        // Find all containers
        const allContainers = document.querySelectorAll('#qualityScoreChartContainer');
        console.log('[QualityScoreChart] Found', allContainers.length, 'containers');
        
        // In component viewer, prefer the wrapped container
        const wrappedContainer = document.getElementById('wrapped-component-container');
        if (wrappedContainer && allContainers.length > 1) {
            const container = wrappedContainer.querySelector('#qualityScoreChartContainer');
            if (container) {
                console.log('[QualityScoreChart] Found container in wrapped component');
                return container;
            }
        }
        
        // Return the first container found
        if (allContainers.length > 0) {
            console.log('[QualityScoreChart] Using first container found');
            return allContainers[0];
        }
        
        console.error('[QualityScoreChart] Container not found!');
        return null;
    }
    
    // Transform API data to expected format (same as other components)
    function transformKnowledgeData(knowledgeAnalysis) {
        console.log('[QualityScoreChart] Transforming data...');
        const modelData = {};
        const templateSet = new Set();
        const inputTypeSet = new Set();
        
        // Process only files with type columns
        // The data structure is: file -> types -> inputType -> template -> model -> stats
        // We need to transform it to: model -> template -> inputType -> stats
        
        Object.entries(knowledgeAnalysis).forEach(([fileName, fileData]) => {
            console.log('[QualityScoreChart] Processing file:', fileName);
            
            // Only process files that have type columns
            if (!fileData.has_type_column || !fileData.types) {
                console.warn('[QualityScoreChart] Skipping file (no type column):', fileName);
                return;
            }
            
            // Process each input type
            Object.entries(fileData.types).forEach(([inputType, templateData]) => {
                // Skip UNCLASSIFIED and WA_WITH_GCOUNT columns
                if (inputType === 'UNCLASSIFIED' || inputType === 'WA_WITH_GCOUNT') {
                    return;
                }
                inputTypeSet.add(inputType);
                
                // Process each template
                Object.entries(templateData).forEach(([templateName, models]) => {
                    templateSet.add(templateName);
                    
                    // Process each model
                    Object.entries(models).forEach(([modelName, stats]) => {
                        // Initialize model data structure if needed
                        if (!modelData[modelName]) {
                            modelData[modelName] = {};
                        }
                        if (!modelData[modelName][templateName]) {
                            modelData[modelName][templateName] = {};
                        }
                        
                        // Store the stats
                        modelData[modelName][templateName][inputType] = stats;
                    });
                });
            });
        });
        
        const result = {
            modelData: modelData,
            templateArray: Array.from(templateSet).sort(),
            inputTypeArray: Array.from(inputTypeSet).sort()
        };
        
        console.log('[QualityScoreChart] Transformed data:', {
            models: Object.keys(modelData).length,
            templates: result.templateArray.length,
            inputTypes: result.inputTypeArray.length,
            firstModel: Object.keys(modelData)[0]
        });
        
        return result;
    }
    
    // Mock data for component viewer
    function getMockKnowledgeAnalysisData() {
        return {
            knowledge_analysis: {
                "mock_data.csv": {
                    has_type_column: true,
                    types: {
                        "Real": {
                            "template1_knowledge": {
                                "claude-3-opus-20240229": {
                                    limited: 15,
                                    moderate: 45,
                                    extensive: 60,
                                    NA: 0,
                                    failed: 0,
                                    total: 120,
                                    quality_score: 0.88
                                },
                                "gpt-4-turbo": {
                                    limited: 18,
                                    moderate: 52,
                                    extensive: 50,
                                    NA: 0,
                                    failed: 0,
                                    total: 120,
                                    quality_score: 0.85
                                },
                                "claude-3-sonnet-20240229": {
                                    limited: 22,
                                    moderate: 58,
                                    extensive: 40,
                                    NA: 0,
                                    failed: 0,
                                    total: 120,
                                    quality_score: 0.82
                                },
                                "gemini-pro": {
                                    limited: 25,
                                    moderate: 60,
                                    extensive: 35,
                                    NA: 0,
                                    failed: 0,
                                    total: 120,
                                    quality_score: 0.79
                                },
                                "llama-3-70b": {
                                    limited: 30,
                                    moderate: 65,
                                    extensive: 25,
                                    NA: 0,
                                    failed: 0,
                                    total: 120,
                                    quality_score: 0.75
                                }
                            },
                            "template2_physiology": {
                                "claude-3-opus-20240229": {
                                    limited: 20,
                                    moderate: 50,
                                    extensive: 50,
                                    NA: 0,
                                    failed: 0,
                                    total: 120,
                                    quality_score: 0.85
                                },
                                "gpt-4-turbo": {
                                    limited: 25,
                                    moderate: 55,
                                    extensive: 40,
                                    NA: 0,
                                    failed: 0,
                                    total: 120,
                                    quality_score: 0.81
                                },
                                "claude-3-sonnet-20240229": {
                                    limited: 30,
                                    moderate: 50,
                                    extensive: 40,
                                    NA: 0,
                                    failed: 0,
                                    total: 120,
                                    quality_score: 0.78
                                },
                                "gemini-pro": {
                                    limited: 35,
                                    moderate: 55,
                                    extensive: 30,
                                    NA: 0,
                                    failed: 0,
                                    total: 120,
                                    quality_score: 0.74
                                },
                                "llama-3-70b": {
                                    limited: 40,
                                    moderate: 50,
                                    extensive: 30,
                                    NA: 0,
                                    failed: 0,
                                    total: 120,
                                    quality_score: 0.70
                                }
                            },
                            "template3_habitat": {
                                "claude-3-opus-20240229": {
                                    limited: 35,
                                    moderate: 45,
                                    extensive: 40,
                                    NA: 0,
                                    failed: 0,
                                    total: 120,
                                    quality_score: 0.72
                                },
                                "gpt-4-turbo": {
                                    limited: 40,
                                    moderate: 40,
                                    extensive: 40,
                                    NA: 0,
                                    failed: 0,
                                    total: 120,
                                    quality_score: 0.68
                                },
                                "claude-3-sonnet-20240229": {
                                    limited: 45,
                                    moderate: 35,
                                    extensive: 40,
                                    NA: 0,
                                    failed: 0,
                                    total: 120,
                                    quality_score: 0.64
                                },
                                "gemini-pro": {
                                    limited: 50,
                                    moderate: 40,
                                    extensive: 30,
                                    NA: 0,
                                    failed: 0,
                                    total: 120,
                                    quality_score: 0.60
                                },
                                "llama-3-70b": {
                                    limited: 55,
                                    moderate: 35,
                                    extensive: 30,
                                    NA: 0,
                                    failed: 0,
                                    total: 120,
                                    quality_score: 0.56
                                }
                            }
                        },
                        "Fake": {
                            "template1_knowledge": {
                                "claude-3-opus-20240229": {
                                    limited: 5,
                                    moderate: 10,
                                    extensive: 5,
                                    NA: 100,
                                    failed: 0,
                                    total: 120,
                                    quality_score: 0.92
                                },
                                "gpt-4-turbo": {
                                    limited: 8,
                                    moderate: 12,
                                    extensive: 10,
                                    NA: 90,
                                    failed: 0,
                                    total: 120,
                                    quality_score: 0.88
                                },
                                "claude-3-sonnet-20240229": {
                                    limited: 10,
                                    moderate: 15,
                                    extensive: 15,
                                    NA: 80,
                                    failed: 0,
                                    total: 120,
                                    quality_score: 0.84
                                },
                                "gemini-pro": {
                                    limited: 15,
                                    moderate: 20,
                                    extensive: 20,
                                    NA: 65,
                                    failed: 0,
                                    total: 120,
                                    quality_score: 0.77
                                },
                                "llama-3-70b": {
                                    limited: 20,
                                    moderate: 25,
                                    extensive: 25,
                                    NA: 50,
                                    failed: 0,
                                    total: 120,
                                    quality_score: 0.70
                                }
                            },
                            "template2_physiology": {
                                "claude-3-opus-20240229": {
                                    limited: 3,
                                    moderate: 7,
                                    extensive: 5,
                                    NA: 105,
                                    failed: 0,
                                    total: 120,
                                    quality_score: 0.94
                                },
                                "gpt-4-turbo": {
                                    limited: 5,
                                    moderate: 10,
                                    extensive: 10,
                                    NA: 95,
                                    failed: 0,
                                    total: 120,
                                    quality_score: 0.90
                                },
                                "claude-3-sonnet-20240229": {
                                    limited: 8,
                                    moderate: 12,
                                    extensive: 15,
                                    NA: 85,
                                    failed: 0,
                                    total: 120,
                                    quality_score: 0.86
                                },
                                "gemini-pro": {
                                    limited: 12,
                                    moderate: 18,
                                    extensive: 20,
                                    NA: 70,
                                    failed: 0,
                                    total: 120,
                                    quality_score: 0.79
                                },
                                "llama-3-70b": {
                                    limited: 18,
                                    moderate: 22,
                                    extensive: 25,
                                    NA: 55,
                                    failed: 0,
                                    total: 120,
                                    quality_score: 0.72
                                }
                            },
                            "template3_habitat": {
                                "claude-3-opus-20240229": {
                                    limited: 8,
                                    moderate: 12,
                                    extensive: 10,
                                    NA: 90,
                                    failed: 0,
                                    total: 120,
                                    quality_score: 0.88
                                },
                                "gpt-4-turbo": {
                                    limited: 12,
                                    moderate: 18,
                                    extensive: 15,
                                    NA: 75,
                                    failed: 0,
                                    total: 120,
                                    quality_score: 0.82
                                },
                                "claude-3-sonnet-20240229": {
                                    limited: 15,
                                    moderate: 20,
                                    extensive: 20,
                                    NA: 65,
                                    failed: 0,
                                    total: 120,
                                    quality_score: 0.77
                                },
                                "gemini-pro": {
                                    limited: 20,
                                    moderate: 25,
                                    extensive: 25,
                                    NA: 50,
                                    failed: 0,
                                    total: 120,
                                    quality_score: 0.70
                                },
                                "llama-3-70b": {
                                    limited: 25,
                                    moderate: 30,
                                    extensive: 30,
                                    NA: 35,
                                    failed: 0,
                                    total: 120,
                                    quality_score: 0.63
                                }
                            }
                        }
                    }
                }
            }
        };
    }
    
    // Initialize function
    function initializeQualityScoreChart(targetContainer) {
        console.log('[QualityScoreChart] Initializing...');
        loadQualityScoreData(targetContainer);
    }
    
    // Load data
    async function loadQualityScoreData(targetContainer) {
        console.log('[QualityScoreChart] Loading data...');
        const container = targetContainer || findContainer();
        if (!container) {
            console.error('[QualityScoreChart] Cannot load - no container found');
            return;
        }
        
        try {
            console.log('[QualityScoreChart] Fetching from /api/knowledge_analysis_data...');
            const response = await fetch('/api/knowledge_analysis_data');
            console.log('[QualityScoreChart] Response status:', response.status);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('[QualityScoreChart] Raw data received:', data);
            
            if (data.knowledge_analysis) {
                console.log('[QualityScoreChart] Found knowledge_analysis in response');
                // Transform the data
                const transformedData = transformKnowledgeData(data.knowledge_analysis);
                
                // Store data globally
                window.knowledgeData = transformedData;
                
                // Create the chart
                createQualityScoreBarChart(transformedData.modelData, transformedData.templateArray, container);
            } else {
                console.error('[QualityScoreChart] No knowledge_analysis in response');
                container.innerHTML = '<div class="error-message">No knowledge analysis data available</div>';
            }
        } catch (error) {
            console.error('[QualityScoreChart] Failed to load data:', error);
            // Use mock data in component viewer context
            if (window.location.pathname.includes('/components/')) {
                console.log('[QualityScoreChart] Using mock data for component viewer');
                const mockData = getMockKnowledgeAnalysisData();
                
                if (mockData.knowledge_analysis) {
                    console.log('[QualityScoreChart] Found knowledge_analysis in mock data');
                    // Transform the data
                    const transformedData = transformKnowledgeData(mockData.knowledge_analysis);
                    
                    // Store data globally
                    window.knowledgeData = transformedData;
                    
                    // Create the chart
                    createQualityScoreBarChart(transformedData.modelData, transformedData.templateArray, container);
                }
            } else {
                container.innerHTML = '<div class="error-message">Failed to load data. Please try again later.</div>';
            }
        }
    }

    // Function to create quality score bar chart
    function createQualityScoreBarChart(modelData, templateArray, targetContainer) {
        const container = targetContainer || findContainer();
        if (!container || !modelData || !templateArray) {
            console.error('[QualityScoreChart] Cannot create chart - missing data or container');
            return;
        }
    
    // Calculate scores per template for each model
    const modelScoresPerTemplate = {};
    
    Object.entries(modelData).forEach(([modelName, templates]) => {
        modelScoresPerTemplate[modelName] = {};
        let totalScore = 0;
        let totalSamples = 0;
        let hasAllTemplates = true;
        
        templateArray.forEach(templateName => {
            if (templates[templateName]) {
                let templateScore = 0;
                let templateSamples = 0;
                
                Object.values(templates[templateName]).forEach(stats => {
                    const naFailedCount = (stats.NA || 0) + (stats.no_result || 0) + (stats.inference_failed || 0);
                    const limitedCount = stats.limited || 0;
                    const moderateCount = stats.moderate || 0;
                    const extensiveCount = stats.extensive || 0;
                    templateScore += (naFailedCount * 3) + (limitedCount * 2) + (moderateCount * 1) + (extensiveCount * 0);
                    templateSamples += stats.total || 0;
                });
                
                if (templateSamples > 0) {
                    modelScoresPerTemplate[modelName][templateName] = templateScore / templateSamples;
                    totalScore += templateScore;
                    totalSamples += templateSamples;
                } else {
                    hasAllTemplates = false;
                }
            } else {
                hasAllTemplates = false;
            }
        });
        
        if (totalSamples > 0 && hasAllTemplates) {
            modelScoresPerTemplate[modelName].average = totalScore / totalSamples;
            modelScoresPerTemplate[modelName].hasAllTemplates = true;
        } else {
            // Remove models that don't have all templates
            delete modelScoresPerTemplate[modelName];
        }
    });
    
    // Sort models by average score, only including those with all templates
    const sortedModels = Object.entries(modelScoresPerTemplate)
        .filter(([_, scores]) => scores.average !== undefined && scores.hasAllTemplates)
        .sort((a, b) => b[1].average - a[1].average);
    
    if (sortedModels.length === 0) {
        container.innerHTML = '<div class="no-data">No models with complete data across all templates</div>';
        return;
    }
    
    // Define colors for each template - matching the page's color scheme
    const templateColors = {
        0: '#8b5cf6', // Purple (matching the gradient colors)
        1: '#06b6d4', // Cyan
        2: '#f59e0b'  // Amber
    };
    
    // Check if we're in a section callout wrapper
    const isInSectionCallout = container.closest('.section-callout__content') !== null;
    
    let html = `
    <div class="quality-score-chart-container">`; 
    
    // Only add title and text if not in section callout (which already has them)
    if (!isInSectionCallout) {
        html += `
        <div style="max-width: 850px; margin: 0 auto;">
            <h3 class="section-title" style="font-size: 24px; margin-bottom: 16px;">Model Quality Score Distribution by Template</h3>
            <p class="article-text" style="margin-bottom: 24px;">This chart shows quality scores for each model stratified by template. Higher scores indicate better performance at recognizing fictional species. Only models with results for all templates are shown.</p>
        </div>`;
    }
    
    html += `
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
    `;
    
    // Create a section for each template
    templateArray.forEach((template, templateIdx) => {
        // Format template name
        const formattedName = template
            .replace(/template(\d+)_/, 'Template $1: ')
            .split('_')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
            .join(' ');
        
        html += `
            <div style="background: #FAFAFA; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
                <!-- Template header -->
                <div style="background: #F9FAFB; border-bottom: 1px solid #e5e7eb; padding: 8px 10px; text-align: center;">
                    <div style="font-size: 11px; color: #6b7280; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px;">
                        ${formattedName}
                    </div>
                </div>
                <div style="padding: 12px 8px;">
        `;
    
        // Find max score for this template for scaling
        let maxScore = 0;
        sortedModels.forEach(([modelName, scores]) => {
            if (scores[template] && scores[template] > maxScore) {
                maxScore = scores[template];
            }
        });
        
        // Render bars for this template
        sortedModels.forEach(([modelName, scores], modelIndex) => {
            const displayName = modelName.split('/').pop();
            const score = scores[template] || 0;
            const percentage = maxScore > 0 ? (score / maxScore) * 100 : 0;
            
            html += `
                <div style="display: flex; align-items: center; padding: 6px 0; ${modelIndex < sortedModels.length - 1 ? 'border-bottom: 1px solid #f3f4f6;' : ''}">
                    <div style="min-width: 0; flex: 0 0 45%; font-size: 11px; color: #111827; font-weight: 500; text-align: right; padding-right: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${modelName}">
                        ${displayName}
                    </div>
                    <div style="flex: 1; min-width: 0; position: relative;">
                        <div style="position: relative; background: #f3f4f6; border-radius: 4px; overflow: hidden; height: 24px;">
                            <div class="template-bar" 
                                style="
                                    width: ${percentage}%;
                                    height: 100%;
                                    background: ${templateColors[templateIdx]};
                                    position: relative;
                                    transition: all 0.3s ease;
                                    min-width: ${score > 0 ? '40px' : '0'};
                                    display: flex;
                                    align-items: center;
                                    justify-content: flex-end;
                                    padding-right: 4px;
                                    cursor: pointer;
                                " 
                                title="${template}: ${score.toFixed(2)}"
                                onmouseover="showBarTooltip(event, this, '${template}', ${score.toFixed(2)}, '${templateColors[templateIdx]}')"
                                onmouseout="hideBarTooltip()">
                                <span style="
                                    color: white;
                                    font-size: 11px;
                                    font-weight: 600;
                                    white-space: nowrap;
                                ">${score > 0 ? score.toFixed(2) : ''}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    });
    
    html += `
        </div>
    </div>
    `;
    
    container.innerHTML = html;
}

    // Make functions globally available for component viewer
    window.initializeQualityScoreChart = initializeQualityScoreChart;
    window.loadQualityScoreData = loadQualityScoreData;

    // Bar tooltip functions
    let barTooltip = null;

    window.showBarTooltip = function(event, element, template, score, color) {
        // Hide any existing tooltip
        hideBarTooltip();
    
    // Create tooltip
    barTooltip = document.createElement('div');
    barTooltip.className = 'bar-tooltip';
    barTooltip.style.cssText = `
        position: fixed;
        z-index: 1000;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        pointer-events: none;
        white-space: nowrap;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    `;
    
    barTooltip.innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px;">
            <div style="width: 12px; height: 12px; background: ${color}; border-radius: 2px;"></div>
            <span><strong>${template}:</strong> ${score}</span>
        </div>
    `;
    document.body.appendChild(barTooltip);
    
    // Position tooltip
    const rect = element.getBoundingClientRect();
    const tooltipRect = barTooltip.getBoundingClientRect();
    
    let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
    let top = rect.top - tooltipRect.height - 8;
    
    // Ensure tooltip stays on screen
    if (left < 10) left = 10;
    if (left + tooltipRect.width > window.innerWidth - 10) {
        left = window.innerWidth - tooltipRect.width - 10;
    }
    if (top < 10) {
        top = rect.bottom + 8;
    }
    
    barTooltip.style.left = left + 'px';
    barTooltip.style.top = top + 'px';
    }

    window.hideBarTooltip = function() {
        if (barTooltip) {
            barTooltip.remove();
            barTooltip = null;
        }
    }

    // Don't auto-load, initialization is handled by setTimeout above
})();
</script>