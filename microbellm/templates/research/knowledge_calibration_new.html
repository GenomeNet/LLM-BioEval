{% extends "base.html" %}

{% block title %}{{ manifest.page_config.title }} - LLM-BioEval{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/article_styles.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/research/knowledge_calibration/page_specific.css') }}">
{% endblock %}

{% block content %}
<!-- Background Animation -->
<canvas id="background-canvas" class="background-canvas"></canvas>

<!-- Main Content with proper spacing -->
<div class="main-content page-content">
{% include 'partials/hero_header.html' %}

{% set article_open = false %}
{% set sidebar_html = "" %}

{% for section in manifest.sections %}
    {# Handle article sections #}
    {% if section.type == 'article' %}
        {% if article_open %}
            {# Close previous article if open #}
            </article>
        </div>
        {% if sidebar_html %}
        <aside class="article-sidebar">
            {{ sidebar_html | safe }}
        </aside>
        {% endif %}
    </div>
            {% set sidebar_html = "" %}
        {% endif %}
        
        {# Start new article section #}
        <div class="article-container">
            <div class="article-main">
                <article class="article-content">
                    {% if section.section_id %}<section id="{{ section.section_id }}" class="article-section">{% endif %}
                    {% if section.title %}<h1 class="main-section-title">{{ section.title }}</h1>{% endif %}
                    <div class="article-text">
                        {% include 'research/knowledge_calibration/' + section.file %}
                    </div>
                    {% if section.section_id %}</section>{% endif %}
        {% set article_open = true %}
        
        {# Handle sidebar if specified #}
        {% if section.include_sidebar %}
            {% set sidebar_html %}
            <!-- Paper Info Card -->
            <div class="paper-info-card">
                <h3>Paper Info</h3>
                <ul class="paper-info-list">
                    <li><strong>Title:</strong> {{ project.title }}</li>
                    <li><strong>Author:</strong> {{ project.authors | replace('by ', '') }}</li>
                    {% if project.doi %}
                    <li><strong>DOI:</strong> <a href="https://doi.org/{{ project.doi }}" target="_blank">{{ project.doi }}</a></li>
                    {% else %}
                    <li><strong>Status:</strong> Manuscript in preparation</li>
                    {% endif %}
                </ul>
            </div>
            {% endset %}
        {% endif %}
        
    {# Handle inline callouts within article sections #}
    {% elif section.type == 'callout_inline' and section.parent_type == 'article' %}
        {% set callout_content %}
            {% include 'research/knowledge_calibration/' + section.file %}
        {% endset %}
        {% with type=section.callout_type, header=section.header, content=callout_content, compact=section.compact %}
            {% include 'partials/callout_box_wrapper.html' %}
        {% endwith %}
        
    {# Handle article content continuation #}
    {% elif section.type == 'article_content' and section.parent_type == 'article' %}
        {% include 'research/knowledge_calibration/' + section.file %}
        
        {# Close article if specified #}
        {% if section.close_article %}
                </article>
            </div>
            {% if sidebar_html %}
            <aside class="article-sidebar">
                {{ sidebar_html | safe }}
            </aside>
            {% endif %}
        </div>
            {% set article_open = false %}
            {% set sidebar_html = "" %}
        {% endif %}
        
    {# Handle section callouts #}
    {% elif section.type == 'section_callout' %}
        {% set section_content %}
            {% include 'research/knowledge_calibration/' + section.file %}
        {% endset %}
        {% with color_theme=manifest.page_config.color_theme, title=section.title, text=section.text, content=section_content, full_width=section.full_width %}
            {% include 'partials/section_callout_wrapper.html' %}
        {% endwith %}
        
    {# Handle dynamic section callouts #}
    {% elif section.type == 'section_callout_dynamic' %}
        {# For dynamic content, we include the file directly which contains the loading container #}
        {% include 'research/knowledge_calibration/' + section.file %}
        
    {# Handle raw includes #}
    {% elif section.type == 'raw' %}
        {% include 'research/knowledge_calibration/' + section.file %}
        
    {% endif %}
{% endfor %}

{# Close article if still open #}
{% if article_open %}
        </article>
    </div>
    {% if sidebar_html %}
    <aside class="article-sidebar">
        {{ sidebar_html | safe }}
    </aside>
    {% endif %}
</div>
{% endif %}

</div> <!-- Close main-content -->

<!-- Footer -->
{% include 'partials/footer.html' %}

<!-- Page-specific scripts -->
{% for section in manifest.sections %}
    {% if section.scripts %}
        {% for script in section.scripts %}
        <script src="{{ url_for('static', filename=script) }}"></script>
        {% endfor %}
    {% endif %}
{% endfor %}

<!-- Background animation script (from original template) -->
<script>
function initBackgroundAnimation() {
    const canvas = document.getElementById('background-canvas');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    let width, height;
    let columns = [];
    
    function resizeCanvas() {
        width = canvas.width = 300;
        height = canvas.height = window.innerHeight;
        initColumns();
    }
    
    function initColumns() {
        columns = [];
        const columnWidth = 8;
        const gap = 2;
        const totalWidth = columnWidth + gap;
        const numColumns = Math.ceil(width / totalWidth);
        
        for (let i = 0; i < numColumns; i++) {
            const segments = [];
            const numSegments = 30;
            
            for (let j = 0; j < numSegments; j++) {
                segments.push({
                    height: 3 + Math.random() * 12,
                    opacity: 0.05 + Math.random() * 0.15,
                    offset: Math.random() * height
                });
            }
            
            columns.push({
                x: i * totalWidth,
                segments: segments,
                speed: 0.5 + Math.random() * 0.5
            });
        }
    }
    
    let frame = 0;
    function animate() {
        ctx.clearRect(0, 0, width, height);
        
        columns.forEach(column => {
            column.segments.forEach((segment, index) => {
                const y = (segment.offset + frame * column.speed * 0.3) % height;
                
                ctx.fillStyle = `rgba(147, 51, 234, ${segment.opacity})`;
                ctx.fillRect(column.x, y, 8, segment.height);
            });
        });
        
        frame++;
        requestAnimationFrame(animate);
    }
    
    resizeCanvas();
    animate();
    
    window.addEventListener('resize', resizeCanvas);
}

// Initialize background animation
document.addEventListener('DOMContentLoaded', function() {
    initBackgroundAnimation();
});
</script>

{% endblock %}