{% extends "base.html" %}

{% block title %}Export Results - MicrobeBench{% endblock %}

{% block content %}
<div class="page-header mb-3">
    <h2>Export Results</h2>
    <p class="text-muted">Export your processing results to CSV format</p>
</div>

<div class="nav-links mb-3">
    <a href="/" class="btn btn-ghost btn-sm">‚Üê Back to Dashboard</a>
</div>

<div class="card">
    <h3>Export Options</h3>
    
    <div class="export-controls">
        <div class="export-filters mb-3">
            <div class="filter-group">
                <label class="setting-label">Filter by Species File</label>
                <select id="speciesFilter" class="form-control">
                    <option value="">All species files</option>
                    {% for file in species_files %}
                        <option value="{{ file }}">{{ file }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-group mt-2">
                <label class="setting-label">Filter by Model</label>
                <select id="modelFilter" class="form-control">
                    <option value="">All models</option>
                    {% for model in models %}
                        <option value="{{ model }}">{{ model }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <div class="export-info card mb-3" style="background: var(--bg-secondary);">
            <h4 class="text-small">Export includes</h4>
            <ul class="text-small text-muted">
                <li>Species names and processing status</li>
                <li>Model predictions and extracted phenotypes</li>
                <li>Error messages for failed predictions</li>
                <li>Timestamps and metadata</li>
            </ul>
        </div>
        
        <div class="export-actions">
            <button onclick="exportResults()" class="btn btn-primary">
                <i class="fas fa-download"></i> Export to CSV
            </button>
            
            <div id="exportStatus" class="mt-2"></div>
        </div>
    </div>
</div>

<style>
    .page-header {
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 16px;
    }
    
    .nav-links {
        padding: 8px 0;
    }
    
    .export-controls {
        max-width: 600px;
    }
    
    .filter-group {
        margin-bottom: 16px;
    }
    
    .export-info {
        padding: 16px;
    }
    
    .export-info h4 {
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .export-info ul {
        margin: 0;
        padding-left: 20px;
    }
    
    .export-actions {
        margin-top: 24px;
    }
    
    #exportStatus {
        font-size: 12px;
    }
    
    #exportStatus.success {
        color: var(--accent-secondary);
    }
    
    #exportStatus.error {
        color: var(--accent-error);
    }
</style>

<script>
    function exportResults() {
        const speciesFile = document.getElementById('speciesFilter').value;
        const model = document.getElementById('modelFilter').value;
        const statusDiv = document.getElementById('exportStatus');
        
        // Build query parameters
        const params = new URLSearchParams();
        if (speciesFile) params.append('species_file', speciesFile);
        if (model) params.append('model', model);
        
        statusDiv.textContent = 'Preparing export...';
        statusDiv.className = '';
        
        fetch('/api/export_csv?' + params.toString())
            .then(response => {
                if (!response.ok) {
                    throw new Error('Export failed');
                }
                return response.blob();
            })
            .then(blob => {
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `microbebench_export_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
                
                statusDiv.textContent = 'Export completed successfully!';
                statusDiv.className = 'success';
            })
            .catch(error => {
                console.error('Export error:', error);
                statusDiv.textContent = 'Error: Export failed. Please try again.';
                statusDiv.className = 'error';
            });
    }
</script>
{% endblock %} 