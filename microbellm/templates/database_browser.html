{% extends "admin_base.html" %}

{% block title %}Database Browser - MicrobeLLM{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="page-header">
        <h1 class="page-title">Database Browser</h1>
        <p class="page-subtitle">Browse and inspect the database structure and data</p>
    </div>

    <div class="dashboard-header">
        <div class="dashboard-controls">
            <a href="/" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
            <button onclick="refreshDatabaseBrowser()" class="btn btn-secondary" id="refreshBtn">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Database Browser Section -->
    <div class="database-browser-section">
        <div class="database-browser">
            <div class="database-info">
                <h3>Database Structure</h3>
                <p id="databasePath"></p>
                <div id="loadingIndicator" class="text-center" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i> Loading database structure...
                </div>
                <div class="database-tables" id="databaseTables">
                    <!-- Tables will be loaded here -->
                </div>
            </div>
            
            <div class="table-viewer" id="tableViewer" style="display: none;">
                <h3>Table Data: <span id="currentTableName"></span></h3>
                <div class="table-controls">
                    <button onclick="closeDatabaseTable()" class="btn btn-secondary">Back to Tables</button>
                </div>
                <div id="tableData" class="table-data">
                    <!-- Table data will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Database Browser Styles */
    .database-browser-section {
        margin-top: 20px;
    }
    
    .database-browser {
        background: #f8f9fa;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        margin-top: 10px;
    }
    
    .database-tree {
        margin-top: 15px;
    }
    
    .table-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .table-item:hover {
        background: #f0f8ff;
        border-color: #3b82f6;
    }
    
    .table-info {
        flex: 1;
    }
    
    .table-name {
        font-weight: 600;
        color: #333;
        margin-bottom: 4px;
    }
    
    .table-stats {
        font-size: 0.9em;
        color: #666;
        display: flex;
        gap: 15px;
    }
    
    .table-actions {
        display: flex;
        gap: 8px;
    }
    
    .table-btn {
        padding: 4px 8px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        font-size: 0.8em;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .table-btn:hover {
        background: #f8f9fa;
        border-color: #3b82f6;
    }
    
    .database-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .database-table th {
        background: #f1f3f4;
        font-weight: 600;
        padding: 8px;
        border-bottom: 2px solid #ddd;
    }
    
    .database-table td {
        padding: 6px 8px;
        border-bottom: 1px solid #eee;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .database-table em {
        color: #999;
        font-style: italic;
    }
    
    .table-info {
        margin-bottom: 10px;
        color: #666;
    }
    
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .section-header h2 {
        margin: 0;
        color: #333;
    }
    
    .error {
        color: #d32f2f;
        font-style: italic;
    }
</style>

<script>
    // Database browser functionality
    function loadDatabaseInfo() {
        const loadingIndicator = document.getElementById('loadingIndicator');
        const tablesContainer = document.getElementById('databaseTables');

        // Show loading indicator
        loadingIndicator.style.display = 'block';
        tablesContainer.innerHTML = '';

        fetch('/api/database_info')
            .then(response => response.json())
            .then(data => {
                // Hide loading indicator
                loadingIndicator.style.display = 'none';

                if (data.success) {
                    document.getElementById('databasePath').textContent = data.database_path;

                    const tablesHtml = data.tables.map(table => `
                        <div class="table-item" onclick="loadTableData('${table.name}')">
                            <div class="table-info">
                                <div class="table-name">${table.name}</div>
                                <div class="table-stats">
                                    <span>Rows: ${table.row_count}</span>
                                    <span>Columns: ${table.column_count}</span>
                                </div>
                            </div>
                            <div class="table-actions">
                                <button class="table-btn" onclick="event.stopPropagation(); loadTableData('${table.name}')">
                                    <i class="fas fa-eye"></i> View
                                </button>
                            </div>
                        </div>
                    `).join('');

                    tablesContainer.innerHTML = tablesHtml;
                } else {
                    console.error('Error loading database info:', data.error);
                    tablesContainer.innerHTML = '<p class="error">Error loading database structure</p>';
                }
            })
            .catch(error => {
                // Hide loading indicator
                loadingIndicator.style.display = 'none';
                console.error('Error loading database info:', error);
                tablesContainer.innerHTML = '<p class="error">Failed to load database structure</p>';
            });
    }
    
    function loadTableData(tableName) {
        document.getElementById('currentTableName').textContent = tableName;
        document.getElementById('tableViewer').style.display = 'block';
        
        fetch(`/api/table_data/${tableName}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const tableData = document.getElementById('tableData');
                    
                    if (data.data.length === 0) {
                        tableData.innerHTML = '<p class="text-muted">No data found in this table.</p>';
                        return;
                    }
                    
                    // Create table HTML
                    const headers = Object.keys(data.data[0]);
                    const tableHtml = `
                        <div class="table-info">
                            <strong>Table:</strong> ${tableName} (${data.data.length} rows)
                        </div>
                        <table class="database-table">
                            <thead>
                                <tr>
                                    ${headers.map(header => `<th>${header}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${data.data.map(row => `
                                    <tr>
                                        ${headers.map(header => `<td>${row[header] || '<em>NULL</em>'}</td>`).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                    
                    tableData.innerHTML = tableHtml;
                } else {
                    document.getElementById('tableData').innerHTML = `<p class="error">Error loading table data: ${data.error}</p>`;
                }
            })
            .catch(error => {
                document.getElementById('tableData').innerHTML = `<p class="error">Error loading table data: ${error.message}</p>`;
            });
    }
    
    function closeDatabaseTable() {
        document.getElementById('tableViewer').style.display = 'none';
    }
    
    function refreshDatabaseBrowser() {
        const refreshBtn = document.getElementById('refreshBtn');
        refreshBtn.disabled = true;
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';

        loadDatabaseInfo();

        // Re-enable button after a short delay
        setTimeout(() => {
            refreshBtn.disabled = false;
            refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
        }, 1000);
    }
    
    // Initialize
    loadDatabaseInfo();
</script>
{% endblock %}