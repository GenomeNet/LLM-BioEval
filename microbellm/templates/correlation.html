{% extends "base.html" %}

{% block title %}Search Count Correlation Analysis - MicrobeBench{% endblock %}

{% block content %}
<h1>Search Count Correlation Analysis</h1>

<div class="dashboard-controls">
    <a href="/" class="btn btn-primary">
        <i class="fas fa-tachometer-alt"></i> Dashboard
    </a>
    <a href="/compare" class="btn btn-secondary">
        <i class="fas fa-balance-scale"></i> Compare Results
    </a>
    <a href="/settings" class="btn btn-secondary">
        <i class="fas fa-cog"></i> Settings
    </a>
</div>

<div class="correlation-controls modern-form-container">
    <div class="modern-form-control">
        <label for="datasetSelector" class="modern-form-label">Dataset</label>
        <select id="datasetSelector" class="modern-select" onchange="switchDataset()">
            <option value="">Select a dataset with search counts...</option>
        </select>
    </div>
    
    <div class="modern-form-control">
        <label for="templateSelector" class="modern-form-label">Template</label>
        <select id="templateSelector" class="modern-select" onchange="updateCorrelationView()">
            <option value="">All Templates</option>
        </select>
    </div>
    
    <div class="modern-form-control">
        <label for="sortingMethod" class="modern-form-label">Sort Models By</label>
        <select id="sortingMethod" class="modern-select" onchange="updateCorrelationView()">
            <option value="correlation">Correlation Coefficient (Highest first)</option>
            <option value="correlation_abs">Absolute Correlation (Strongest first)</option>
            <option value="species_count">Number of Species (Most data first)</option>
            <option value="alphabetical">Model Name (Alphabetical)</option>
        </select>
    </div>
</div>

<div id="correlationContent">
    <div class="loading">Loading correlation analysis data...</div>
</div>

<style>
    .correlation-controls {
        margin-bottom: 25px;
    }
    
    .correlation-overview {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 25px;
    }
    
    .correlation-overview h3 {
        margin-top: 0;
        color: #495057;
    }
    
    .correlation-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        transition: transform 0.2s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .stat-card.positive {
        border-color: #28a745;
        background-color: #f8fff9;
    }
    
    .stat-card.negative {
        border-color: #dc3545;
        background-color: #fff8f8;
    }
    
    .stat-card.neutral {
        border-color: #6c757d;
        background-color: #f8f9fa;
    }
    
    .stat-number {
        font-size: 28px;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 5px;
    }
    
    .stat-label {
        font-size: 14px;
        color: #6c757d;
        font-weight: 500;
    }
    
    .correlation-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin-top: 20px;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .correlation-table th {
        background-color: #f8f9fa;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .correlation-table td {
        padding: 10px 12px;
        border-bottom: 1px solid #f0f0f0;
        vertical-align: middle;
    }
    
    .correlation-table tr:hover {
        background-color: #f8f9fa;
    }
    
    .model-name-cell {
        font-weight: 600;
        color: #2c3e50;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .correlation-value {
        text-align: center;
        font-weight: 600;
        font-size: 16px;
    }
    
    .correlation-value.strong-positive {
        color: #28a745;
    }
    
    .correlation-value.moderate-positive {
        color: #17a2b8;
    }
    
    .correlation-value.weak {
        color: #6c757d;
    }
    
    .correlation-value.moderate-negative {
        color: #fd7e14;
    }
    
    .correlation-value.strong-negative {
        color: #dc3545;
    }
    
    .species-count {
        text-align: center;
        color: #495057;
        font-size: 14px;
    }
    
    .knowledge-dist {
        display: flex;
        gap: 5px;
        justify-content: center;
        align-items: center;
    }
    
    .dist-bar {
        height: 20px;
        min-width: 2px;
        border-radius: 2px;
        position: relative;
        cursor: help;
    }
    
    .dist-limited {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
    }
    
    .dist-moderate {
        background-color: #d1ecf1;
        border: 1px solid #bee5eb;
    }
    
    .dist-extensive {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
    }
    
    .dist-na {
        background-color: #e2e3e5;
        border: 1px solid #d6d8db;
    }
    
    .correlation-scatter {
        margin: 20px 0;
        padding: 20px;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
    }
    
    .scatter-container {
        width: 100%;
        height: 400px;
        position: relative;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        overflow: hidden;
    }
    
    .scatter-plot {
        width: 100%;
        height: 100%;
    }
    
    .loading {
        text-align: center;
        padding: 40px;
        color: #6c757d;
        font-style: italic;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px;
        color: #6c757d;
    }
    
    .empty-state h3 {
        color: #495057;
        margin-bottom: 10px;
    }
    
    .template-section {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        margin-bottom: 20px;
        overflow: hidden;
    }
    
    .template-header {
        background-color: #f8f9fa;
        padding: 15px 20px;
        border-bottom: 1px solid #dee2e6;
        font-weight: 600;
        color: #495057;
    }
    
    .template-content {
        padding: 0;
    }
    
    .correlation-legend {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        font-size: 12px;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 3px;
    }
    
    .method-description {
        background: #e3f2fd;
        border: 1px solid #bbdefb;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .method-description h4 {
        margin-top: 0;
        color: #1976d2;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    let correlationData = null;
    
    // Load correlation data on page load
    loadCorrelationData();
    
    function loadCorrelationData() {
        fetch('/api/search_count_correlation')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('correlationContent').innerHTML = 
                        `<div class="empty-state"><h3>Error loading correlation data</h3><p>${data.error}</p></div>`;
                    return;
                }
                
                correlationData = data;
                
                if (data.files_with_search_counts.length === 0) {
                    document.getElementById('correlationContent').innerHTML = 
                        '<div class="empty-state"><h3>No datasets with search counts found</h3><p>Upload a CSV file with a "Search Count" column to see correlation analysis.</p></div>';
                    return;
                }
                
                // Populate dataset selector
                const datasetSelector = document.getElementById('datasetSelector');
                datasetSelector.innerHTML = '<option value="">Select a dataset with search counts...</option>';
                
                data.files_with_search_counts.forEach(filename => {
                    const displayName = filename.replace(/\.(txt|csv)$/i, '');
                    const option = document.createElement('option');
                    option.value = filename;
                    option.textContent = displayName;
                    datasetSelector.appendChild(option);
                });
                
                // Auto-select first dataset if only one available
                if (data.files_with_search_counts.length === 1) {
                    datasetSelector.value = data.files_with_search_counts[0];
                    switchDataset();
                } else {
                    showOverviewContent();
                }
            })
            .catch(error => {
                console.error('Error loading correlation data:', error);
                document.getElementById('correlationContent').innerHTML = 
                    '<div class="empty-state"><h3>Error loading data</h3><p>' + error.message + '</p></div>';
            });
    }
    
    function showOverviewContent() {
        const content = document.getElementById('correlationContent');
        
        let html = '<div class="method-description">';
        html += '<h4>Search Count Correlation Analysis</h4>';
        html += '<p><strong>Purpose:</strong> Analyze the relationship between Google search result counts and LLM knowledge level predictions.</p>';
        html += '<p><strong>Methodology:</strong> Correlation coefficients are calculated between log-transformed search counts and numerical knowledge scores (Limited=1, Moderate=2, Extensive=3). Higher positive correlations suggest the model\'s confidence aligns with publicly available information.</p>';
        html += '<p><strong>Interpretation:</strong> Models with higher positive correlations are better calibrated to real-world knowledge availability. Models with negative correlations may be contrarian or poorly calibrated.</p>';
        html += '</div>';
        
        html += '<div class="correlation-stats">';
        
        let totalDatasets = correlationData.files_with_search_counts.length;
        let totalModels = 0;
        let avgCorrelation = 0;
        let correlationCount = 0;
        
        // Calculate overview statistics
        correlationData.files_with_search_counts.forEach(filename => {
            const fileData = correlationData.correlation_data[filename];
            Object.values(fileData).forEach(templateData => {
                Object.values(templateData).forEach(modelData => {
                    totalModels++;
                    avgCorrelation += modelData.correlation_coefficient;
                    correlationCount++;
                });
            });
        });
        
        avgCorrelation = correlationCount > 0 ? avgCorrelation / correlationCount : 0;
        
        html += `<div class="stat-card neutral">`;
        html += `<div class="stat-number">${totalDatasets}</div>`;
        html += `<div class="stat-label">Datasets with Search Counts</div>`;
        html += `</div>`;
        
        html += `<div class="stat-card neutral">`;
        html += `<div class="stat-number">${totalModels}</div>`;
        html += `<div class="stat-label">Total Model Analyses</div>`;
        html += `</div>`;
        
        const correlationClass = avgCorrelation > 0.3 ? 'positive' : avgCorrelation < -0.3 ? 'negative' : 'neutral';
        html += `<div class="stat-card ${correlationClass}">`;
        html += `<div class="stat-number">${avgCorrelation.toFixed(3)}</div>`;
        html += `<div class="stat-label">Average Correlation</div>`;
        html += `</div>`;
        
        html += '</div>';
        
        html += '<p style="color: #6c757d; text-align: center; margin-top: 20px;">Select a dataset above to view detailed correlation analysis.</p>';
        
        content.innerHTML = html;
    }
    
    function switchDataset() {
        const selectedDataset = document.getElementById('datasetSelector').value;
        
        if (!selectedDataset || !correlationData) {
            showOverviewContent();
            return;
        }
        
        const fileData = correlationData.correlation_data[selectedDataset];
        
        // Populate template selector
        const templateSelector = document.getElementById('templateSelector');
        templateSelector.innerHTML = '<option value="">All Templates</option>';
        
        const templates = Object.keys(fileData);
        templates.forEach(templateName => {
            const option = document.createElement('option');
            option.value = templateName;
            option.textContent = templateName;
            templateSelector.appendChild(option);
        });
        
        updateCorrelationView();
    }
    
    function updateCorrelationView() {
        const selectedDataset = document.getElementById('datasetSelector').value;
        const selectedTemplate = document.getElementById('templateSelector').value;
        const sortingMethod = document.getElementById('sortingMethod').value;
        
        if (!selectedDataset || !correlationData) {
            return;
        }
        
        const fileData = correlationData.correlation_data[selectedDataset];
        const content = document.getElementById('correlationContent');
        
        let html = '<div class="method-description">';
        html += '<h4>Search Count Correlation Analysis</h4>';
        html += '<p><strong>Dataset:</strong> ' + selectedDataset.replace(/\.(txt|csv)$/i, '') + '</p>';
        html += '<p><strong>Correlation:</strong> Log(Search Count) vs Knowledge Level (Limited=1, Moderate=2, Extensive=3). Higher positive correlations indicate better alignment with public knowledge availability.</p>';
        html += '</div>';
        
        // Collect and sort model data
        let modelResults = [];
        
        Object.entries(fileData).forEach(([templateName, models]) => {
            if (selectedTemplate && templateName !== selectedTemplate) return;
            
            Object.entries(models).forEach(([modelName, data]) => {
                if (data.species_count < 2) return; // Skip models with insufficient data
                
                modelResults.push({
                    modelName,
                    templateName,
                    correlation: data.correlation_coefficient,
                    speciesCount: data.species_count,
                    knowledgeDist: data.knowledge_distribution,
                    dataPoints: data.data_points
                });
            });
        });
        
        // Sort models based on selected method
        modelResults.sort((a, b) => {
            switch(sortingMethod) {
                case 'correlation':
                    return b.correlation - a.correlation;
                case 'correlation_abs':
                    return Math.abs(b.correlation) - Math.abs(a.correlation);
                case 'species_count':
                    return b.speciesCount - a.speciesCount;
                case 'alphabetical':
                    return a.modelName.localeCompare(b.modelName);
                default:
                    return b.correlation - a.correlation;
            }
        });
        
        if (modelResults.length === 0) {
            html += '<div class="empty-state"><h3>No correlation data available</h3><p>No models have sufficient data points for correlation analysis.</p></div>';
            content.innerHTML = html;
            return;
        }
        
        // Statistics
        const avgCorrelation = modelResults.reduce((sum, m) => sum + m.correlation, 0) / modelResults.length;
        const maxCorrelation = Math.max(...modelResults.map(m => m.correlation));
        const minCorrelation = Math.min(...modelResults.map(m => m.correlation));
        const totalSpecies = modelResults.reduce((sum, m) => sum + m.speciesCount, 0);
        
        html += '<div class="correlation-stats">';
        html += `<div class="stat-card ${avgCorrelation > 0.3 ? 'positive' : avgCorrelation < -0.3 ? 'negative' : 'neutral'}">`;
        html += `<div class="stat-number">${avgCorrelation.toFixed(3)}</div>`;
        html += `<div class="stat-label">Average Correlation</div>`;
        html += `</div>`;
        
        html += `<div class="stat-card ${maxCorrelation > 0.5 ? 'positive' : 'neutral'}">`;
        html += `<div class="stat-number">${maxCorrelation.toFixed(3)}</div>`;
        html += `<div class="stat-label">Highest Correlation</div>`;
        html += `</div>`;
        
        html += `<div class="stat-card ${minCorrelation < -0.3 ? 'negative' : 'neutral'}">`;
        html += `<div class="stat-number">${minCorrelation.toFixed(3)}</div>`;
        html += `<div class="stat-label">Lowest Correlation</div>`;
        html += `</div>`;
        
        html += `<div class="stat-card neutral">`;
        html += `<div class="stat-number">${modelResults.length}</div>`;
        html += `<div class="stat-label">Models Analyzed</div>`;
        html += `</div>`;
        html += '</div>';
        
        // Correlation legend
        html += '<div class="correlation-legend">';
        html += '<span><strong>Correlation Strength:</strong></span>';
        html += '<div class="legend-item"><span class="legend-color" style="background-color: #28a745;"></span>Strong Positive (≥0.7)</div>';
        html += '<div class="legend-item"><span class="legend-color" style="background-color: #17a2b8;"></span>Moderate Positive (0.3-0.7)</div>';
        html += '<div class="legend-item"><span class="legend-color" style="background-color: #6c757d;"></span>Weak (-0.3-0.3)</div>';
        html += '<div class="legend-item"><span class="legend-color" style="background-color: #fd7e14;"></span>Moderate Negative (-0.7--0.3)</div>';
        html += '<div class="legend-item"><span class="legend-color" style="background-color: #dc3545;"></span>Strong Negative (≤-0.7)</div>';
        html += '</div>';
        
        // Group by template if showing all templates
        if (!selectedTemplate) {
            const byTemplate = {};
            modelResults.forEach(result => {
                if (!byTemplate[result.templateName]) {
                    byTemplate[result.templateName] = [];
                }
                byTemplate[result.templateName].push(result);
            });
            
            Object.entries(byTemplate).forEach(([templateName, results]) => {
                html += `<div class="template-section">`;
                html += `<div class="template-header">${templateName}</div>`;
                html += `<div class="template-content">`;
                html += renderCorrelationTable(results);
                html += `</div>`;
                html += `</div>`;
            });
        } else {
            html += renderCorrelationTable(modelResults);
        }
        
        content.innerHTML = html;
    }
    
    function renderCorrelationTable(modelResults) {
        let html = '<table class="correlation-table">';
        html += '<thead><tr>';
        html += '<th>Model</th>';
        html += '<th style="text-align: center;">Correlation</th>';
        html += '<th style="text-align: center;">Species Count</th>';
        html += '<th style="text-align: center;">Knowledge Distribution</th>';
        html += '<th style="text-align: center;">Interpretation</th>';
        html += '</tr></thead><tbody>';
        
        modelResults.forEach(result => {
            const correlationClass = getCorrelationClass(result.correlation);
            const interpretation = getCorrelationInterpretation(result.correlation);
            
            html += '<tr>';
            html += `<td class="model-name-cell" title="${result.modelName}">${result.modelName.split('/').pop()}</td>`;
            html += `<td class="correlation-value ${correlationClass}">${result.correlation.toFixed(3)}</td>`;
            html += `<td class="species-count">${result.speciesCount}</td>`;
            html += `<td>${renderKnowledgeDistribution(result.knowledgeDist, result.speciesCount)}</td>`;
            html += `<td style="text-align: center; font-size: 12px; color: #495057;">${interpretation}</td>`;
            html += '</tr>';
        });
        
        html += '</tbody></table>';
        
        return html;
    }
    
    function getCorrelationClass(correlation) {
        if (correlation >= 0.7) return 'strong-positive';
        if (correlation >= 0.3) return 'moderate-positive';
        if (correlation <= -0.7) return 'strong-negative';
        if (correlation <= -0.3) return 'moderate-negative';
        return 'weak';
    }
    
    function getCorrelationInterpretation(correlation) {
        if (correlation >= 0.7) return 'Excellent alignment';
        if (correlation >= 0.5) return 'Good alignment';
        if (correlation >= 0.3) return 'Moderate alignment';
        if (correlation >= 0.1) return 'Weak positive';
        if (correlation >= -0.1) return 'No relationship';
        if (correlation >= -0.3) return 'Weak negative';
        if (correlation >= -0.5) return 'Moderate contrarian';
        return 'Strong contrarian';
    }
    
    function renderKnowledgeDistribution(dist, total) {
        const maxWidth = 100;
        let html = '<div class="knowledge-dist" style="width: ' + maxWidth + 'px;">';
        
        const categories = ['limited', 'moderate', 'extensive', 'NA'];
        const colors = ['dist-limited', 'dist-moderate', 'dist-extensive', 'dist-na'];
        
        categories.forEach((category, index) => {
            const count = dist[category] || 0;
            const width = total > 0 ? Math.max(2, (count / total) * maxWidth) : 0;
            
            if (count > 0) {
                html += `<div class="dist-bar ${colors[index]}" style="width: ${width}px;" title="${category}: ${count} (${(count/total*100).toFixed(1)}%)"></div>`;
            }
        });
        
        html += '</div>';
        return html;
    }
</script>
{% endblock %} 