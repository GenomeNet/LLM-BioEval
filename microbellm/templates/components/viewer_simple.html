{% extends "base.html" %}

{% block title %}{{ section.id }} - Component Viewer{% endblock %}

{% block extra_head %}
<!-- Include component styles -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/article_styles.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/component_styles.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/research/' + page + '/page_specific.css') }}">

<!-- Export Scripts -->
<script src="{{ url_for('static', filename='js/svg_export.js') }}"></script>
<script src="{{ url_for('static', filename='js/svg_export_pure.js') }}"></script>
<script src="{{ url_for('static', filename='js/export_visual.js') }}"></script>
<script src="{{ url_for('static', filename='js/export_data.js') }}"></script>

<style>
/* Component viewer specific styles */
.viewer-container {
    padding: 20px;
    min-height: 100vh;
    background: #f8f9fa;
}

.viewer-header {
    background: white;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.viewer-title {
    font-size: 28px;
    font-weight: 700;
    color: #1f2937;
    margin: 0 0 8px 0;
}

.viewer-meta {
    display: flex;
    gap: 16px;
    color: #6b7280;
    font-size: 14px;
}

.viewer-badge {
    background: #e5e7eb;
    color: #374151;
    padding: 4px 12px;
    border-radius: 6px;
    font-weight: 500;
    font-size: 12px;
}

.viewer-content-wrapper {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    overflow: hidden;
    position: relative;
}

.viewer-content {
    padding: 0;
    margin: 0;
}

/* Ensure section callout components display properly in viewer */
.viewer-content .section-callout {
    margin: 0;
    border-radius: 0;
    border: none;
}

.viewer-content .section-callout__content {
    padding: 32px;
    max-width: none;
}


/* Fix for dynamic components */
.viewer-content .model-accuracy-container {
    margin: 0;
    padding: 0;
    min-height: 400px;
}

/* Navigation styles */
.viewer-navigation {
    margin-top: 24px;
    text-align: center;
    padding: 20px;
}

.viewer-nav-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    background: #6366f1;
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.2s;
    margin: 0 8px;
}

.viewer-nav-link:hover {
    background: #5048e5;
    transform: translateY(-1px);
}

.viewer-nav-link.secondary {
    background: #6b7280;
}

.viewer-nav-link.secondary:hover {
    background: #4b5563;
}

/* Export button styles */
.export-controls {
    position: absolute;
    top: 24px;
    right: 24px;
    display: flex;
    gap: 8px;
    z-index: 10;
}

.export-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    background: #10b981;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    font-family: inherit;
}

.export-btn:hover {
    background: #059669;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.export-btn:active {
    transform: translateY(0);
}

.export-btn svg {
    width: 16px;
    height: 16px;
}

.export-dropdown {
    position: relative;
}

.export-menu {
    position: absolute;
    top: 100%;
    right: 0;
    margin-top: 4px;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    display: none;
    min-width: 200px;
    z-index: 100;
}

.export-menu.show {
    display: block;
}

.export-menu-item {
    display: block;
    width: 100%;
    padding: 10px 16px;
    background: none;
    border: none;
    text-align: left;
    font-size: 14px;
    color: #374151;
    cursor: pointer;
    transition: all 0.2s;
    font-family: inherit;
}

.export-menu-item:hover {
    background: #f3f4f6;
    color: #111827;
}

.export-menu-item:first-child {
    border-radius: 8px 8px 0 0;
}

.export-menu-item:last-child {
    border-radius: 0 0 8px 8px;
}

/* Spinner animation */
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Ensure interactive elements work */
.viewer-content button,
.viewer-content select,
.viewer-content input {
    cursor: pointer;
}

/* Fix loading overlays in viewer context */
.viewer-content .loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    z-index: 1000;
}

/* Ensure tables are responsive in viewer */
.viewer-content .accuracy-table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

@media (max-width: 768px) {
    .viewer-container {
        padding: 12px;
    }

    .viewer-navigation {
        padding: 12px;
    }

    .viewer-nav-link {
        padding: 10px 16px;
        font-size: 14px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="viewer-container">
    <!-- Header -->
    <div class="viewer-header">
        <h1 class="viewer-title">{{ section.id | replace('_', ' ') | title }}</h1>
        <div class="viewer-meta">
            <span class="viewer-badge">{{ section.type | replace('_', ' ') | title }}</span>
            <span>Page: {{ page | replace('_', ' ') | title }}</span>
            {% if section.file %}
            <span>File: {{ section.file }}</span>
            {% endif %}
            {% if manifest.page_config.color_theme %}
            <span>Theme: {{ manifest.page_config.color_theme }}</span>
            {% endif %}
        </div>
    </div>

    <!-- Component Content -->
    <div class="viewer-content-wrapper">
        <!-- Export Controls -->
        <div class="export-controls">
            <div class="export-dropdown">
                <button class="export-btn" onclick="toggleExportMenu(event)">
                    <svg viewBox="0 0 16 16" fill="currentColor">
                        <path d="M2.75 14A1.75 1.75 0 0 1 1 12.25v-2.5a.75.75 0 0 1 1.5 0v2.5c0 .138.112.25.25.25h10.5a.25.25 0 0 0 .25-.25v-2.5a.75.75 0 0 1 1.5 0v2.5A1.75 1.75 0 0 1 13.25 14Z"/>
                        <path d="M7.25 7.689V2a.75.75 0 0 1 1.5 0v5.689l1.97-1.969a.749.749 0 1 1 1.06 1.06l-3.25 3.25a.749.749 0 0 1-1.06 0L4.22 6.78a.749.749 0 1 1 1.06-1.06l1.97 1.969Z"/>
                    </svg>
                    Export
                    <svg viewBox="0 0 16 16" fill="currentColor" style="width: 12px; height: 12px; margin-left: 4px;">
                        <path d="M4.22 6.22a.75.75 0 0 1 1.06 0L8 8.94l2.72-2.72a.75.75 0 1 1 1.06 1.06l-3.25 3.25a.75.75 0 0 1-1.06 0L4.22 7.28a.75.75 0 0 1 0-1.06Z"/>
                    </svg>
                </button>
                <div id="exportMenu" class="export-menu">
                    <button class="export-menu-item" onclick="exportAs('pdf-print')">
                        <strong>Save as PDF</strong>
                        <span style="display: block; font-size: 11px; color: #9ca3af; margin-top: 2px;">
                            Print to PDF for manuscripts
                        </span>
                    </button>
                    <button class="export-menu-item" onclick="exportAs('csv')">
                        <strong>Export Data (CSV)</strong>
                        <span style="display: block; font-size: 11px; color: #9ca3af; margin-top: 2px;">
                            Download table data for analysis
                        </span>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="viewer-content" id="componentContent">
            {% if section.type == 'section_callout_dynamic' %}
                <!-- Dynamic section callout - full width treatment -->
                <section class="section-callout section-callout--{{ manifest.page_config.color_theme or 'purple' }}">
                    <div class="section-callout__content">
                        {% if section.title or section.text %}
                        <div class="section-callout__header">
                            {% if section.title %}
                                <h3 class="section-callout__title">{{ section.title }}</h3>
                            {% endif %}
                            {% if section.text %}
                                <p class="section-callout__text">{{ section.text }}</p>
                            {% endif %}
                        </div>
                        {% endif %}
                        {% include 'research/' + page + '/' + section.file %}
                    </div>
                </section>

            {% elif section.type == 'section_callout' %}
                <!-- Regular section callout -->
                <section class="section-callout section-callout--{{ manifest.page_config.color_theme or 'purple' }}">
                    <div class="section-callout__content">
                        {% if section.title or section.text %}
                        <div class="section-callout__header">
                            {% if section.title %}
                                <h3 class="section-callout__title">{{ section.title }}</h3>
                            {% endif %}
                            {% if section.text %}
                                <p class="section-callout__text">{{ section.text }}</p>
                            {% endif %}
                        </div>
                        {% endif %}
                        {% include 'research/' + page + '/' + section.file %}
                    </div>
                </section>

            {% elif section.type == 'callout_inline' %}
                <!-- Inline callout -->
                <div class="callout-container">
                    {% set callout_content %}
                        {% include 'research/' + page + '/' + section.file %}
                    {% endset %}
                    {% with type=section.callout_type or 'default', header=section.header, content=callout_content, compact=section.compact, in_viewer=true %}
                        {% include 'partials/callout_box_wrapper.html' %}
                    {% endwith %}
                </div>

            {% elif section.type == 'article' %}
                <!-- Article content -->
                <article class="article-container">
                    <div class="article-content">
                        {% if section.title %}
                            <h2 class="main-section-title">{{ section.title }}</h2>
                        {% endif %}
                        <div class="article-text">
                            {% include 'research/' + page + '/' + section.file %}
                        </div>
                    </div>
                </article>

            {% elif section.type == 'article_content' %}
                <!-- Article content continuation -->
                <div class="article-text">
                    {% include 'research/' + page + '/' + section.file %}
                </div>

            {% elif section.type == 'hero' %}
                <!-- Hero section -->
                {% include 'research/' + page + '/' + section.file %}

            {% else %}
                <!-- Raw include for unknown types -->
                <div style="padding: 24px;">
                    <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                        <strong>⚠️ Unknown Component Type:</strong> <code>{{ section.type }}</code>
                        <p style="margin: 8px 0 0 0;">This component type may not display correctly in the viewer.</p>
                    </div>
                    {% include 'research/' + page + '/' + section.file %}
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Navigation -->
    <div class="viewer-navigation">
        <a href="{{ url_for('components_index') }}" class="viewer-nav-link secondary">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M7.78 12.53a.75.75 0 0 1-1.06 0L2.47 8.28a.75.75 0 0 1 0-1.06l4.25-4.25a.75.75 0 0 1 1.06 1.06L4.81 7h7.44a.75.75 0 0 1 0 1.5H4.81l2.97 2.97a.75.75 0 0 1 0 1.06Z"/>
            </svg>
            Back to Components
        </a>
        <a href="/{{ page }}" class="viewer-nav-link">
            View Full Page
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M8.22 2.97a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.75.75 0 0 1-1.06-1.06l2.97-2.97H3.75a.75.75 0 0 1 0-1.5h7.44L8.22 4.03a.75.75 0 0 1 0-1.06Z"/>
            </svg>
        </a>
    </div>
</div>

<!-- Export functionality -->
<script>
// Toggle export menu
function toggleExportMenu(event) {
    event.stopPropagation();
    const menu = document.getElementById('exportMenu');
    menu.classList.toggle('show');
}

// Close menu when clicking outside
document.addEventListener('click', function(event) {
    const menu = document.getElementById('exportMenu');
    const dropdown = document.querySelector('.export-dropdown');
    if (!dropdown.contains(event.target)) {
        menu.classList.remove('show');
    }
});

// Main export function
async function exportAs(format) {
    const menu = document.getElementById('exportMenu');
    menu.classList.remove('show');
    
    const componentElement = document.getElementById('componentContent');
    const sectionId = '{{ section.id }}';
    const pageName = '{{ page }}';
    
    // Show loading state
    const btn = document.querySelector('.export-btn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="animation: spin 1s linear infinite;"><path d="M8 1.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13zM0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8z"/></svg> Processing...';
    btn.disabled = true;
    
    try {
        switch(format) {
            case 'pdf-print':
                // Use browser print dialog for exact representation
                const visualExporter = new VisualExporter();
                visualExporter.exportViaprint(componentElement);
                break;
                
            case 'csv':
                // Export data as CSV
                const dataExporter = new DataExporter();
                const filename = `${pageName}-${sectionId}-data.csv`;
                dataExporter.exportAsCSV(componentElement, filename);
                break;
                
            default:
                console.warn('Unknown export format:', format);
        }
        
    } catch (error) {
        console.error('Export error:', error);
        alert('Export failed. Please try again.');
    } finally {
        // Restore button
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }, 500);
    }
}

// Original SVG export function (simplified)
async function exportComponentAsSVG() {
    // Use pure SVG exporter for true vector graphics
    const pureExporter = new PureSVGExporter();
    const exporter = new SVGExporter(); // Keep for phenotype cards
    const componentElement = document.getElementById('componentContent');
    const sectionId = '{{ section.id }}';
    const sectionType = '{{ section.type }}';
    const pageName = '{{ page }}';
    
    try {
        let svgString;
        const componentType = exporter.detectComponentType(componentElement);
        
        // Choose export method based on component type
        // Use pure SVG for all exports to ensure Illustrator compatibility
        switch(componentType) {
            case 'phenotype-cards':
                // Phenotype cards already use pure SVG
                svgString = exporter.exportPhenotypesAsSVG(componentElement);
                break;
                
            case 'section-callout':
            case 'callout-inline':
            case 'data-table':
                // Use pure SVG export for true vector graphics
                svgString = pureExporter.exportAsPureSVG(componentElement, componentType);
                break;
                
            case 'canvas-visualization':
                // For canvas elements, try to export the canvas directly
                const canvas = componentElement.querySelector('canvas');
                if (canvas) {
                    // Convert canvas to SVG (basic implementation)
                    const dataURL = canvas.toDataURL('image/png');
                    const width = canvas.width;
                    const height = canvas.height;
                    svgString = `<svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}">
                        <image href="${dataURL}" width="${width}" height="${height}"/>
                    </svg>`;
                } else {
                    // Fallback to general export
                    svgString = await exporter.exportToSVG(componentElement);
                }
                break;
                
            default:
                // Use pure SVG for generic components
                svgString = pureExporter.exportAsPureSVG(componentElement, 'generic');
        }
        
        // Download the SVG
        const filename = `${pageName}-${sectionId}-export.svg`;
        exporter.downloadSVG(svgString, filename);
        
        console.log(`Exported ${componentType} component as SVG`);
        
    } catch (error) {
        console.error('Error exporting component:', error);
        alert('Error exporting component. Please try again.');
    }
}

// Alternative export with html2canvas (if available)
async function exportAsPNG() {
    if (typeof html2canvas === 'undefined') {
        alert('PNG export requires html2canvas library. Using SVG export instead.');
        exportComponent();
        return;
    }
    
    const componentElement = document.getElementById('componentContent');
    const canvas = await html2canvas(componentElement, {
        backgroundColor: '#ffffff',
        scale: 2
    });
    
    // Convert to blob and download
    canvas.toBlob(function(blob) {
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `{{ page }}-{{ section.id }}-export.png`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    });
}
</script>

<!-- Include necessary JavaScript for dynamic components -->
{% if section.type in ['section_callout_dynamic', 'callout_inline'] %}
<script>
// Initialize dynamic components when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('Component Viewer: Initializing dynamic component...');

    // Small delay to ensure scripts are loaded
    setTimeout(function() {
        // Trigger initialization functions that components might use
        if (typeof initModelAccuracy === 'function' && '{{ section.id }}' === 'model_accuracy') {
            console.log('Component Viewer: Initializing model accuracy component');
            initModelAccuracy();
        }

        // Add more component initializations as needed
        if (typeof initPhenotypeContent === 'function' && '{{ section.id }}' === 'model_predictions') {
            initPhenotypeContent();
        }

        if (typeof initPhenotypeDistributions === 'function' && '{{ section.id }}' === 'prediction_distributions') {
            initPhenotypeDistributions();
        }
    }, 500);
});
</script>
{% endif %}
{% endblock %}
