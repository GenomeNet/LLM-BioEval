{% extends "admin_base.html" %}

{% block title %}{{ section.id }} - Debug Viewer{% endblock %}

{% block extra_head %}
<!-- Include component styles -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/article_styles.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/component_styles.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/research/' + page + '/page_specific.css') }}">

<style>
/* Debug viewer specific styles */
.debug-container {
    padding: 20px;
    min-height: 100vh;
    background: #f8f9fa;
}

.debug-header {
    background: white;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.debug-title {
    font-size: 28px;
    font-weight: 700;
    color: #1f2937;
    margin: 0 0 8px 0;
}

.debug-meta {
    display: flex;
    gap: 16px;
    color: #6b7280;
    font-size: 14px;
}

.debug-badge {
    background: #e5e7eb;
    color: #374151;
    padding: 4px 12px;
    border-radius: 6px;
    font-weight: 500;
    font-size: 12px;
}

.debug-panel {
    background: white;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.debug-panel h2 {
    margin-top: 0;
    color: #1f2937;
    font-size: 20px;
    font-weight: 600;
}

.debug-content-wrapper {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    overflow: hidden;
    position: relative;
}

.debug-content {
    padding: 0;
    margin: 0;
}

/* Debug boundary styles */
.debug-boundary {
    position: relative;
    background: repeating-linear-gradient(
        45deg,
        rgba(239, 68, 68, 0.1),
        rgba(239, 68, 68, 0.1) 10px,
        transparent 10px,
        transparent 20px
    );
    padding: 20px;
    margin: 0;
    overflow: visible !important;
}

.debug-boundary::before,
.debug-boundary::after {
    content: '';
    position: absolute;
    background: rgba(239, 68, 68, 0.3);
    pointer-events: none;
}

.debug-boundary::before {
    top: 0;
    left: 0;
    right: 0;
    height: 20px;
    border-bottom: 2px solid rgba(239, 68, 68, 0.5);
}

.debug-boundary::after {
    bottom: 0;
    left: 0;
    right: 0;
    height: 20px;
    border-top: 2px solid rgba(239, 68, 68, 0.5);
}

/* Side boundaries */
.debug-boundary .boundary-left,
.debug-boundary .boundary-right {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 20px;
    background: rgba(239, 68, 68, 0.3);
    pointer-events: none;
}

.debug-boundary .boundary-left {
    left: 0;
    border-right: 2px solid rgba(239, 68, 68, 0.5);
}

.debug-boundary .boundary-right {
    right: 0;
    border-left: 2px solid rgba(239, 68, 68, 0.5);
}

.debug-component-label {
    position: absolute;
    top: -12px;
    left: 20px;
    background: white;
    padding: 0 8px;
    font-size: 12px;
    font-weight: 600;
    color: #ef4444;
    text-transform: uppercase;
    z-index: 10;
}

/* Ensure section callout components display properly in debug viewer */
.debug-content .section-callout {
    margin: 0;
    border-radius: 0;
    border: none;
}

.debug-content .section-callout__content {
    padding: 32px;
    max-width: none;
}

/* Fix for dynamic components */
.debug-content .model-accuracy-container {
    margin: 0;
    padding: 0;
    min-height: 400px;
}

/* Navigation styles */
.debug-navigation {
    margin-top: 24px;
    text-align: center;
    padding: 20px;
}

.debug-nav-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    background: #6366f1;
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.2s;
    margin: 0 8px;
}

.debug-nav-link:hover {
    background: #5048e5;
    transform: translateY(-1px);
}

.debug-nav-link.secondary {
    background: #6b7280;
}

.debug-nav-link.secondary:hover {
    background: #4b5563;
}

.debug-nav-link.debug {
    background: #059669;
}

.debug-nav-link.debug:hover {
    background: #047857;
}

/* Ensure interactive elements work */
.debug-content button,
.debug-content select,
.debug-content input {
    cursor: pointer;
}

/* Fix loading overlays in debug context */
.debug-content .loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    z-index: 1000;
}

/* Ensure tables are responsive in debug viewer */
.debug-content .accuracy-table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

@media (max-width: 768px) {
    .debug-container {
        padding: 12px;
    }

    .debug-navigation {
        padding: 12px;
    }

    .debug-nav-link {
        padding: 10px 16px;
        font-size: 14px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="debug-container">
    <!-- Header -->
    <div class="debug-header">
        <h1 class="debug-title">{{ section.id | replace('_', ' ') | title }} - Debug View</h1>
        <div class="debug-meta">
            <span class="debug-badge">{{ section.type | replace('_', ' ') | title }}</span>
            <span>Page: {{ page | replace('_', ' ') | title }}</span>
            {% if section.file %}
            <span>File: {{ section.file }}</span>
            {% endif %}
            {% if manifest.page_config.color_theme %}
            <span>Theme: {{ manifest.page_config.color_theme }}</span>
            {% endif %}
        </div>
    </div>

    <!-- Debug Information Panel -->
    <div class="debug-panel">
        <h2>Debug Information</h2>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <h3 style="color: #6b7280; margin-bottom: 10px;">Section Properties</h3>
                <table style="width: 100%; border-collapse: collapse;">
                    <tr><td style="padding: 4px 8px; border: 1px solid #d1d5db; background: #f9fafb;"><strong>ID:</strong></td><td style="padding: 4px 8px; border: 1px solid #d1d5db;">{{ section.id }}</td></tr>
                    <tr><td style="padding: 4px 8px; border: 1px solid #d1d5db; background: #f9fafb;"><strong>Type:</strong></td><td style="padding: 4px 8px; border: 1px solid #d1d5db;">{{ section.type }}</td></tr>
                    <tr><td style="padding: 4px 8px; border: 1px solid #d1d5db; background: #f9fafb;"><strong>File:</strong></td><td style="padding: 4px 8px; border: 1px solid #d1d5db;">{{ section.file or 'N/A' }}</td></tr>
                    {% if section.title %}<tr><td style="padding: 4px 8px; border: 1px solid #d1d5db; background: #f9fafb;"><strong>Title:</strong></td><td style="padding: 4px 8px; border: 1px solid #d1d5db;">{{ section.title }}</td></tr>{% endif %}
                    {% if section.text %}<tr><td style="padding: 4px 8px; border: 1px solid #d1d5db; background: #f9fafb;"><strong>Text:</strong></td><td style="padding: 4px 8px; border: 1px solid #d1d5db;">{{ section.text }}</td></tr>{% endif %}
                </table>
            </div>

            <div>
                <h3 style="color: #6b7280; margin-bottom: 10px;">Page Information</h3>
                <table style="width: 100%; border-collapse: collapse;">
                    <tr><td style="padding: 4px 8px; border: 1px solid #d1d5db; background: #f9fafb;"><strong>Page:</strong></td><td style="padding: 4px 8px; border: 1px solid #d1d5db;">{{ page }}</td></tr>
                    <tr><td style="padding: 4px 8px; border: 1px solid #d1d5db; background: #f9fafb;"><strong>Project:</strong></td><td style="padding: 4px 8px; border: 1px solid #d1d5db;">{{ project.id if project else 'N/A' }}</td></tr>
                    <tr><td style="padding: 4px 8px; border: 1px solid #d1d5db; background: #f9fafb;"><strong>Color Theme:</strong></td><td style="padding: 4px 8px; border: 1px solid #d1d5db;">{{ manifest.page_config.color_theme }}</td></tr>
                </table>
            </div>
        </div>
    </div>

    <!-- Raw Template Source (if available) -->
    {% if section_raw_content %}
    <div class="debug-panel">
        <h2>Raw Template Source</h2>
        <pre style="margin: 0; overflow-x: auto; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 13px; line-height: 1.5; background: #1f2937; color: #f9fafb; padding: 16px; border-radius: 8px;">{{ section_raw_content }}</pre>
    </div>
    {% endif %}

    <!-- Rendered Component with Debug Boundaries -->
    <div class="debug-content-wrapper">
        <div class="debug-content">
            <div class="debug-boundary">
                <span class="debug-component-label">COMPONENT BOUNDARY</span>
                <div class="boundary-left"></div>
                <div class="boundary-right"></div>

                {% if section.type == 'section_callout_dynamic' %}
                    <!-- Dynamic section callout - full width treatment -->
                    <section class="section-callout section-callout--{{ manifest.page_config.color_theme or 'purple' }}">
                        <div class="section-callout__content">
                            {% if section.title or section.text %}
                            <div class="section-callout__header">
                                {% if section.title %}
                                    <h3 class="section-callout__title">{{ section.title }}</h3>
                                {% endif %}
                                {% if section.text %}
                                    <p class="section-callout__text">{{ section.text }}</p>
                                {% endif %}
                            </div>
                            {% endif %}
                            {% include 'research/' + page + '/' + section.file %}
                        </div>
                    </section>

                {% elif section.type == 'section_callout' %}
                    <!-- Regular section callout -->
                    <section class="section-callout section-callout--{{ manifest.page_config.color_theme or 'purple' }}">
                        <div class="section-callout__content">
                            {% if section.title or section.text %}
                            <div class="section-callout__header">
                                {% if section.title %}
                                    <h3 class="section-callout__title">{{ section.title }}</h3>
                                {% endif %}
                                {% if section.text %}
                                    <p class="section-callout__text">{{ section.text }}</p>
                                {% endif %}
                            </div>
                            {% endif %}
                            {% include 'research/' + page + '/' + section.file %}
                        </div>
                    </section>

                {% elif section.type == 'callout_inline' %}
                    <!-- Inline callout -->
                    <div class="callout-container">
                        {% set callout_content %}
                            {% include 'research/' + page + '/' + section.file %}
                        {% endset %}
                        {% with type=section.callout_type or 'default', header=section.header, content=callout_content, compact=section.compact, in_viewer=true %}
                            {% include 'partials/callout_box_wrapper.html' %}
                        {% endwith %}
                    </div>

                {% elif section.type == 'article' %}
                    <!-- Article content -->
                    <article class="article-container">
                        <div class="article-content">
                            {% if section.title %}
                                <h2 class="main-section-title">{{ section.title }}</h2>
                            {% endif %}
                            <div class="article-text">
                                {% include 'research/' + page + '/' + section.file %}
                            </div>
                        </div>
                    </article>

                {% elif section.type == 'article_content' %}
                    <!-- Article content continuation -->
                    <div class="article-text">
                        {% include 'research/' + page + '/' + section.file %}
                    </div>

                {% elif section.type == 'hero' %}
                    <!-- Hero section -->
                    {% include 'research/' + page + '/' + section.file %}

                {% else %}
                    <!-- Raw include for unknown types -->
                    <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 4px; padding: 12px; margin: 10px 0;">
                        <strong>⚠️ Unknown Component Type:</strong> <code>{{ section.type }}</code>
                        <p style="margin: 8px 0 0 0;">This component type may not display correctly in the viewer.</p>
                    </div>
                    {% include 'research/' + page + '/' + section.file %}
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <div class="debug-navigation">
        <a href="{{ url_for('components_index') }}" class="debug-nav-link secondary">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M7.78 12.53a.75.75 0 0 1-1.06 0L2.47 8.28a.75.75 0 0 1 0-1.06l4.25-4.25a.75.75 0 0 1 1.06 1.06L4.81 7h7.44a.75.75 0 0 1 0 1.5H4.81l2.97 2.97a.75.75 0 0 1 0 1.06Z"/>
            </svg>
            Back to Components
        </a>
        <a href="/{{ page }}" class="debug-nav-link">
            View Full Page
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M8.22 2.97a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.75.75 0 0 1-1.06-1.06l2.97-2.97H3.75a.75.75 0 0 1 0-1.5h7.44L8.22 4.03a.75.75 0 0 1 0-1.06Z"/>
            </svg>
        </a>
        <a href="{{ url_for('view_component', page=page, section_id=section.id, simple='true') }}" class="debug-nav-link debug">
            Simple View
        </a>
    </div>
</div>

<!-- Include necessary JavaScript for dynamic components -->
{% if section.type in ['section_callout_dynamic', 'callout_inline'] %}
<script>
// Initialize dynamic components when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('Debug Viewer: Initializing dynamic component...');

    // Small delay to ensure scripts are loaded
    setTimeout(function() {
        // Trigger initialization functions that components might use
        if (typeof initModelAccuracy === 'function' && '{{ section.id }}' === 'model_accuracy') {
            console.log('Debug Viewer: Initializing model accuracy component');
            initModelAccuracy();
        }

        // Add more component initializations as needed
        if (typeof initPhenotypeContent === 'function' && '{{ section.id }}' === 'model_predictions') {
            initPhenotypeContent();
        }

        if (typeof initPhenotypeDistributions === 'function' && '{{ section.id }}' === 'prediction_distributions') {
            initPhenotypeDistributions();
        }
    }, 500);
});
</script>
{% endif %}
{% endblock %}
